---
title: "REFMAP listening test 1 analysis: Regression modelling for annoyance"
output: html_document
date: "2025-02-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

Load packages

```{r}
library(conflicted)
library(MASS)
library(glmtoolbox)
library(lme4)
library(tidyverse)
library(broom)
library(openxlsx)
library(ggeffects)
library(stats)
library(easystats)
library(viridis)
library(ggnewscale)
library(patchwork)
# library(emojifont)
library(microbenchmark)
# set package parameters
theme_set(theme_bw())

lmcontrol <- lme4::lmerControl(optimizer = 'bobyqa',
                               optCtrl = list(maxfun = 1e6))
glmcontrol <- lme4::glmerControl(optimizer = 'bobyqa',
                                 optCtrl = list(maxfun = 1e6))

```

Set parameters

```{r}

# plot colour scheme

mycolourlist = list(c(0, 102, 255), c(0, 204, 153), c(255, 0, 102), c(74, 111, 152), c(251, 164, 49), c(204, 153, 255), c(90, 192, 255), c(80, 245, 233), c(255, 90, 192), c(164, 201, 242), c(255, 254, 139), c(255, 243, 255))
mycolours = matrix()

for (ii in 1:length(mycolourlist)){
  mycolours[ii] = rgb(mycolourlist[[ii]][1]/255,
                      mycolourlist[[ii]][2]/255,
                      mycolourlist[[ii]][3]/255)
}

# toggle to save plots
saveplots = TRUE

if (saveplots){
  # set output plot directory
  choose.files(caption="Just cancel this", filters=matrix(data=c(" ", " "), ncol=2))  # workaround for bug in RTerm choose.dir
  outFigPath <- utils::choose.dir(caption="Select output folder to save plots")
  
  if (!dir.exists(file.path(outFigPath, "svg"))){dir.create(file.path(outFigPath, "svg"))}
  if (!dir.exists(file.path(outFigPath, "pdf"))){dir.create(file.path(outFigPath, "pdf"))}
  
}

# toggle to save data
savedata = TRUE

if (savedata){
  # set output plot directory
  if (saveplots==FALSE){
    choose.files(caption="Just cancel this", filters=matrix(data=c(" ", " "), ncol=2))  # workaround for bug in RTerm choose.dir
  }
  outDataPath <- utils::choose.dir(caption="Select output folder to save data")
}

set.seed(5419498)


```

# Functions

## GEE Rsquared (Zheng, 2000)

```{r}

geeRsquared <- function(...){
  
  if (length(list(...)) == 1){
      
      model_objects <- insight::ellipsis_info(..., ..., only_models = TRUE,
                                              verbose=FALSE)
      model_objects <- model_objects[1]

  } else{

      model_objects <- insight::ellipsis_info(..., only_models = TRUE,
                                              verbose=FALSE)
  
  }
  
  # ensure proper object names
  dot_names <- sapply(match.call(expand.dots = FALSE)[["..."]], as.character)
  check_object_names <- insight::compact_character(names(model_objects))
  if ((is.null(check_object_names) ||
    # or if length of names doesn't match number of models
    length(check_object_names) != length(model_objects) ||
    # or if names are "..1", "..2" pattern
    all(grepl("\\.\\.\\d", check_object_names))) &&
    # and length of dot-names must match length of objects
    length(model_objects) == length(dot_names)) {
    names(model_objects) <- dot_names
  }
  
  object_names <- names(model_objects)
  
  m <- mapply(function(.x, .y) {
    SSE <- sum((.x$y - .x$fitted.values)^2, na.rm = T)
    SST <- sum((.x$y - mean(.x$y, na.rm = T))^2, na.rm = T)
    DFE <- .x$df.residual
    DFT <- length(.x$y) - 1
    r2 = 1 - SSE/SST
    r2a = 1 - (SSE/SST)*(DFT/DFE)
    dat <- data.frame(R2=r2, adjR2=r2a)
    model_name <- gsub("\"", "", insight::safe_deparse(.y), fixed = TRUE)
    perf_df <- data.frame(Name = model_name, Model = class(.x)[1], dat, stringsAsFactors = FALSE)
    perf_df
  }, model_objects, object_names, SIMPLIFY = FALSE)
  
  dfs <- Reduce(function(x, y) merge(x, y, all = TRUE, sort = FALSE), m)

  return(dfs)
}

```

## Predicting from model objects with new data (such as mean values)

```{r}

predictNew <- function(model, response, newData, fixVars=NULL){
  
  # check response variable is the same length as the newData variables
  if (length(response) != nrow(newData)){
    stop("Response variable must be the same length as the new data")
  }

  # get predictor variables from model
  pred <- insight::find_predictors(model, flatten = TRUE)

  # if fixVars is not null
  if (!is.null(fixVars)){
    # check if fixVars is a list or named vector and convert to dataframe if necessary
    if (is.list(fixVars) | is.vector(fixVars)){
      fixVars <- t(as.data.frame(fixVars))
      # remove redundant rowname
      rownames(fixVars) <- NULL
    }
    
    # remove fixed variables from predictors
    pred <- pred[!pred %in% colnames(fixVars)]
  
  }
  
  # assign columns from newData to dat
  dat <- newData[pred]
  
  # if fixVars is not null
  if (!is.null(fixVars)){
    # add fixed variable columns
    dat <- cbind(dat, fixVars)
  }
  
  if (class(model) == "glmgee"){
    # make predictions with new data
    predictions <- predict(model, newdata=dat, type='response', varest='bias-corrected')
  } else {
    # make predictions with new data
    predictions <- predict(model, newdata=dat, type='response')
  }
  # bind predictions to dat
  predictDat <- cbind(dat, response=response, fit=predictions)

  # include rownames
  rownames(predictDat) <- newData$X
  
  # return output
  return(predictDat)
}

```

## Compiling GEE GLM model performance parameters

```{r}

geeModelPerformance <- function(..., verbose=FALSE){
  
  if (length(list(...)) == 1){
      
      model_objects <- insight::ellipsis_info(..., ..., only_models = TRUE,
                                              verbose=FALSE)
      model_objects <- model_objects[1]

  } else{

      model_objects <- insight::ellipsis_info(..., only_models = TRUE,
                                              verbose=FALSE)
  
  }
  
  # ensure proper object names
  dot_names <- sapply(match.call(expand.dots = FALSE)[["..."]], as.character)
  check_object_names <- insight::compact_character(names(model_objects))
  if ((is.null(check_object_names) ||
    # or if length of names doesn't match number of models
    length(check_object_names) != length(model_objects) ||
    # or if names are "..1", "..2" pattern
    all(grepl("\\.\\.\\d", check_object_names))) &&
    # and length of dot-names must match length of objects
    length(model_objects) == length(dot_names)) {
    names(model_objects) <- dot_names
  }
  
  object_names <- names(model_objects)
  
  m <- mapply(function(.x, .y) {
    if (.x$family$link == "identity") {
      r2 <- geeRsquared(.x)
      R2 <- r2$R2
      adjR2 <- r2$adjR2
      D <- NA
      Lloss <- NA
      PCP <- data.frame(pcp_model=NA, model_ci_low=NA, model_ci_high=NA, lrt_chisq=NA)
      
    } else if (.x$family$link == "logit") {
      R2 <- NA
      adjR2 <- NA
      D <- performance::r2_tjur(.x)
      Lloss <- performance::performance_logloss(.x)
      PCP <- performance::performance_pcp(.x)
      
    } else {
      R2 <- NA
      adjR2 <- NA
      D <- NA
      Lloss <- NA
      PCP <- data.frame(pcp_model=NA, model_ci_low=NA, model_ci_high=NA, lrt_chisq=NA)
      
    }
    dat <- data.frame(R2=R2,
                      adjR2=adjR2,
                      D=D,
                      GPAIC=glmtoolbox::AGPC(.x, verbose=FALSE),
                      GPSBIC=glmtoolbox::SGPC(.x, verbose=FALSE),
                      Lloss=Lloss,
                      ePCP=PCP$pcp_model,
                      ePCP95Lo=PCP$model_ci_low,
                      ePCP95Hi=PCP$model_ci_high,
                      ePCPChiSq=PCP$lrt_chisq
                      )
    # omit NA columns
    dat <- Filter(function(x)!all(is.na(x)), dat)
    
    model_name <- gsub("\"", "", insight::safe_deparse(.y), fixed = TRUE)
    perf_df <- data.frame(Name = model_name, Model = class(.x)[1], dat, stringsAsFactors = FALSE)

  }, model_objects, object_names, SIMPLIFY = FALSE)
  
  # merge dataframes
  dfs <- tibble(Reduce(function(x, y) merge(x, y, all = TRUE, sort = FALSE), m))
  
  # add AIC and SBIC weights
  dfs$wGPAIC <- format(round(exp(-0.5*(dfs$GPAIC - min(dfs$GPAIC)))/sum(exp(-0.5*(dfs$GPAIC - min(dfs$GPAIC)))),
                           6),
                     scientific=FALSE, format=f, digits=6)
  dfs$wGPSBIC <- format(round(exp(-0.5*(dfs$GPSBIC - min(dfs$GPSBIC)))/sum(exp(-0.5*(dfs$GPSBIC - min(dfs$GPSBIC)))),
                           6),
                     scientific=FALSE, format=f, digits=6)
  
  # move columns
  dfs <- dfs |> dplyr::relocate(wGPAIC, .after=GPAIC)
  dfs <- dfs |> dplyr::relocate(wGPSBIC, .after=GPSBIC)
  
  # print output if verbose input argument is true
  if (verbose){
    print(dfs)
  }

  return(dfs)
}


```

## (Herron) estimated percentage correct predictions (ePCP) for GLMM models

```{r}

glmmPCP <- function(...){
   if (length(list(...)) == 1){
      
      model_objects <- insight::ellipsis_info(..., ..., only_models = TRUE)
      model_objects <- model_objects[1]

  } else{

      model_objects <- insight::ellipsis_info(..., only_models = TRUE)
  
  }
  
  # ensure proper object names
  dot_names <- sapply(match.call(expand.dots = FALSE)[["..."]], as.character)
  check_object_names <- insight::compact_character(names(model_objects))
  if ((is.null(check_object_names) ||
    # or if length of names doesn't match number of models
    length(check_object_names) != length(model_objects) ||
    # or if names are "..1", "..2" pattern
    all(grepl("\\.\\.\\d", check_object_names))) &&
    # and length of dot-names must match length of objects
    length(model_objects) == length(dot_names)) {
    names(model_objects) <- dot_names
  }
  
  object_names <- names(model_objects)
  
  m <- mapply(function(.x, .y) {
    y_full <- .x@resp$y

    n_full <- suppressWarnings(insight::n_obs(.x))

    pr_full <- stats::predict(.x, type = "response")
    
    pcp_full <- (sum(1 - pr_full[y_full == 0]) + sum(pr_full[y_full == 1])) / n_full
    
    dat <- data.frame(ePCP=pcp_full)
    model_name <- gsub("\"", "", insight::safe_deparse(.y), fixed = TRUE)
    perf_df <- data.frame(Name = model_name, Model = class(.x)[1], dat, stringsAsFactors = FALSE)

  }, model_objects, object_names, SIMPLIFY = FALSE)
  
  dfs <- Reduce(function(x, y) merge(x, y, all = TRUE, sort = FALSE), m)

  return(dfs)

}


```

## Formatting GEE parameters

```{r}

geeParams <- function(geeMod, ci=0.95, exponentiate=FALSE, varest='bias-corrected',
                      round=NULL, verbose=TRUE){
  
  geeModParams <- tidy(geeMod, exponentiate=exponentiate, conf.level=ci, conf.int=TRUE, varest=varest)
  
  geeModParams$S2.value <- -log2(geeModParams$p.value)
  
  geeModParams$Bfb <- 1/(-exp(1)*geeModParams$p.value*log(geeModParams$p.value))
  
  geeModParams$Pp <- geeModParams$Bfb/(1 + geeModParams$Bfb)
  
  if (!is.null(round)){
    
    parOut <- tibble(cbind(geeModParams[, names(geeModParams)=='term'],
                           round(geeModParams[, names(geeModParams)!='term'], round)))

  } else{
    
    parOut <- geeModParams
    
  }
  
  
  if (verbose){
    print(parOut)
  }
  return(parOut)
  
}

```

## Assign nearest numbers from list

```{r}

numberSnap <- function(numbersIn, numberList, rangeVal){
  
  numberList<-sort(numberList)          # need them sorted
  rangeVal <- rangeVal*1.000001                             # avoid rounding issues
  nearest <- findInterval(numbersIn, numberList - rangeVal) # index of nearest
  nearest <- c(-Inf, numberList)[nearest + 1]  # value of nearest
  diff <- numbersIn - nearest                           # compute errors
  snap <- diff <= rangeVal                               # only snap near numbers
  
  numbersOut <- numbersIn
  numbersOut[snap] <- nearest[snap]                      # snap values to nearest
  
  return(numbersOut)
  
}


```

## Rescale ggplot tick marks for variables

```{r}

rescaleTicks <- function(dataVar, dataVarScl, sep=3, ax='x'){
  
  if (ax == 'x'){
    outAx <- scale_x_continuous(breaks=seq(floor(min(dataVar)),
                                           ceiling(max(dataVar)),
                                           by=sep) -
                                  (max(dataVar) - max(dataVarScl)),
                                labels=seq(floor(min(dataVar)),
                                           ceiling(max(dataVar)),
                                           by=sep))

  } else if (ax == 'y'){
    outAx <- scale_y_continuous(breaks=seq(floor(min(dataVar)),
                                           ceiling(max(dataVar)),
                                           by=sep) -
                                  (max(dataVar) - max(dataVarScl)),
                                labels=seq(floor(min(dataVar)),
                                           ceiling(max(dataVar)),
                                           by=sep))
  } else {
    stop("Invalid axis argument")
  }
 
  return(outAx) 
}


```

## Cohen's f2 effect size for GEE models

```{r}

geeCohensf2 <- function(geeMod){
  # loop over each variable in the model, calculate the R2 using geeRsquared
  # function for a reduced formula excluding that variable, and calculate the f2
  # effect size
  
  # first, calculate the R2 for the full model
  R2full <- geeRsquared(geeMod)$rsquare_gee
  
  # # assign variables except intercept
  # vars <- geeMod$coefficients %>%
  #   rownames() %>%
  #   .[!grepl("Intercept", .)]
  # 
  f2 <- sapply(rownames(geeMod$coefficients), function(x) {
    # create a reduced formula
    reduced_formula <- update(geeMod$formula, paste0(". ~ . - ", x))
    # fit the reduced model
    reduced_model <- update(geeMod, formula = reduced_formula)
    # calculate the R2 for the reduced model
    R2reduced <- geeRsquared(reduced_model)$rsquare_gee
    # calculate the f2 effect size
    f2 <- (R2full - R2reduced) / (1 - R2full)

  })
  
  return(f2)
  
}



```

# Import data and wrangle

## Parts A & B combined

```{r}

subjDataPath <- utils::choose.files(caption=r"(Select refmap_listest1_testdata_BySubj.csv from 03 Experiment\Experiment 1\Analysis\PostProcess)",
                                     filters=matrix(data=c("refmap_listest1_testdata_BySubj.csv", "refmap_listest1_testdata_BySubj.csv"), ncol=2))

subjData <- read.csv(subjDataPath, header=TRUE)

stimDataPath <- utils::choose.files(caption=r"(Select refmap_listest1_testdata_ByStim.csv from 03 Experiment\Experiment 1\Analysis\PostProcess)",
                                     filters=matrix(data=c("refmap_listest1_testdata_ByStim.csv", "refmap_listest1_testdata_ByStim.csv"), ncol=2))

stimData <- read.csv(stimDataPath, header=TRUE)

```

```{r}
# definition of ordinal variable levels
UASLAeqCatsA <- c("No UAS", "42", "48", "54", "60")
SNRCatsA <- c("No UAS", "-16", "-10", "-4", "2", "8")
UASOpCatsA <- c("No UAS", "Flyover", "Landing", "Takeoff")
UASTypeCatsA <- c("No UAS", "H520", "M300", "T150")

# encode factors
subjData$ID. <- factor(subjData$ID.)
subjData$UASLAeq <- factor(subjData$UASLAeq, levels=UASLAeqCatsA, order=TRUE)
subjData$SNRlevel <- factor(subjData$SNRlevel, levels=SNRCatsA, order=TRUE)
subjData$UASOperation <- factor(subjData$UASOperation, levels=UASOpCatsA)
subjData$UASType <- factor(subjData$UASType, levels=UASTypeCatsA)
subjData$AmbientEnv <- factor(subjData$AmbientEnv, levels=c("Park", "Street"))
subjData$AAM_attitude <- factor(subjData$AAM_attitude)
subjData$Home_Area <- factor(subjData$Home_Area)
subjData$Area_soundscape <- factor(subjData$Area_soundscape)
subjData$NationGeo <- factor(subjData$NationGeo)

# recode AAM_attitude to 3 groups
subjData <- subjData |> dplyr::mutate(AAM_attitude3 = case_match(AAM_attitude,
                                                                    "Supportive" ~ "Supportive",
                                                                    c("Ambivalent",
                                                                      "Concerned") ~ "Ambiv_Concern",
                                                                      "Neutral" ~ "Neutral"))
subjData$AAM_attitude3 <- factor(subjData$AAM_attitude3)

# recode AAM_attitude to 2 groups
subjData <- subjData |> dplyr::mutate(AAM_attitude2 = case_match(AAM_attitude,
                                                                    "Supportive" ~ "Supportive",
                                                                    c("Ambivalent",
                                                                      "Concerned",
                                                                      "Neutral") ~ "Ambiv_Concern_Neutral"))
subjData$AAM_attitude2 <- factor(subjData$AAM_attitude2)

# recode AAM_attitude to 2 other groups
subjData <- subjData |> dplyr::mutate(AAM_attitude2_2 = case_match(AAM_attitude,
                                                                    c("Supportive",
                                                                      "Ambivalent") ~ "Support_Ambiv",
                                                                    c("Concerned",
                                                                      "Neutral") ~ "Concern_Neutral"))

subjData$AAM_attitude2_2 <- factor(subjData$AAM_attitude2_2)

# recode NationGeo to 4 groups
subjData <- subjData |> dplyr::mutate(NationGeo4 = case_match(NationGeo,
                                                               "UK" ~ "UK",
                                                               c("Africa",
                                                                 "SouthAsia") ~ "Africa_SAsia",
                                                               c("Australasia",
                                                                 "EastAsia",
                                                                 "Europe",
                                                                 "MidEast",
                                                                 "SouthAmerica") ~ "Other",
                                                               "" ~ "Unspecified"))
subjData$NationGeo4 <- factor(subjData$NationGeo4)

# recode NationGeo to 3 groups
subjData <- subjData |> dplyr::mutate(NationGeo3 = case_match(NationGeo,
                                                                 "UK" ~ "UK",
                                                                 c("Africa",
                                                                   "SouthAsia") ~ "Africa_SAsia",
                                                                 c("Australasia",
                                                                   "EastAsia",
                                                                   "Europe",
                                                                   "MidEast",
                                                                   "SouthAmerica",
                                                                   "") ~ "Other"))
subjData$NationGeo3 <- factor(subjData$NationGeo3)

# recode NationGeo to 2 groups
subjData <- subjData |> dplyr::mutate(NationGeo2 = case_match(NationGeo,
                                                                 "UK" ~ "UK",
                                                                 c("Africa",
                                                                   "SouthAsia",
                                                                   "Australasia",
                                                                   "EastAsia",
                                                                   "Europe",
                                                                   "MidEast",
                                                                   "SouthAmerica",
                                                                   "") ~ "Other"))
subjData$NationGeo2 <- factor(subjData$NationGeo2)


subjData$NationGeo3 <- factor(subjData$NationGeo3)

# recode Area of residence to 2 groups
subjData <- subjData |> dplyr::mutate(Home_Area2 = case_match(Home_Area,
                                                         "Urban" ~ "Urban",
                                                         c("Suburban",
                                                           "Rural") ~ "Suburban_Rural"))
subjData$Home_Area2 <- factor(subjData$Home_Area2)


# recode Area soundscape to 2 groups
subjData <- subjData |> dplyr::mutate(Area_soundscape2 = case_match(Area_soundscape,
                                                                       c("Calm",
                                                                         "Monotonous") ~ "Uneventful",
                                                                       c("Chaotic",
                                                                         "Vibrant") ~ "Eventful"))

subjData$Area_soundscape2 <- factor(subjData$Area_soundscape2)

# create column with Part B TrialNumbers continuing from Part A
subjData$TrialNumberCnt <- subjData$TrialNumber
subjData$TrialNumberCnt[subjData$SessionPart == "B"] <- subjData$TrialNumberCnt[subjData$SessionPart == "B"] + 
                                                              max(subjData$TrialNumber[subjData$SessionPart=="A"])

# ensure that participant ID. 17 TrialNumberCnt starts from 61 (as they had done 60 in Part A)
subjData$TrialNumberCnt[subjData$ID. == 17] <- subjData$TrialNumberCnt[subjData$ID. == 17] - 20

# rescale trial number variables separately for each session part
subjData <- rbind(subjData[subjData$SessionPart == "A", ] |> dplyr::mutate(TrialNumberScl = datawizard::standardise(TrialNumber, scale=TRUE)),
                    subjData[subjData$SessionPart == "B", ] |> dplyr::mutate(TrialNumberScl = datawizard::standardise(TrialNumber, scale=TRUE)))
subjData <- subjData |> dplyr::mutate(TrialNumberCntScl = datawizard::standardise(TrialNumberCnt, scale=TRUE))

# relocate new columns
subjData <- subjData |> dplyr::relocate(TrialNumberCnt, TrialNumberScl,
                                        TrialNumberCntScl, .after=TrialNumber)

# rescale variables
subjData <- subjData |> dplyr::mutate(UASLAeqMaxLRScl = datawizard::standardise(UASLAeqMaxLR, scale=FALSE))
subjData <- subjData |> dplyr::mutate(UASLAEMaxLRScl = datawizard::standardise(UASLAEMaxLR, scale=FALSE))
subjData <- subjData |> dplyr::mutate(UASEPNLMaxLRScl = datawizard::standardise(UASEPNLMaxLR, scale=FALSE))
subjData <- subjData |> dplyr::mutate(LAELAF50diffScl = datawizard::standardise(LAELAF50diff, scale=FALSE))
subjData <- subjData |> dplyr::mutate(LAELAeqdiffScl = datawizard::standardise(LAELAeqdiff, scale=FALSE))
subjData <- subjData |> dplyr::mutate(EPNLLAeqdiffScl = datawizard::standardise(EPNLLAeqdiff, scale=FALSE))
subjData <- subjData |> dplyr::mutate(UASDisc0p5LAEMaxLRScl = datawizard::standardise(UASDisc0p5LAEMaxLR, scale=FALSE))
subjData <- subjData |> dplyr::mutate(UASDisc0p5PAEMaxLR = 2e-5*10^(UASDisc0p5LAEMaxLR/20))
subjData <- subjData |> dplyr::mutate(UASLoudECMAPowAvgBinScl = datawizard::standardise(UASLoudECMAPowAvgBin, scale=FALSE))
subjData <- subjData |> dplyr::mutate(IntermitRatioC2MaxLRScl = IntermitRatioC2MaxLR/100)
subjData <- subjData |> dplyr::mutate(IntermitRatioC3MaxLRScl = IntermitRatioC3MaxLR/100)
subjData <- subjData |> dplyr::mutate(IntermitRatioC5MaxLRScl = IntermitRatioC5MaxLR/100)
subjData <- subjData |> dplyr::mutate(AmbLAeqMaxLRScl = datawizard::standardise(AmbLAeqMaxLR, scale=FALSE))
subjData <- subjData |> dplyr::mutate(AmbLAF50ExMaxLRScl = datawizard::standardise(AmbLAF50ExMaxLR, scale=FALSE))


stimData <- stimData |> dplyr::mutate(UASLAeqMaxLRScl = datawizard::standardise(UASLAeqMaxLR, scale=FALSE))
stimData <- stimData |> dplyr::mutate(UASLAEMaxLRScl = datawizard::standardise(UASLAEMaxLR, scale=FALSE))
stimData <- stimData |> dplyr::mutate(UASEPNLMaxLRScl = datawizard::standardise(UASEPNLMaxLR, scale=FALSE))
stimData <- stimData |> dplyr::mutate(LAELAF50diffScl = datawizard::standardise(LAELAF50diff, scale=FALSE))
stimData <- stimData |> dplyr::mutate(LAELAeqdiffScl = datawizard::standardise(LAELAeqdiff, scale=FALSE))
stimData <- stimData |> dplyr::mutate(EPNLLAeqdiffScl = datawizard::standardise(EPNLLAeqdiff, scale=FALSE))
stimData <- stimData |> dplyr::mutate(UASDisc0p5LAEMaxLRScl = datawizard::standardise(UASDisc0p5LAEMaxLR, scale=FALSE))
stimData <- stimData |> dplyr::mutate(UASDisc0p5PAEMaxLR = 2e-5*10^(UASDisc0p5LAEMaxLR/20))
stimData <- stimData |> dplyr::mutate(UASLoudECMAPowAvgBinScl = datawizard::standardise(UASLoudECMAPowAvgBin, scale=FALSE))
stimData <- stimData |> dplyr::mutate(IntermitRatioC2MaxLRScl = IntermitRatioC2MaxLR/100)
stimData <- stimData |> dplyr::mutate(IntermitRatioC3MaxLRScl = IntermitRatioC3MaxLR/100)
stimData <- stimData |> dplyr::mutate(IntermitRatioC5MaxLRScl = IntermitRatioC5MaxLR/100)
stimData <- stimData |> dplyr::mutate(AmbLAeqMaxLRScl = datawizard::standardise(AmbLAeqMaxLR, scale=FALSE))
stimData <- stimData |> dplyr::mutate(AmbLAF50ExMaxLRScl = datawizard::standardise(AmbLAF50ExMaxLR, scale=FALSE))


# convert detectability dB to log variables
subjData <- subjData |> dplyr::mutate(Detect0p1IntMaxLRLog = Detect0p1dBIntMaxLR/10)
subjData <- subjData |> dplyr::mutate(Detect0p5IntMaxLRLog = Detect0p5dBIntMaxLR/10)
subjData <- subjData |> dplyr::mutate(Detect0p1MaxMaxLRLog = Detect0p1dBMaxMaxLR/10)
subjData <- subjData |> dplyr::mutate(Detect0p5MaxMaxLRLog = Detect0p5dBMaxMaxLR/10)
subjData <- subjData |> dplyr::mutate(Detect0p1IntMaxLRLogScl = datawizard::standardise(Detect0p1IntMaxLRLog, scale=FALSE))
subjData <- subjData |> dplyr::mutate(Detect0p5IntMaxLRLogScl = datawizard::standardise(Detect0p5IntMaxLRLog, scale=FALSE))
subjData <- subjData |> dplyr::mutate(Detect0p1MaxMaxLRLogScl = datawizard::standardise(Detect0p1MaxMaxLRLog, scale=FALSE))
subjData <- subjData |> dplyr::mutate(Detect0p5MaxMaxLRLogScl = datawizard::standardise(Detect0p5MaxMaxLRLog, scale=FALSE))

stimData <- stimData |> dplyr::mutate(Detect0p1IntMaxLRLog = Detect0p1dBIntMaxLR/10)
stimData <- stimData |> dplyr::mutate(Detect0p5IntMaxLRLog = Detect0p5dBIntMaxLR/10)
stimData <- stimData |> dplyr::mutate(Detect0p1MaxMaxLRLog = Detect0p1dBMaxMaxLR/10)
stimData <- stimData |> dplyr::mutate(Detect0p5MaxMaxLRLog = Detect0p5dBMaxMaxLR/10)
stimData <- stimData |> dplyr::mutate(Detect0p1IntMaxLRLogScl = datawizard::standardise(Detect0p1IntMaxLRLog, scale=FALSE))
stimData <- stimData |> dplyr::mutate(Detect0p5IntMaxLRLogScl = datawizard::standardise(Detect0p5IntMaxLRLog, scale=FALSE))
stimData <- stimData |> dplyr::mutate(Detect0p1MaxMaxLRLogScl = datawizard::standardise(Detect0p1MaxMaxLRLog, scale=FALSE))
stimData <- stimData |> dplyr::mutate(Detect0p5MaxMaxLRLogScl = datawizard::standardise(Detect0p5MaxMaxLRLog, scale=FALSE))

# Log other variables
subjData$PartLoudMGLT05ExLog <- log(subjData$PartLoudMGLT05Ex)
subjData$PartLoudMGST05ExLog <- log(subjData$PartLoudMGST05Ex)
subjData$PartLoudMGLTPowAvgLog <- log(subjData$PartLoudMGLTPowAvg)
subjData$PartLoudMGSTPowAvgLog <- log(subjData$PartLoudMGSTPowAvg)

stimData$PartLoudMGLT05ExLog <- log(stimData$PartLoudMGLT05Ex)
stimData$PartLoudMGST05ExLog <- log(stimData$PartLoudMGST05Ex)
stimData$PartLoudMGLTPowAvgLog <- log(stimData$PartLoudMGLTPowAvg)
stimData$PartLoudMGSTPowAvgLog <- log(stimData$PartLoudMGSTPowAvg)

# reorder by participant ID and trial number
subjData <- subjData[with(subjData, order(ID., TrialNumberCnt)), ]

# omit ambient-only stimuli
subjDataNoAmb <- subjData |> dplyr::filter(UASLAeq != "No UAS")
stimDataNoAmb <- stimData |> dplyr::filter(UASLAeq != "No UAS")

# re-encode factors omitting ambient-only stimuli
subjDataNoAmb$SNRlevel <- factor(subjDataNoAmb$SNRlevel, levels=SNRCatsA[2:length(SNRCatsA)], order=TRUE)
subjDataNoAmb$UASOperation <- factor(subjDataNoAmb$UASOperation, levels=UASOpCatsA[2: length(UASOpCatsA)])
subjDataNoAmb$UASType <- factor(subjDataNoAmb$UASType, levels=UASTypeCatsA[2:length(UASTypeCatsA)])
stimDataNoAmb$SNRlevel <- factor(stimDataNoAmb$SNRlevel, levels=SNRCatsA[2:length(SNRCatsA)], order=TRUE)
stimDataNoAmb$UASOperation <- factor(stimDataNoAmb$UASOperation, levels=UASOpCatsA[2: length(UASOpCatsA)])
stimDataNoAmb$UASType <- factor(stimDataNoAmb$UASType, levels=UASTypeCatsA[2:length(UASTypeCatsA)])

```

# Add external data

## Aalmoes (NLR) HA curves

```{r}

paramKNLR <- c(0.168, 0.152, 0.138, 0.158, 0.189, 0.148, 0.116, 0.085)
paramX0LAENLR <- c(82.2, 78.9, 77.4, 81.8, 81.0, 83.8, 92.2, 93.4)

rangeLAENLR <- seq(50, 90, by=1)

pHALAENLRFunc <- function(paramK, paramX0, abscissa){
  pHA <- 1/(1 + exp(-paramK*(abscissa - paramX0)))
  return(pHA)
} 

pHALAENLR <- data.frame(LAE = rangeLAENLR,
                        LAEScl = rangeLAENLR - (max(stimDataNoAmb$UASLAEMaxLR) - max(stimDataNoAmb$UASLAEMaxLRScl)),
                        Quad1=pHALAENLRFunc(paramKNLR[1], paramX0LAENLR[1], rangeLAENLR),
                        Quad2=pHALAENLRFunc(paramKNLR[2], paramX0LAENLR[2], rangeLAENLR),
                        Quad3=pHALAENLRFunc(paramKNLR[3], paramX0LAENLR[3], rangeLAENLR),
                        Quad4=pHALAENLRFunc(paramKNLR[4], paramX0LAENLR[4], rangeLAENLR))

pHALAENLR <- pHALAENLR |> tidyr::pivot_longer(cols=c(Quad1, Quad2, Quad3, Quad4), names_to="UAS", values_to="pHA")

```

## Kawai (EMPA) HA curves

```{r}

paramb0EMPA <- c(-11.06)
paramb1LAEEMPA<- c(0.17)
paramtauSrcEMPA <- c(-0.9)

rangeLAEEMPA <- seq(53, 80, by=1)

pHALAEEMPAFunc <- function(paramb0, paramb1, paramtau, abscissa){
  pHA <- 1/(1 + exp(-(paramb0 + paramb1*abscissa + paramtau)))
  return(pHA)
} 

pHALAEEMPA <- data.frame(LAE = rangeLAEEMPA,
                         LAEScl = rangeLAEEMPA - (max(stimDataNoAmb$UASLAEMaxLR) - max(stimDataNoAmb$UASLAEMaxLRScl)),
                        Mav2=pHALAEEMPAFunc(paramb0EMPA[1], paramb1LAEEMPA[1],
                                            0, rangeLAEEMPA),
                        M300=pHALAEEMPAFunc(paramb0EMPA[1], paramb1LAEEMPA[1],
                                            paramtauSrcEMPA[1], rangeLAEEMPA))

pHALAEEMPA <- pHALAEEMPA |> tidyr::pivot_longer(cols=c(Mav2, M300), names_to="UAS", values_to="pHA")

```

## Gwak HA curves

```{r}

paramkGwak <- c(0.17, 0.178, 0.165)
param0LAeqGwak <- c(13.512, 13.47, 12.184)/paramkGwak

param0LAEGwak <- param0LAeqGwak + 10*log10(7)

rangeLAeqGwak <- seq(40, 85, by=1)
rangeLAEGwak <- rangeLAeqGwak + 10*log10(7)

pHALAEGwakFunc <- function(paramb0, paramk, abscissa){
  pHA <- 1/(1 + exp(-paramk*(abscissa - paramb0)))
  return(pHA)
}

pHALAEGwak <- data.frame(LAE = rangeLAEGwak,
                         LAEScl = rangeLAEGwak - (max(stimDataNoAmb$UASLAEMaxLR) - max(stimDataNoAmb$UASLAEMaxLRScl)),
                        H12W=pHALAEGwakFunc(param0LAEGwak[1], paramkGwak[1],
                                             rangeLAEGwak),
                        F450=pHALAEGwakFunc(param0LAEGwak[2], paramkGwak[2],
                                            rangeLAEGwak),
                        S1000=pHALAEGwakFunc(param0LAEGwak[3], paramkGwak[3],
                                            rangeLAEGwak))

pHALAEGwak <- pHALAEGwak |> tidyr::pivot_longer(cols=c(H12W, F450, S1000), names_to="UAS", values_to="pHA")

```

## Jeong HA curves

```{r}

paramkJeong <- 0.2753
param0LAeqJeong <- 19.817/paramkJeong

param0LAEJeong <- param0LAeqJeong + 10*log10(5)

rangeLAeqJeong <- seq(40, 80, by=1)
rangeLAEJeong <- rangeLAeqJeong + 10*log10(5)

pHALAEJeongFunc <- function(paramb0, paramk, abscissa){
  pHA <- 1/(1 + exp(-paramk*(abscissa - paramb0)))
  return(pHA)
}

pHALAEJeong <- data.frame(LAE = rangeLAEJeong,
                         LAEScl = rangeLAEJeong - (max(stimDataNoAmb$UASLAEMaxLR) - max(stimDataNoAmb$UASLAEMaxLRScl)),
                         Motor_prop=pHALAEJeongFunc(param0LAEJeong, paramkJeong,
                                                    rangeLAEJeong))

pHALAEJeong <- pHALAEJeong |> tidyr::pivot_longer(cols=c(Motor_prop), names_to="UAS", values_to="pHA")

```

# Change in mean annoyance rating - Parts A & B combined analysis

## Categorical variables

### fit and examine model

```{r}

model1 <- mABLAExTypeOpxLAExEnv1_QxLAESq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl*I(UASEvents^-1) +
                                                                  UASLAEMaxLRScl*UASType +
                                                                  UASLAEMaxLRScl*UASOperation +
                                                                  UASLAEMaxLRScl*AmbientEnv +
                                                                  TrialNumberCntScl,
                                                                  data=subjDataNoAmb,
                                                                  family=gaussian(link='identity'),
                                                                  id=ID.,
                                                                  corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE)


predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=16),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-2, 10, by=1), limits=c(-1, 9)) +
  scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-1, 9)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")

# fit log events model for comparison

model1lgQ <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl*I(log10(UASEvents)) +
                                UASLAEMaxLRScl*UASType +
                                UASLAEMaxLRScl*UASOperation +
                                UASLAEMaxLRScl*AmbientEnv +
                                TrialNumberCntScl,
                                data=subjDataNoAmb,
                                family=gaussian(link='identity'),
                                id=ID.,
                                corstr='exchangeable')


model1predictTypePk <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "UASEvents [1]",
                                                                 "AmbientEnv [Park]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                               vcov=vcov(model1, type="bias-corrected"))

model1predictOpPk <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASOperation [all]",
                                                                 "UASEvents [1]",
                                                                 "AmbientEnv [Park]"),
                                                margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictType <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictOp <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                               "UASOperation [all]",
                                                               "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                                margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnv <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "AmbientEnv [all]",
                                                                "UASEvents [1]"),
                                                margin='marginalmeans',
                                                type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]",
                                                                "AmbientEnv [Park]",
                                                                "UASOperation [Flyover]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEvt2 <- ggeffects::predict_response(model1, terms=c("UASEvents [all]",
                                                                 "UASLAEMaxLRScl [7, 13]",
                                                                 "AmbientEnv [Park]",
                                                                 "UASOperation [Flyover]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEvt2lg <- ggeffects::predict_response(model1lgQ, terms=c("UASEvents [all]",
                                                                   "UASLAEMaxLRScl [7, 13]",
                                                                   "AmbientEnv [Park]",
                                                                   "UASOperation [Flyover]"),
                                               margin='marginalmeans', type='fixed', 
                                              vcov=vcov(model1lgQ, type="bias-corrected"))

model1predictType$AmbientEnv <- model1predictType$facet
model1predictOp$AmbientEnv <- model1predictOp$facet


p1 <- ggplot(data=model1predictType) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=UASType, shape=UASType),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE),
                     fill=guide_legend(title="UAS type", reverse=FALSE),
                     shape=guide_legend(title="UAS type", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance") +
              facet_grid(rows = vars(AmbientEnv))

p2 <- ggplot(data=model1predictOp) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=UASOperation, shape=UASOperation),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='mako', discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='mako', discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(9, 6, 2)) +
              
              guides(colour=guide_legend(title="UAS operation", reverse=TRUE),
                     fill=guide_legend(title="UAS operation", reverse=TRUE),
                     shape=guide_legend(title="UAS operation", reverse=TRUE)) +
              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance") +
              facet_grid(rows = vars(AmbientEnv))

p3 <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14),
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=AmbientEnv, shape=AmbientEnv),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_shape_manual(values=c(1, 3)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(y="Mean change in annoyance")


p4 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv=='Park',],
                         aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                             colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

(p1 | p2) + (p3 / p4)

filename <- "PtsABdAnnoyMnCatMod"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=15, height=8,
         path=file.path(outFigPath, "svg"), system_fonts = list('serif'="Times New Roman"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=15, height=8, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}



p5 <- ggplot(data=model1predictEvt2) +
              theme(panel.grid = element_blank(), aspect.ratio=0.8,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[(stimDataNoAmb$AmbientEnv=='Park')
                                            & (stimDataNoAmb$UASOperation=='Flyover')
                                            & (stimDataNoAmb$SessionPart=='B'),],
                         aes(x=UASEvents, y=dAnnoyMean,
                             colour=UASLAEMaxLR, shape=UASType),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='inferno', direction=1, discrete=FALSE, begin = 0.2, end = 0.8,
                                  breaks=c(73, 79)) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE]~","~dB)), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
  
              geom_ribbon(data=model1predictEvt2,
                          aes(x=x, ymin=conf.low, ymax=conf.high, fill=group),
                          alpha=0.05) +
  
              geom_ribbon(data=model1predictEvt2lg,
                          aes(x=x, ymin=conf.low, ymax=conf.high, colour=group),
                          linewidth=0.5, linetype=3, fill=NA, alpha=0.25) +
              
              geom_line(data=model1predictEvt2,
                        aes(x=x, y=predicted, colour=group), linewidth=1, alpha=0.5) +
  
              geom_line(data=model1predictEvt2lg,
                        aes(x=x, y=predicted, colour=group), alpha=0.5,
                        linewidth=1, linetype=3) +
              
              scale_color_viridis(option='inferno', direction=1, discrete=TRUE, begin = 0.2, end = 0.8,
                                   labels=function(x) format(round(as.numeric(x) +
                                                                   floor(mean(subjDataNoAmb$UASLAEMaxLR) -
                                                                         mean(subjDataNoAmb$UASLAEMaxLRScl)),
                                                                   0),
                                                             nsmall = 0)) +
              scale_fill_viridis(option='inferno', direction=1, discrete=TRUE, begin = 0.2, end = 0.8,
                                   labels=function(x) format(round(as.numeric(x) +
                                                                   floor(mean(subjDataNoAmb$UASLAEMaxLR) -
                                                                         mean(subjDataNoAmb$UASLAEMaxLRScl)),
                                                                   0),
                                                             nsmall = 0)) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE]~","~dB)), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(L)[AE]~","~dB)), reverse=TRUE),
                     shape=guide_legend(title="UAS type"), reverse=FALSE) +
            
              scale_x_continuous(breaks=c(1, 3, 5, 9), labels=c(1, 3, 5, 9)) +
              scale_y_continuous(breaks=seq(-2, 10, by=1)) +
              
              labs(x="Number of UAS flyover events", y="Mean change in annoyance")

p5

filename <- "PtsABdAnnoyMnCatModEvtComp"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=4, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=4, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


```

### Model diagnostics

```{r}


mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.resD <- residuals(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE,
                                                     type="deviance", plot.it=TRUE,
                                                     pch=1, col=mycolours[1],identify=10)
mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.resM <- residuals(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE,
                                                     type="mahalanobis", plot.it=TRUE,
                                                     col=mycolours[2], identify=10)
mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.resP <- residuals(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE,
                                                     type="pearson", plot.it=TRUE,
                                                     pch=1, col=mycolours[3], identify=10)

hist(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.resP, breaks=20, main="Pearson residuals")

mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.DfBc <- dfbeta(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE,
                                                  level='clusters', coefs=c('UASLAEMaxLRScl'))
mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.DfBo <- dfbeta(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE,
                                                  level='observations', coefs=c('UASLAEMaxLRScl'))

mABLAExTypeOpxLAExEnv1_QxLAESq.GEE.Cook <- cooks.distance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE,
                                                          plot.it=TRUE)

performance::check_collinearity(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE)
performance::check_heteroskedasticity(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE)

```

### with personal factors

```{r}

model1 <- mABLAExTypeOpxLAExEnv1_QxLAESqNatAtt.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl*I(UASEvents^-1) +
                                                                  UASLAEMaxLRScl*UASType +
                                                                  UASLAEMaxLRScl*UASOperation +
                                                                  UASLAEMaxLRScl*AmbientEnv +
                                                                  TrialNumberCntScl +
                                                                    NationGeo2 + AAM_attitude2,
                                                                data=subjDataNoAmb,
                                                                family=gaussian(link='identity'),
                                                                id=ID.,
                                                                corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABLAExTypeOpxLAExEnv1_QxLAESqNatAtt.GEE)

model1predictTypePk <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "UASEvents [1]",
                                                                 "AmbientEnv [Park]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                               vcov=vcov(model1, type="bias-corrected"))

model1predictOpPk <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                               "UASOperation [all]",
                                                               "UASEvents [1]",
                                                                 "AmbientEnv [Park]"),
                                                margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictType <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictOp <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                               "UASOperation [all]",
                                                               "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                                margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnv <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "AmbientEnv [all]",
                                                                "UASEvents [1]"),
                                                margin='marginalmeans',
                                                type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]",
                                                                "AmbientEnv [Park]",
                                                                "UASOperation [Flyover]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEvt2 <- ggeffects::predict_response(model1, terms=c("UASEvents [all]",
                                                                 "UASLAEMaxLRScl [7, 13]",
                                                                 "AmbientEnv [Park]",
                                                                 "UASOperation [Flyover]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictType$AmbientEnv <- model1predictType$facet
model1predictOp$AmbientEnv <- model1predictOp$facet


model1predictNat <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                   "NationGeo2 [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictAtt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                   "AAM_attitude2 [all]"),
                                             margin='marginalmeans', type='fixed', 
                                             vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictType) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=UASType, shape=UASType),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(9, 6, 2)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE),
                     fill=guide_legend(title="UAS type", reverse=FALSE),
                     shape=guide_legend(title="UAS type", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              #scale_x_continuous(breaks=seq(55, 80, by=5)) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance") +
              facet_grid(rows = vars(AmbientEnv))

p2 <- ggplot(data=model1predictOp) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=UASOperation, shape=UASOperation),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='mako', discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='mako', discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(9, 6, 2)) +
              
              guides(colour=guide_legend(title="UAS operation", reverse=TRUE),
                     fill=guide_legend(title="UAS operation", reverse=TRUE),
                     shape=guide_legend(title="UAS operation", reverse=TRUE)) +
              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance") +
              facet_grid(rows = vars(AmbientEnv))

p3 <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14),
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=AmbientEnv, shape=AmbientEnv),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_shape_manual(values=c(1, 3)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(y="Mean change in annoyance")


p4 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv=='Park',],
                         aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                             colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

(p1 | p2) + (p3 / p4)

p6 <- ggplot(data=model1predictNat) +
              theme(panel.grid = element_blank(),
                    aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              # geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean),
              #            alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title="Nat. region", reverse=FALSE),
                     fill=guide_legend(title="Nat. region", reverse=FALSE)) +
  
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p6

filename <- "PtsABdAnnoyMnNatMod"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=4.5, height=4,
         path=file.path(outFigPath, "svg"), system_fonts = list('serif'="Times New Roman"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=4.5, height=4, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}



p7 <- ggplot(data=model1predictAtt) +
              theme(panel.grid = element_blank(),
                    aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              # geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean),
              #            alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title="AAM attitude", reverse=TRUE),
                     fill=guide_legend(title="AAM attitude", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p7

filename <- "PtsABdAnnoyMnAttMod"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=4,
         path=file.path(outFigPath, "svg"), system_fonts = list('serif'="Times New Roman"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=4, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}




```

## UAS info only

### LAE, events and trial sequence only

```{r}

model1 <- mABLAEx1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl*I(UASEvents^-1) +
                                                      TrialNumberCntScl,
                                                      data=subjDataNoAmb,
                                                      family=gaussian(link='identity'),
                                                      id=ID.,
                                                      corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABLAEx1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  scale_y_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")


model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=factor(UASEvents),
                                                 shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +

              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p1

# save the model
filename = "1A_dA_LAE_noEnv"
saveRDS(model1, file=file.path(outDataPath, paste(filename, ".rds", sep="")))

```

### fit and examine final model

```{r}

model1 <- mABISxTnLAEx1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl*I(UASEvents^-1) +
                                                     UASImpulsSHMAvgMaxLR +
                                                     UASSharpAurISO305ExMaxLR*UASTonLdECMAPowAvgBin +
                                                     TrialNumberCntScl,
                                                    data=subjDataNoAmb,
                                                    family=gaussian(link='identity'),
                                                    id=ID.,
                                                    corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABLAEx1_QSq.GEE,
                    mABISxTnLAEx1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=16),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-2, 10, by=1), limits=c(-1, 9)) +
  scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-1, 9)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")

model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxS <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                               "UASSharpAurISO305ExMaxLR [1.2:2.8, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxTn <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictSxTn <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]",
                                                                 "UASLAEMaxLRScl [8]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p2 <- ggplot(data=model1predictLxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(1.2, 2.8, by=0.4)) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  

              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=UASSharpAurISO305ExMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")


p3 <- ggplot(data=model1predictLxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p4 <- ggplot(data=model1predictSxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance")

p1 + p2 + p3 + p4



```

### Model diagnostics

```{r}

mABISxTnLAEx1_QSq.GEE.resD <- residuals(mABISxTnLAEx1_QSq.GEE,
                                                     type="deviance", plot.it=TRUE,
                                                     pch=1, col=mycolours[1],identify=10)
mABISxTnLAEx1_QSq.GEE.resM <- residuals(mABISxTnLAEx1_QSq.GEE,
                                                     type="mahalanobis", plot.it=TRUE,
                                                     col=mycolours[2], identify=10)
mABISxTnLAEx1_QSq.GEE.resP <- residuals(mABISxTnLAEx1_QSq.GEE,
                                                     type="pearson", plot.it=TRUE,
                                                     pch=1, col=mycolours[3], identify=10)

hist(mABISxTnLAEx1_QSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABISxTnLAEx1_QSq.GEE.resP, breaks=20, main="Pearson residuals")

mABISxTnLAEx1_QSq.GEE.DfBc <- dfbeta(mABISxTnLAEx1_QSq.GEE,
                                                  level='clusters', coefs=c('UASLAEMaxLRScl'))
mABISxTnLAEx1_QSq.GEE.DfBo <- dfbeta(mABISxTnLAEx1_QSq.GEE,
                                                  level='observations', coefs=c('UASLAEMaxLRScl'))

mABISxTnLAEx1_QSq.GEE.Cook <- cooks.distance(mABISxTnLAEx1_QSq.GEE,
                                                          plot.it=TRUE)

performance::check_collinearity(mABISxTnLAEx1_QSq.GEE)
performance::check_heteroskedasticity(mABISxTnLAEx1_QSq.GEE)

```

### omit impulsiveness

```{r}

model1 <- mABSxTnLAEx1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl*I(UASEvents^-1) +
                                                     UASSharpAurISO305ExMaxLR*UASTonLdECMAPowAvgBin +
                                                     TrialNumberCntScl,
                                                    data=subjDataNoAmb,
                                                    family=gaussian(link='identity'),
                                                    id=ID.,
                                                    corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABLAEx1_QSq.GEE,
                    mABISxTnLAEx1_QSq.GEE, mABSxTnLAEx1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=16),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-2, 10, by=1), limits=c(-1, 9)) +
  scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-1, 9)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")

model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxS <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                               "UASSharpAurISO305ExMaxLR [1.2:2.8, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxTn <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictSxTn <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]",
                                                                 "UASLAEMaxLRScl [8]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p2 <- ggplot(data=model1predictLxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(1.2, 2.8, by=0.4)) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  

              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=UASSharpAurISO305ExMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")


p3 <- ggplot(data=model1predictLxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p4 <- ggplot(data=model1predictSxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance")

p1 + p2 + p3 + p4



```

## with env class

### LAE, events, env and trial sequence only

```{r}

model1 <- mABEnvLAEx1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl*I(UASEvents^-1) +
                                                      UASLAEMaxLRScl + AmbientEnv +
                                                      TrialNumberCntScl,
                                                      data=subjDataNoAmb,
                                                      family=gaussian(link='identity'),
                                                      id=ID.,
                                                      corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABEnvLAEx1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  scale_y_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")


model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]",
                                                                "AmbientEnv [Park]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


model1predictEnv <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "AmbientEnv [all]",
                                                                "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv == 'Park',],
                         aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                         colour=factor(UASEvents),
                         shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +

              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p2 <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14),
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=AmbientEnv, shape=AmbientEnv),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_shape_manual(values=c(1, 3)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(y="Mean change in annoyance")

p1 + p2

```

### fit and examine final model

```{r}

model1 <- mABISxTnxEnvLAE1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl + I(UASEvents^-1) +
                                                      UASImpulsSHMAvgMaxLR +
                                                      UASSharpAurISO305ExMaxLR*UASTonLdECMAPowAvgBin +
                                                      AmbientEnv*UASTonLdECMAPowAvgBin +
                                                      TrialNumberCntScl,
                                                      data=subjDataNoAmb,
                                                      family=gaussian(link='identity'),
                                                      id=ID.,
                                                      corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABISxTnLAEx1_QSq.GEE,
                    mABISxTnxEnvLAE1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  scale_y_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")


model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]",
                                                                "AmbientEnv [Park]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnv <- ggeffects::predict_response(model1, terms=c("UASTonLdECMAPowAvgBin [all]",
                                                                "AmbientEnv [all]",
                                                                "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnvS <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                 "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnvSxTn <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                   "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                   "UASLAEMaxLRScl [-11, -5, 1, 6, 7, 12]",
                                                                   "AmbientEnv [all]",
                                                                   "UASEvents [1]"),
                                               margin='marginalmeans', type='fixed', 
                                              vcov=vcov(model1, type="bias-corrected"))

model1predictPkASxTn <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                   "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                   "UASLAEMaxLRScl [-11, -5, 1, 7]",
                                                                   "AmbientEnv [Park]",
                                                                   "UASEvents [1]"),
                                               margin='marginalmeans', type='fixed', 
                                              vcov=vcov(model1, type="bias-corrected"))


model1predictIxL <- ggeffects::predict_response(model1, terms=c("UASImpulsSHMAvgMaxLR [all]",
                                                                "UASLAEMaxLRScl [-11, -5, 1, 7]",
                                                                "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


model1predictIxS <- ggeffects::predict_response(model1, terms=c("UASImpulsSHMAvgMaxLR [all]",
                                                                "UASSharpAurISO305ExMaxLR [1.3:2.8, by=0.5]",
                                                                "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


model1predictIxTn <- ggeffects::predict_response(model1, terms=c("UASImpulsSHMAvgMaxLR [all]",
                                                                "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnvSxTn$UASLAEMaxLRSclRnd <- model1predictEnvSxTn$facet
model1predictEnvSxTn$AmbientEnv <- model1predictEnvSxTn$panel

model1predictPkASxTn$UASLAEMaxLRSclRnd <- model1predictPkASxTn$facet

model1predictIxL$AmbientEnv <- model1predictIxL$facet
model1predictIxS$AmbientEnv <- model1predictIxS$facet
model1predictIxTn$AmbientEnv <- model1predictIxTn$facet

stimDataNoAmbTemp <- stimDataNoAmb
numbersIn <- stimDataNoAmbTemp$UASLAEMaxLRScl
numberList <- c(-11, -5, 1, 6, 7, 12)
stimDataNoAmbTemp$UASLAEMaxLRSclRnd <- factor(numberSnap(numbersIn, numberList, rangeVal=0.9))
facetLabels <- c('-11'="56", '-5'="62", '1'="68", '6'="73", '7'="74", '12'="79")

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv=='Park',], aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p2 <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASTonLdECMAPowAvgBin, y=dAnnoyMean, colour=AmbientEnv, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              scale_x_continuous(breaks=seq(0, 2, by=0.2)) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(T)[italic(N)]^"*",",",~sone[SHM])), y="Mean change in annoyance")


p3 <- ggplot(data=model1predictEnvS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean, colour=AmbientEnv, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              scale_x_continuous(breaks=seq(0, 4, by=0.2)) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance")

p1 + p2 + p3

p4 <- ggplot(data=model1predictEnvSxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.03) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.25, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              ggnewscale::new_scale_color() +
              
              geom_point(data=stimDataNoAmbTemp,
                         aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean,
                             colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.2, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
  
            
              scale_x_continuous(breaks=seq(0, 4, by=0.4),
                                 sec.axis=sec_axis(~ . ,
                                                   name=expression(paste(UAS~italic(L)[AE]~","~dB)),
                                                   breaks = NULL, labels = NULL)) +
              scale_y_continuous(breaks=seq(-3, 10, by=1)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance") +
              facet_grid(AmbientEnv ~ UASLAEMaxLRSclRnd,
                         labeller=labeller(UASLAEMaxLRSclRnd=facetLabels))

p4

p5 <- ggplot(data=model1predictPkASxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.08) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.45, linewidth=1) +

              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.15, end = 0.85,
                                  labels=function(x) format(round(as.numeric(x), 2), nsmall = 2)) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.15, end = 0.85,
                                 labels=function(x) format(round(as.numeric(x), 2), nsmall = 2)) +

              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])),
                                         reverse=TRUE),
                     fill=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])),
                                       reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
              
              geom_point(data=stimDataNoAmbTemp[(stimDataNoAmbTemp$SessionPart == "A")
                                                & (stimDataNoAmbTemp$AmbientEnv == "Park"), ],
                         aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean,
                             colour=UASTonLdECMAPowAvgBin),
                         alpha=0.45, size=2) +
  
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.15, end = 0.85,
                                  labels=function(x) format(round(x, 2), nsmall = 2)) +
  
              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])),
                                         reverse=TRUE)) +
  
            
              scale_x_continuous(breaks=seq(0, 4, by=0.4),
                                 sec.axis=sec_axis(~ . ,
                                                   name=expression(paste(UAS~italic(L)[AE]~","~dB)),
                                                   breaks = NULL, labels = NULL)) +
              scale_y_continuous(breaks=seq(-3, 10, by=1)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance") +
              facet_grid(~ UASLAEMaxLRSclRnd,
                         labeller=labeller(UASLAEMaxLRSclRnd=facetLabels))

p5

filename <- "PtsABdAnnoyMnEnvClsModSxTnPkA"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=11, height=4, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=11, height=4, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}

p6 <- ggplot(data=model1predictIxL) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8,
                                  labels=c("56", "62", "68", "74")) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8,
                                 labels=c("56", "62", "68", "74")) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE],",",~dB)), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(L)[AE],",",~dB)), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb[stimDataNoAmb$SessionPart == "A", ],
                         aes(x=UASImpulsSHMAvgMaxLR, y=dAnnoyMean, colour=UASLAEMaxLRScl),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE,
                                  breaks=c(-11, -5, 1, 7), labels=c("56", "62", "68", "74"), begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE],",",~dB)), reverse=TRUE)) +

              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), y="Mean change in annoyance") +
              
              facet_grid(~AmbientEnv)

p6

p7 <- ggplot(data=model1predictIxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb[stimDataNoAmb$SessionPart == "A", ],
                         aes(x=UASImpulsSHMAvgMaxLR, y=dAnnoyMean, colour=UASSharpAurISO305ExMaxLR),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=c(1.3, 1.8, 2.3, 2.8), labels=c("1.3", "1.8", "2.3", "2.8")) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), reverse=TRUE)) +

              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), y="Mean change in annoyance") +
              
              facet_grid(~AmbientEnv)

p7


p8 <- ggplot(data=model1predictIxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*",",",~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*",",",~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb[stimDataNoAmb$SessionPart == "A", ],
                         aes(x=UASImpulsSHMAvgMaxLR, y=dAnnoyMean, colour=UASTonLdECMAPowAvgBin),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*",",",~sone[SHM])), reverse=TRUE)) +

              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), y="Mean change in annoyance") +
              
              facet_grid(~AmbientEnv)

p8

```

### Model diagnostics

```{r}

mABISxTnxEnvLAE1_QSq.GEE.resD <- residuals(mABISxTnxEnvLAE1_QSq.GEE,
                                                     type="deviance", plot.it=TRUE,
                                                     pch=1, col=mycolours[1],identify=10)
mABISxTnxEnvLAE1_QSq.GEE.resM <- residuals(mABISxTnxEnvLAE1_QSq.GEE,
                                                     type="mahalanobis", plot.it=TRUE,
                                                     col=mycolours[2], identify=10)
mABISxTnxEnvLAE1_QSq.GEE.resP <- residuals(mABISxTnxEnvLAE1_QSq.GEE,
                                                     type="pearson", plot.it=TRUE,
                                                     pch=1, col=mycolours[3], identify=10)

hist(mABISxTnxEnvLAE1_QSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABISxTnxEnvLAE1_QSq.GEE.resP, breaks=20, main="Pearson residuals")

mABISxTnxEnvLAE1_QSq.GEE.DfBc <- dfbeta(mABISxTnxEnvLAE1_QSq.GEE,
                                                  level='clusters', coefs=c('UASLAEMaxLRScl'))
mABISxTnxEnvLAE1_QSq.GEE.DfBo <- dfbeta(mABISxTnxEnvLAE1_QSq.GEE,
                                                  level='observations', coefs=c('UASLAEMaxLRScl'))

mABISxTnxEnvLAE1_QSq.GEE.Cook <- cooks.distance(mABISxTnxEnvLAE1_QSq.GEE,
                                                          plot.it=TRUE)

performance::check_collinearity(mABISxTnxEnvLAE1_QSq.GEE)
performance::check_heteroskedasticity(mABISxTnxEnvLAE1_QSq.GEE)

```

### omit impulsiveness

```{r}

model1 <- mABSxTnxEnvLAE1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl + I(UASEvents^-1) +
                                                      UASSharpAurISO305ExMaxLR*UASTonLdECMAPowAvgBin +
                                                      AmbientEnv*UASTonLdECMAPowAvgBin +
                                                      TrialNumberCntScl,
                                                      data=subjDataNoAmb,
                                                      family=gaussian(link='identity'),
                                                      id=ID.,
                                                      corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABISxTnLAEx1_QSq.GEE,
                    mABISxTnxEnvLAE1_QSq.GEE, mABSxTnxEnvLAE1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  scale_y_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 9)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")


model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]",
                                                                "AmbientEnv [Park]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnv <- ggeffects::predict_response(model1, terms=c("UASTonLdECMAPowAvgBin [all]",
                                                                "AmbientEnv [all]",
                                                                "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnvS <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                 "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnvSxTn <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                   "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                   "UASLAEMaxLRScl [-11, -5, 1, 6, 7, 12]",
                                                                   "AmbientEnv [all]",
                                                                   "UASEvents [1]"),
                                               margin='marginalmeans', type='fixed', 
                                              vcov=vcov(model1, type="bias-corrected"))

model1predictPkASxTn <- ggeffects::predict_response(model1, terms=c("UASSharpAurISO305ExMaxLR [all]",
                                                                   "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                   "UASLAEMaxLRScl [-11, -5, 1, 7]",
                                                                   "AmbientEnv [Park]",
                                                                   "UASEvents [1]"),
                                               margin='marginalmeans', type='fixed', 
                                              vcov=vcov(model1, type="bias-corrected"))


model1predictEnvSxTn$UASLAEMaxLRSclRnd <- model1predictEnvSxTn$facet
model1predictEnvSxTn$AmbientEnv <- model1predictEnvSxTn$panel

model1predictPkASxTn$UASLAEMaxLRSclRnd <- model1predictPkASxTn$facet


stimDataNoAmbTemp <- stimDataNoAmb
numbersIn <- stimDataNoAmbTemp$UASLAEMaxLRScl
numberList <- c(-11, -5, 1, 6, 7, 12)
stimDataNoAmbTemp$UASLAEMaxLRSclRnd <- factor(numberSnap(numbersIn, numberList, rangeVal=0.9))
facetLabels <- c('-11'="56", '-5'="62", '1'="68", '6'="73", '7'="74", '12'="79")

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv=='Park',], aes(x=UASLAEMaxLRScl, y=dAnnoyMean, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p2 <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASTonLdECMAPowAvgBin, y=dAnnoyMean, colour=AmbientEnv, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              scale_x_continuous(breaks=seq(0, 2, by=0.2)) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(T)[italic(N)]^"*",",",~sone[SHM])), y="Mean change in annoyance")


p3 <- ggplot(data=model1predictEnvS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean, colour=AmbientEnv, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              scale_x_continuous(breaks=seq(0, 4, by=0.2)) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance")

p1 + p2 + p3

p4 <- ggplot(data=model1predictEnvSxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.03) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.25, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              ggnewscale::new_scale_color() +
              
              geom_point(data=stimDataNoAmbTemp,
                         aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean,
                             colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.2, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
  
            
              scale_x_continuous(breaks=seq(0, 4, by=0.4),
                                 sec.axis=sec_axis(~ . ,
                                                   name=expression(paste(UAS~italic(L)[AE]~","~dB)),
                                                   breaks = NULL, labels = NULL)) +
              scale_y_continuous(breaks=seq(-3, 10, by=1)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance") +
              facet_grid(AmbientEnv ~ UASLAEMaxLRSclRnd,
                         labeller=labeller(UASLAEMaxLRSclRnd=facetLabels))

p4

p5 <- ggplot(data=model1predictPkASxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.03) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.35, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +

              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              ggnewscale::new_scale_color() +
              
              geom_point(data=stimDataNoAmbTemp[(stimDataNoAmbTemp$SessionPart == "A")
                                                & (stimDataNoAmbTemp$AmbientEnv == "Park"), ],
                         aes(x=UASSharpAurISO305ExMaxLR, y=dAnnoyMean,
                             colour=UASTonLdECMAPowAvgBin),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.2, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
  
            
              scale_x_continuous(breaks=seq(0, 4, by=0.4),
                                 sec.axis=sec_axis(~ . ,
                                                   name=expression(paste(UAS~italic(L)[AE]~","~dB)),
                                                   breaks = NULL, labels = NULL)) +
              scale_y_continuous(breaks=seq(-3, 10, by=1)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"],",",~acum[A~"|"~`M-G-S`])), y="Mean change in annoyance") +
              facet_grid(~ UASLAEMaxLRSclRnd,
                         labeller=labeller(UASLAEMaxLRSclRnd=facetLabels))

p5


```

### impulsiveness score test

```{r}

model1 <- mABISxTnxEnvLAE1_QSq.GEE
model2 <- update(model1, .~. - UASImpulsSHMAvgMaxLR)

anova(model2, model1,
      test='score', varest='bias-corrected')

```

## UAS-env loudness diff

### fit and examine final model

```{r}

model1 <- mABISxTnxdLAEL501_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~
                                                         LAELAF50diffScl*UASTonLdECMAPowAvgBin +
                                                         I(UASEvents^-1) +
                                                         UASImpulsSHMAvgMaxLR +
                                                         UASSharpAurISO305ExMaxLR*UASTonLdECMAPowAvgBin +
                                                         TrialNumberCntScl,
                                                        data=subjDataNoAmb,
                                                        family=gaussian(link='identity'),
                                                        id=ID.,
                                                        corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABISxTnLAEx1_QSq.GEE,
                    mABISxTnxdLAEL501_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 7)) +
  scale_y_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 7)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")


filename <- "PtsABdAnnoyMndLAEPred"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}

model1predictEvt <- ggeffects::predict_response(model1, terms=c("LAELAF50diffScl [all]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxS <- ggeffects::predict_response(model1, terms=c("LAELAF50diffScl [all]",
                                                               "UASSharpAurISO305ExMaxLR [1.2:3, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxTn <- ggeffects::predict_response(model1, terms=c("LAELAF50diffScl [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxI <- ggeffects::predict_response(model1, terms=c("LAELAF50diffScl [all]",
                                                                 "UASImpulsSHMAvgMaxLR [0.15:0.35, by=0.05]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictIxL <- ggeffects::predict_response(model1, terms=c("UASImpulsSHMAvgMaxLR [all]",
                                                                "LAELAF50diffScl [-20, -10, 0, 10]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=LAELAF50diffScl, y=dAnnoyMean, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              rescaleTicks(stimDataNoAmb$LAELAF50diff,
                             stimDataNoAmb$LAELAF50diffScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[AF50],",",~dB)), y="Mean change in annoyance")

p2 <- ggplot(data=model1predictLxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  


              rescaleTicks(stimDataNoAmb$LAELAF50diff,
                             stimDataNoAmb$LAELAF50diffScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              geom_point(data=stimDataNoAmb, aes(x=LAELAF50diffScl, y=dAnnoyMean, colour=UASSharpAurISO305ExMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              labs(x=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[AF50],",",~dB)), y="Mean change in annoyance")


p3 <- ggplot(data=model1predictLxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=LAELAF50diffScl, y=dAnnoyMean, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              rescaleTicks(stimDataNoAmb$LAELAF50diff,
                             stimDataNoAmb$LAELAF50diffScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[AF50],",",~dB)), y="Mean change in annoyance")


p4 <- ggplot(data=model1predictLxI) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=LAELAF50diffScl, y=dAnnoyMean, colour=UASImpulsSHMAvgMaxLR, shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              rescaleTicks(stimDataNoAmb$LAELAF50diff,
                             stimDataNoAmb$LAELAF50diffScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[AF50],",",~dB)), y="Mean change in annoyance")


p5 <- ggplot(data=model1predictIxL) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[AF50],",",~dB)), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[AF50],",",~dB)), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb[stimDataNoAmb$SessionPart == "A", ],
                         aes(x=UASImpulsSHMAvgMaxLR, y=dAnnoyMean, colour=LAELAF50diffScl),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[AF50],",",~dB)), reverse=TRUE)) +

              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +
              
              labs(x=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), y="Mean change in annoyance")

p1 + p2 + p3 + p4 + p5

```

### Model diagnostics

```{r}

mABISxTnxdLAEL501_QSq.GEE.resD <- residuals(mABISxTnxdLAEL501_QSq.GEE,
                                                     type="deviance", plot.it=TRUE,
                                                     pch=1, col=mycolours[1],identify=10)
mABISxTnxdLAEL501_QSq.GEE.resM <- residuals(mABISxTnxdLAEL501_QSq.GEE,
                                                     type="mahalanobis", plot.it=TRUE,
                                                     col=mycolours[2], identify=10)
mABISxTnxdLAEL501_QSq.GEE.resP <- residuals(mABISxTnxdLAEL501_QSq.GEE,
                                                     type="pearson", plot.it=TRUE,
                                                     pch=1, col=mycolours[3], identify=10)

hist(mABISxTnxdLAEL501_QSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABISxTnxdLAEL501_QSq.GEE.resP, breaks=20, main="Pearson residuals")

mABISxTnxdLAEL501_QSq.GEE.DfBc <- dfbeta(mABISxTnxdLAEL501_QSq.GEE,
                                                  level='clusters', coefs=c('LAELAF50diffScl'))
mABISxTnxdLAEL501_QSq.GEE.DfBo <- dfbeta(mABISxTnxdLAEL501_QSq.GEE,
                                                  level='observations', coefs=c('LAELAF50diffScl'))

mABISxTnxdLAEL501_QSq.GEE.Cook <- cooks.distance(mABISxTnxdLAEL501_QSq.GEE,
                                                          plot.it=TRUE)

performance::check_collinearity(mABISxTnxdLAEL501_QSq.GEE)
performance::check_heteroskedasticity(mABISxTnxdLAEL501_QSq.GEE)

```

## with env LAeq and UAS LAE

### fit and examine final model

```{r}

model1 <- mABEnvLAeqxLAEx1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~
                                                         UASLAEMaxLRScl*AmbLAeqMaxLRScl +
                                                         UASLAEMaxLRScl*I(UASEvents^-1) +
                                                         TrialNumberCntScl,
                                                        data=subjDataNoAmb,
                                                        family=gaussian(link='identity'),
                                                        id=ID.,
                                                        corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABLAEx1_QSq.GEE,
                    mABEnvLAeqxLAEx1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
ggplot(data=predictMeans) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 7)) +
  scale_y_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 7)) +
  
  labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")


# filename <- "PtsABdAnnoyMnLAEPred"

# if (saveplots){
#   ggsave(filename=paste(filename, ".svg", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "svg"))
#   unlink(paste(filename, ".svg", sep=""))
# 
#   ggsave(filename=paste(filename, ".pdf", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "pdf"))
#   unlink(paste(filename, ".pdf", sep=""))
# }

model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dAnnoyMean,
                                                 colour=factor(UASEvents),
                                                 shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(-2, 10, by=1), limits=c(-2, 8)) +

              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p1

# save the model
filename = "1B_dA_LAE_EnvLAeq"
saveRDS(model1, file=file.path(outDataPath, paste(filename, ".rds", sep="")))


```

### Model diagnostics

```{r}

mABEnvLAeqxLAEx1_QSq.GEE.resD <- residuals(mABEnvLAeqxLAEx1_QSq.GEE,
                                                     type="deviance", plot.it=TRUE,
                                                     pch=1, col=mycolours[1],identify=10)
mABEnvLAeqxLAEx1_QSq.GEE.resM <- residuals(mABEnvLAeqxLAEx1_QSq.GEE,
                                                     type="mahalanobis", plot.it=TRUE,
                                                     col=mycolours[2], identify=10)
mABEnvLAeqxLAEx1_QSq.GEE.resP <- residuals(mABEnvLAeqxLAEx1_QSq.GEE,
                                                     type="pearson", plot.it=TRUE,
                                                     pch=1, col=mycolours[3], identify=10)

hist(mABEnvLAeqxLAEx1_QSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABEnvLAeqxLAEx1_QSq.GEE.resP, breaks=20, main="Pearson residuals")

mABEnvLAeqxLAEx1_QSq.GEE.DfBc <- dfbeta(mABEnvLAeqxLAEx1_QSq.GEE,
                                                  level='clusters', coefs=c('UASLAEMaxLRScl'))
mABEnvLAeqxLAEx1_QSq.GEE.DfBo <- dfbeta(mABEnvLAeqxLAEx1_QSq.GEE,
                                                  level='observations', coefs=c('UASLAEMaxLRScl'))

mABEnvLAeqxLAEx1_QSq.GEE.Cook <- cooks.distance(mABEnvLAeqxLAEx1_QSq.GEE,
                                                          plot.it=TRUE)

performance::check_collinearity(mABEnvLAeqxLAEx1_QSq.GEE)
performance::check_heteroskedasticity(mABEnvLAeqxLAEx1_QSq.GEE)

```

## UAS detectability

### fit and examine final model

```{r}

model1 <- mABLAExSxDt5i2I1_QSq.GEE <- glmtoolbox::glmgee(dAnnoyance ~ I(UASEvents^-1) + I(Detect0p5IntMaxLRLogScl^2) + 
                                                            UASImpulsSHMAvgMaxLR +
                                                             UASLAEMaxLRScl*UASSharpAurISO305ExMaxLR +
                                                             UASLAEMaxLRScl*Detect0p5IntMaxLRLogScl +
                                                           TrialNumberCntScl,
                                                            data=subjDataNoAmb,
                                                            family=gaussian(link='identity'),
                                                            id=ID.,
                                                            corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)

parameters::standardise_parameters(model1, method='refit', ci=0.843,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)
parameters::standardise_parameters(model1, method='refit', ci=0.95,
                                   robust=FALSE, two_sd=TRUE, include_response=FALSE)

geeModelPerformance(mABLAExTypeOpxLAExEnv1_QxLAESq.GEE, mABISxTnLAEx1_QSq.GEE,
                    mABISxTnxEnvLAE1_QSq.GEE, mABISxTnxdLAEL501_QSq.GEE,
                    mABLAExSxDt5i2I1_QSq.GEE)

predictMeans <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dAnnoyMean,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictMeans$response, predictMeans$fit)^2
R2means

# using ggplot, plot the predicted fit against the responses in predictMeans
p0 <- ggplot(data=predictMeans) +
              theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
              
              geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
              
              scale_x_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 7)) +
              scale_y_continuous(breaks=seq(-10, 10, by=1), limits=c(-0.5, 7)) +
              
              labs(x="Mean change in annoyance (test)", y="Predicted mean change in annoyance")

p0

filename <- "PtsABdAnnoyMnDetectPred"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}

model1predictEvt <- ggeffects::predict_response(model1, terms=c("Detect0p5IntMaxLRLogScl [all]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictDxS <- ggeffects::predict_response(model1, terms=c("Detect0p5IntMaxLRLogScl [all]",
                                                               "UASSharpAurISO305ExMaxLR [1.6:2.8, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictDxI <- ggeffects::predict_response(model1, terms=c("Detect0p5IntMaxLRLogScl [all]",
                                                                 "UASImpulsSHMAvgMaxLR [0.15:0.35, by=0.05]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              geom_point(data=stimDataNoAmb, aes(x=Detect0p5IntMaxLRLogScl, y=dAnnoyMean,
                                                 colour=factor(UASEvents),
                                                 shape=factor(UASEvents)),
                          alpha=0.35, size=2) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              rescaleTicks(stimDataNoAmb$Detect0p5IntMaxLRLog, stimDataNoAmb$Detect0p5IntMaxLRLogScl, sep=1) +
              scale_y_continuous(breaks=seq(-2, 10, by=1)) +
              
              labs(x=expression(paste(UAS~lg~"("~italic(d~"'")[Sigma~"0.5s"]~")")), y="Mean change in annoyance")

p2 <- ggplot(data=model1predictDxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~`M-G-S`])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  

              rescaleTicks(stimDataNoAmb$Detect0p5IntMaxLRLog, stimDataNoAmb$Detect0p5IntMaxLRLogScl, sep=1) +
              scale_y_continuous(breaks=seq(-2, 10, by=1)) +
              
              geom_point(data=stimDataNoAmb, aes(x=Detect0p5IntMaxLRLogScl, y=dAnnoyMean,
                                                 colour=UASSharpAurISO305ExMaxLR,
                                                 shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
  
              labs(x=expression(paste(UAS~lg~"("~italic(d~"'")[Sigma~"0.5s"]~")")), y="Mean change in annoyance")


p3 <- ggplot(data=model1predictDxI) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=Detect0p5IntMaxLRLogScl, y=dAnnoyMean,
                                                 colour=UASImpulsSHMAvgMaxLR,
                                                 shape=factor(UASEvents)),
                         alpha=0.35, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=-1, discrete=FALSE, begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(I)[av]~","~iu[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              rescaleTicks(stimDataNoAmb$Detect0p5IntMaxLRLog, stimDataNoAmb$Detect0p5IntMaxLRLogScl, sep=1) +
              scale_y_continuous(breaks=seq(-2, 10, by=1)) +
              
              labs(x=expression(paste(UAS~lg~"("~italic(d~"'")[Sigma~"0.5s"]~")")), y="Mean change in annoyance")


p1 + p2 + p3


```

### Model diagnostics

```{r}

mABLAExSxDt5i2I1_QSq.GEE.resD <- residuals(mABLAExSxDt5i2I1_QSq.GEE,
                                                     type="deviance", plot.it=TRUE,
                                                     pch=1, col=mycolours[1],identify=10)
mABLAExSxDt5i2I1_QSq.GEE.resM <- residuals(mABLAExSxDt5i2I1_QSq.GEE,
                                                     type="mahalanobis", plot.it=TRUE,
                                                     col=mycolours[2], identify=10)
mABLAExSxDt5i2I1_QSq.GEE.resP <- residuals(mABLAExSxDt5i2I1_QSq.GEE,
                                                     type="pearson", plot.it=TRUE,
                                                     pch=1, col=mycolours[3], identify=10)

hist(mABLAExSxDt5i2I1_QSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABLAExSxDt5i2I1_QSq.GEE.resP, breaks=20, main="Pearson residuals")

mABLAExSxDt5i2I1_QSq.GEE.DfBc <- dfbeta(mABLAExSxDt5i2I1_QSq.GEE,
                                                  level='clusters',
                                         coefs=c('Detect0p5IntMaxLRLogScl'))
mABLAExSxDt5i2I1_QSq.GEE.DfBo <- dfbeta(mABLAExSxDt5i2I1_QSq.GEE,
                                                  level='observations',
                                         coefs=c('Detect0p5IntMaxLRLogScl'))

mABLAExSxDt5i2I1_QSq.GEE.Cook <- cooks.distance(mABLAExSxDt5i2I1_QSq.GEE,
                                                          plot.it=TRUE)

performance::check_collinearity(mABLAExSxDt5i2I1_QSq.GEE)
performance::check_heteroskedasticity(mABLAExSxDt5i2I1_QSq.GEE)

```

## Comparison between GEE-PA and GLMM-SS models with LAE predictor

### Timing comparison

```{r}

set.seed(808)

# benchmark timing
testdAm <- microbenchmark::microbenchmark(
  
    'LMM_model' = {model0LMM <- lme4::lmer(dAnnoyance ~ UASLAEMaxLRScl + I(UASEvents^-1)
                                              + TrialNumberCntScl +
                                             (1 + UASLAEMaxLRScl  + I(UASEvents^-1) | ID.),
                                                  data=subjDataNoAmb, REML=FALSE,
                                           control=lmcontrol)},
    
    'GEE_model' = {model0GEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl + I(UASEvents^-1)
                                              + TrialNumberCntScl,
                                                data=subjDataNoAmb, family=gaussian(link='identity'),
                                                id=ID., corstr='exchangeable')},
    
    'LMM_metrics' = {
                        performance::model_performance(model0LMM, metrics=c("AIC",
                                                                                  "AICc",
                                                                             "BIC",
                                                                             "R2"),
                                                       estimator='ML', verbose=FALSE)
                        },
    
    'GEE_metrics' = {geeModelPerformance(model0GEE, verbose=FALSE)},
    
    'LMM_prediction' = {model0LMMpredict <- ggeffects::predict_response(model0LMM,
                                                      terms=c("UASLAEMaxLRScl [all]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                       type='fixed', margin='marginalmeans',
                                                       bias_correction=FALSE)},
    
    'GEE_prediction' = {model0GEEpredict <- ggeffects::predict_response(model0GEE,
                                                      terms=c("UASLAEMaxLRScl [all]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                       type='fixed', margin='marginalmeans',
                                                      vcov=vcov(model0GEE, type="bias-corrected"))},
    times=10, unit='s', control=list(order='inorder'))

testdAm

lmmVsGEEdAm <- data.frame(model=summary(testdAm)[1,]$median/summary(testdAm)[2,]$median,
                          metrics=summary(testdAm)[3,]$median/summary(testdAm)[4,]$median,
                          pred=summary(testdAm)[5,]$median/summary(testdAm)[6,]$median,
                          total=sum(summary(testdAm)[1,]$median, summary(testdAm)[3,]$median, summary(testdAm)[5,]$median)/
                                sum(summary(testdAm)[2,]$median, summary(testdAm)[4,]$median, summary(testdAm)[6,]$median))

print(paste("Model:", lmmVsGEEdAm$model))
print(paste("Metrics:", lmmVsGEEdAm$metrics))
print(paste("Prediction:", lmmVsGEEdAm$pred))
print(paste("Total:", lmmVsGEEdAm$total))

microbenchmark:::autoplot.microbenchmark(testdAm)
microbenchmark:::boxplot.microbenchmark(testdAm)


```

### Plot comparison

```{r}

set.seed(808)

modelLMM <- lme4::lmer(dAnnoyance ~ UASLAEMaxLRScl + I(UASEvents^-1) +
                             TrialNumberCntScl + (1 + UASLAEMaxLRScl + I(UASEvents^-1) | ID.),
                            data=subjDataNoAmb, control=lmcontrol)

modelGEE <- glmtoolbox::glmgee(dAnnoyance ~ UASLAEMaxLRScl + I(UASEvents^-1) +
                                 TrialNumberCntScl,
                                  data=subjDataNoAmb, REML=FALSE,
                               family=gaussian(link='identity'),
                                  id=ID., corstr='exchangeable')

performance::model_performance(modelLMM, metrics=c("AIC", "AICc", "BIC", "R2"), estimator='ML')

geeModelPerformance(modelGEE)

mABLAE1_QSq.LAEpredict <- ggeffects::predict_response(modelLMM,
                                                      terms=c("UASLAEMaxLRScl [-12:13]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                       margin='mean_mode',
                                                       bias_correction=FALSE)

mABLAE1_QSq.GEEpredict <- ggeffects::predict_response(modelGEE,
                                                      terms=c("UASLAEMaxLRScl [-12:13]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                       type='fixed', margin='marginalmeans',
                                                      vcov=vcov(modelGEE, type="bias-corrected"))

mABLAE1_QSq.LAEpredictAll <- ggeffects::predict_response(modelLMM,
                                                          terms=c("UASLAEMaxLRScl [-12:13]",
                                                                  "ID. [all]",
                                                                  "UASEvents [1]",
                                                                  "TrialNumberCntScl [0]"),
                                                           type='random',
                                                           bias_correction=FALSE)

p <- ggplot() +
  theme(panel.grid = element_blank(), aspect.ratio=1.35,
        text = element_text(family = "serif"),
        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),
        axis.text=(element_text(family = "serif", size=11)))


for (id in unique(mABLAE1_QSq.LAEpredictAll$group)){
  p <- p + geom_line(data=mABLAE1_QSq.LAEpredictAll[mABLAE1_QSq.LAEpredictAll$group==id,],
                     mapping=aes(x=x, y=predicted, colour="LMM (CS)"),
                     alpha=0.1, linewidth=0.25)
}

p <- p + 
  
  geom_ribbon(data=mABLAE1_QSq.LAEpredict, mapping=aes(x=x, ymin=conf.low, ymax=conf.high,
                                                      colour="LMM (CS)"),
              linetype=3, linewidth=0.55, alpha=0.5, fill=NA) +
  
  geom_ribbon(data=mABLAE1_QSq.GEEpredict, mapping=aes(x=x, ymin=conf.low, ymax=conf.high,
                                                      colour="GEE (PA)"),
              linetype=4, linewidth=0.55, alpha=0.5, fill=NA) +
  
  geom_line(data=mABLAE1_QSq.LAEpredict, mapping=aes(x=x, y=predicted,
                                                      colour="LMM (CS)"),
            linewidth=1, alpha=0.75) +
  
  geom_line(data=mABLAE1_QSq.GEEpredict, aes(x=x, y=predicted,
                                             colour="GEE (PA)"),
            linewidth=1, linetype=2, alpha=0.75) +
  
  
  
  rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                 stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
  scale_y_continuous(breaks=seq(-3, 8, by=1)) +
  
  scale_colour_manual(values=c("LMM (CS)"=mycolours[1], "GEE (PA)"=mycolours[2])) +

  guides(colour=guide_legend(title="Method", reverse=TRUE),
         fill=guide_legend(title="Method", reverse=TRUE)) +
  
  labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y="Mean change in annoyance")

p

filename <- "PtsABdAnnoyLMMVsGEE"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=4.5, height=4,
         path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))
  
  ggsave(filename=paste(filename, ".pdf", sep=""), width=4.5, height=4,
         path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


```

# Change in highly annoyed

## Categorical variables - Parts A & B combined analysis

### fit and examine final model

```{r}

model1 <- mABdHTypexOpxLAExEnvlgQxLAE.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ UASLAEMaxLRScl*I(log10(UASEvents)) +
                                                        UASLAEMaxLRScl*AmbientEnv +
                                                          UASLAEMaxLRScl*UASOperation +
                                                        UASType*UASOperation,
                                                              data=subjDataNoAmb,
                                                              family=binomial(link='logit'),
                                                              id=ID.,
                                                              corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHTypexOpxLAExEnvlgQxLAE.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp)

R2probs <- cor(predictProbs$response, predictProbs$fit)^2
R2probs

# using ggplot, plot the predicted fit against the responses in predictProbs
ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")), y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))


# fit 1/Q model

mABdHTypexOpxLAExEnv1_QxLAE.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ UASLAEMaxLRScl*I(UASEvents^-1) +
                                                        UASLAEMaxLRScl*AmbientEnv +
                                                          UASLAEMaxLRScl*UASOperation +
                                                        UASType*UASOperation,
                                                              data=subjDataNoAmb,
                                                              family=binomial(link='logit'),
                                                              id=ID.,
                                                              corstr='exchangeable')

model1predictEvt2CopyOver <- ggeffects::predict_response(mABdHTypexOpxLAExEnv1_QxLAE.GEE, terms=c("UASEvents [all]",
                                                                 "UASLAEMaxLRScl [7, 13]",
                                                                 "AmbientEnv [Park]",
                                                                 "UASOperation [Flyover]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTypePk <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                   "UASType [all]",
                                                                   "UASEvents [1]",
                                                                   "AmbientEnv [Park]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                               vcov=vcov(model1, type="bias-corrected"))

model1predictOpPk <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                               "UASOperation [all]",
                                                               "UASEvents [1]",
                                                                 "AmbientEnv [Park]"),
                                                margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTypePkSt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTypePk <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "AmbientEnv [Park]",
                                                                 "UASEvents [1]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTypeSt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "AmbientEnv [Street]",
                                                                 "UASEvents [1]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictType <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                 "UASType [all]",
                                                                 "UASEvents [1]"),
                                                 margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictOpPkSt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                               "UASOperation [all]",
                                                               "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                                margin='marginalmeans',
                                                 type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEnv <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "AmbientEnv [all]",
                                                                "UASEvents [1]"),
                                                margin='marginalmeans',
                                                type='fixed',
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]",
                                                                "AmbientEnv [Park]",
                                                                "UASOperation [Flyover]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictEvt2 <- ggeffects::predict_response(model1, terms=c("UASEvents [all]",
                                                                 "UASLAEMaxLRScl [7, 13]",
                                                                 "AmbientEnv [Park]",
                                                                 "UASOperation [Flyover]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTypePkSt$AmbientEnv <- model1predictTypePkSt$facet
model1predictOpPkSt$AmbientEnv <- model1predictOpPkSt$facet

p1 <- ggplot(data=model1predictTypePkSt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASEvents == 1), ], aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=UASType, shape=UASType),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE),
                     fill=guide_legend(title="UAS type", reverse=FALSE),
                     shape=guide_legend(title="UAS type", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]))) +
              facet_grid(rows = vars(AmbientEnv))

p2 <- ggplot(data=model1predictOpPkSt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASEvents == 1), ], aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=UASOperation, shape=UASOperation),
                         alpha=0.65, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='mako', discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='mako', discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(9, 6, 2)) +
              
              guides(colour=guide_legend(title="UAS operation", reverse=TRUE),
                     fill=guide_legend(title="UAS operation", reverse=TRUE),
                     shape=guide_legend(title="UAS operation", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]))) +
              facet_grid(rows = vars(AmbientEnv))

p3 <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14),
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank()) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=AmbientEnv, shape=AmbientEnv),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_shape_manual(values=c(1, 3)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p4 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv=='Park',],
                         aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


(p1 | p2) + (p3 / p4)

filename <- "PtsABdHiAnnoyCatMod"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=15, height=8, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=15, height=8, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}

p1b <- ggplot(data=model1predictTypePk) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=12)) +
              
              geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASEvents == 1) &
                                            (stimDataNoAmb$AmbientEnv == "Park"), ],
                         aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=UASType, shape=UASType),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE),
                     fill=guide_legend(title="UAS type", reverse=FALSE),
                     shape=guide_legend(title="UAS type", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p1b

filename <- "PtsABdHiAnnoyCatTypePkMod"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=4.5, height=4, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=4.5, height=4, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


p1c <- ggplot(data=model1predictTypePk) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14),
                    legend.text=element_text(size=10)) +
              
              # geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASEvents == 1) &
              #                               (stimDataNoAmb$AmbientEnv == "Park"), ],
              #            aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=UASType, shape=UASType),
              #            alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     fill=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     shape=guide_legend(title="UAS type", reverse=FALSE, order=1)) +            
  
              ggnewscale::new_scale_colour() +
  
              geom_line(data=pHALAENLR, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=3, linewidth=1.5, alpha=0.9) +
        
              guides(colour=guide_legend(title="Aalmoes et al.", reverse=FALSE, order=2)) +  

              ggnewscale::new_scale_colour() +
  
              geom_line(data=pHALAEEMPA, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=2, linewidth=1, alpha=0.9) +
  
              scale_colour_brewer(palette = "Set1") +
  
              guides(colour=guide_legend(title="Kawai et al.", reverse=FALSE, order=3)) +      
  
              rescaleTicks(pHALAENLR$LAE,
                             pHALAENLR$LAEScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed)))

p1c

filename <- "PtsABdHiAnnoyCatTypePkModComp"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}

p1d <- ggplot(data=model1predictTypePk) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=12),
                    legend.text=element_text(size=11),
                    legend.title=element_text(size=12),
                    legend.spacing.y = unit(0.1, "cm")) +
              
              # geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASEvents == 1) &
              #                               (stimDataNoAmb$AmbientEnv == "Park"), ],
              #            aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=UASType, shape=UASType),
              #            alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type (park)", reverse=FALSE, order=1),
                     fill=guide_legend(title="UAS type (park)", reverse=FALSE, order=1),
                     shape=guide_legend(title="UAS type (park)", reverse=FALSE, order=1)) +

              ggnewscale::new_scale_colour() +
  
              geom_line(data=model1predictTypeSt, aes(x=x, y=predicted, colour=group),
                        linewidth=1, linetype=4) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              
              guides(colour=guide_legend(title="UAS type (Street)", reverse=FALSE, order=2)) +

              ggnewscale::new_scale_colour() +
  
              geom_line(data=pHALAENLR, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=3, size=1.5, alpha=0.9) +
        
              guides(colour=guide_legend(title="Aalmoes et al.", reverse=FALSE, order=3)) +
  
              ggnewscale::new_scale_colour() +            
  
              geom_line(data=pHALAEEMPA, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=2, size=1, alpha=0.9) +
  
              scale_colour_brewer(palette = "Set1") +
  
              guides(colour=guide_legend(title="Kawai et al.", reverse=FALSE, order=4)) +            
  
  
              rescaleTicks(pHALAENLR$LAE,
                             pHALAENLR$LAEScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed)))

p1d

filename <- "PtsABdHiAnnoyCatTypePkStModComp"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}

p1e <- ggplot(data=model1predictType) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=12),
                    legend.text=element_text(size=11),
                    legend.title=element_text(size=12),
                    legend.spacing.y = unit(0.1, "cm")) +
              
              # geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASEvents == 1) &
              #                               (stimDataNoAmb$AmbientEnv == "Park"), ],
              #            aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=UASType, shape=UASType),
              #            alpha=0.35, size=2) +
              
              geom_line(data=pHALAENLR, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=3, size=1.25, alpha=0.8) +
        
              guides(colour=guide_legend(title="Aalmoes et al.", reverse=FALSE, order=2)) +
  
              ggnewscale::new_scale_colour() +            
  
              geom_line(data=pHALAEEMPA, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=2, size=0.75, alpha=0.8) +
  
              scale_colour_brewer(palette = "Set1") +
  
              guides(colour=guide_legend(title="Kawai et al.", reverse=FALSE, order=3)) +
  
              ggnewscale::new_scale_colour() +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     fill=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     shape=guide_legend(title="UAS type", reverse=FALSE, order=1)) +

              
  
  
              rescaleTicks(pHALAENLR$LAE,
                             pHALAENLR$LAEScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed)))

p1e

filename <- "PtsABdHiAnnoyCatTypeModComp"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


p1f <- ggplot(data=model1predictType) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=12),
                    legend.text=element_text(size=11),
                    legend.title=element_text(size=12),
                    legend.spacing.y=unit(0.1, 'cm')) +
              
              # geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASEvents == 1) &
              #                               (stimDataNoAmb$AmbientEnv == "Park"), ],
              #            aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=UASType, shape=UASType),
              #            alpha=0.35, size=2) +
              
              
              geom_line(data=pHALAENLR, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=3, size=1.25, alpha=0.8) +
        
              guides(colour=guide_legend(title="Aalmoes et al.", reverse=FALSE, order=2)) +

              ggnewscale::new_scale_colour() +            
  
              geom_line(data=pHALAEGwak, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=4, size=0.75, alpha=0.8) +
  
              scale_colour_brewer(palette = "Dark2") +
  
              guides(colour=guide_legend(title="Gwak et al.", reverse=FALSE, order=3)) +     
  
              ggnewscale::new_scale_colour() +            
  
              geom_line(data=pHALAEEMPA, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=2, size=1, alpha=0.8) +
  
              scale_colour_brewer(palette = "Set1") +
  
              guides(colour=guide_legend(title="Kawai et al.", reverse=FALSE, order=4)) +
  
              ggnewscale::new_scale_colour() +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     fill=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     shape=guide_legend(title="UAS type", reverse=FALSE, order=1)) +

    
              rescaleTicks(pHALAEGwak$LAE,
                             pHALAEGwak$LAEScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed)))

p1f

filename <- "PtsABdHiAnnoyCatTypeModCompAll"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


p1g <- ggplot(data=model1predictType) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=12),
                    legend.text=element_text(size=9),
                    legend.title=element_text(size=9),
                    legend.spacing.y=unit(-0.2, 'cm')) +
              
              geom_line(data=pHALAENLR, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=3, size=1.25, alpha=0.8) +
        
              guides(colour=guide_legend(title="Aalmoes et al.", reverse=FALSE, order=2)) +

              ggnewscale::new_scale_colour() +
    
              geom_line(data=pHALAEGwak, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=4, size=0.75, alpha=0.8) +
  
              scale_colour_brewer(palette = "Dark2") +
  
              guides(colour=guide_legend(title="Gwak et al.", reverse=FALSE, order=3)) +     
  
              ggnewscale::new_scale_colour() +
  
              geom_line(data=pHALAEJeong, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=5, size=0.75, alpha=0.8) +
  
              scale_colour_brewer(palette = "BrBG", direction=1) +
  
              guides(colour=guide_legend(title="Jeong et al.", order=4)) +     
  
              ggnewscale::new_scale_colour() +
  
              geom_line(data=pHALAEEMPA, aes(x=LAEScl, y=pHA, colour=UAS),
                        linetype=2, size=1, alpha=0.8) +
  
              scale_colour_brewer(palette = "Set1") +
  
              guides(colour=guide_legend(title="Kawai et al.", reverse=FALSE, order=5)) +
  
              ggnewscale::new_scale_colour() +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='plasma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     fill=guide_legend(title="UAS type", reverse=FALSE, order=1),
                     shape=guide_legend(title="UAS type", reverse=FALSE, order=1)) +

              rescaleTicks(pHALAEGwak$LAE,
                             pHALAEGwak$LAEScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)), y=expression(paste("%"~Highly~annoyed)))

p1g

filename <- "PtsABdHiAnnoyCatTypeModCompAll2"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}




p3b <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=12),
                    axis.text=element_text(family = "serif", size=11)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=AmbientEnv, shape=AmbientEnv),
                         alpha=0.35, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.2, end = 0.7) +
              scale_shape_manual(values=c(1, 3)) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=FALSE),
                     fill=guide_legend(title="Amb. env.", reverse=FALSE),
                     shape=guide_legend(title="Amb. env.", reverse=FALSE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p3b

filename <- "PtsABdHiAnnoyCatEnvMod"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=4.5, height=4, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=4.5, height=4, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


p5 <- ggplot(data=model1predictEvt2) +
              theme(panel.grid = element_blank(), aspect.ratio=0.8,
                    text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[(stimDataNoAmb$UASOperation=='Flyover')
                                            & (stimDataNoAmb$SessionPart=='B'),],
                         aes(x=UASEvents, y=dHighAnnoyProp,
                             colour=UASLAEMaxLR, shape=UASType),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='inferno', direction=1, discrete=FALSE, begin = 0.2, end = 0.8,
                                  breaks=c(73, 79)) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE]~","~dB)), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
  
              geom_ribbon(data=model1predictEvt2CopyOver,
                          aes(x=x, ymin=conf.low, ymax=conf.high, fill=group),
                          alpha=0.05) +
  
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, colour=group),
                          linewidth=0.5, linetype=3, fill=NA, alpha=0.25) +
              
              geom_line(data=model1predictEvt2CopyOver,
                        aes(x=x, y=predicted, colour=group), linewidth=1, alpha=0.5) +
  
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5,
                        linewidth=1, linetype=3) +
              
              scale_color_viridis(option='inferno', direction=1, discrete=TRUE, begin = 0.2, end = 0.8,
                                         labels=c(73, 79)) +
              scale_fill_viridis(option='inferno', direction=1, discrete=TRUE, begin = 0.2, end = 0.8,
                                         labels=c(73, 79)) +
              scale_shape_manual(values=c(10, 11, 12)) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(L)[AE]~","~dB)), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(L)[AE]~","~dB)), reverse=TRUE),
                     shape=guide_legend(title="UAS type"), reverse=FALSE) +
            
              scale_x_continuous(breaks=c(1, 3, 5, 9), labels=c(1, 3, 5, 9)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x="Number of UAS flyover events", y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p5

filename <- "PtsABdHiAnnoyCatModEvtlgComp"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=6, height=4, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=6, height=4, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


```

### Model diagnostics

```{r}


mABdHTypexOpxLAExEnvlgQxLAE.GEE.resD <- residuals(mABdHTypexOpxLAExEnvlgQxLAE.GEE,
                                                     type="deviance", plot.it=TRUE,
                                                     pch=1, col=mycolours[1],identify=10)
mABdHTypexOpxLAExEnvlgQxLAE.GEE.resM <- residuals(mABdHTypexOpxLAExEnvlgQxLAE.GEE,
                                                     type="mahalanobis", plot.it=TRUE,
                                                     col=mycolours[2], identify=10)
mABdHTypexOpxLAExEnvlgQxLAE.GEE.resP <- residuals(mABdHTypexOpxLAExEnvlgQxLAE.GEE,
                                                     type="pearson", plot.it=TRUE,
                                                     pch=1, col=mycolours[3], identify=10)

hist(mABdHTypexOpxLAExEnvlgQxLAE.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABdHTypexOpxLAExEnvlgQxLAE.GEE.resP, breaks=20, main="Pearson residuals")

par(mar = rep(2, 4))

mABdHTypexOpxLAExEnvlgQxLAE.GEE.DfBc <- dfbeta(mABdHTypexOpxLAExEnvlgQxLAE.GEE,
                                                  level='clusters',
                                         coefs=c('UASLAEMaxLRScl'))
mABdHTypexOpxLAExEnvlgQxLAE.GEE.DfBo <- dfbeta(mABdHTypexOpxLAExEnvlgQxLAE.GEE,
                                                  level='observations',
                                         coefs=c('UASLAEMaxLRScl'))

mABdHTypexOpxLAExEnvlgQxLAE.GEE.Cook <- cooks.distance(mABdHTypexOpxLAExEnvlgQxLAE.GEE,
                                                          plot.it=TRUE)

performance::check_collinearity(mABdHTypexOpxLAExEnvlgQxLAE.GEE)

```

## UAS info only

### LAE only with events

```{r}

model1 <- mABdHLAElgQ.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ I(log10(UASEvents)) +
                                                        UASLAEMaxLRScl,
                                                        data=subjDataNoAmb,
                                                        family=binomial(link='logit'),
                                                        id=ID.,
                                                        corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHLAElgQ.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2probs <- cor(predictProbs$response, predictProbs$fit)^2
R2probs


# using ggplot, plot the predicted fit against the responses in predictProbs
ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")),
       y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))


model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv=='Park',],
                         aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p1

# save the model
filename = "2A_dHA_LAE_noEnv"
saveRDS(model1, file=file.path(outDataPath, paste(filename, ".rds", sep="")))


```

### loudness only, with events

```{r}

model1 <- mABdHNlgQ.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ I(log10(UASEvents)) +
                                                    UASLoudECMAPowAvgBin,
                                                data=subjDataNoAmb,
                                                family=binomial(link='logit'),
                                                id=ID.,
                                                corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHLAElgQ.GEE, mABdHNlgQ.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2means <- cor(predictProbs$response, predictProbs$fit)^2
R2means


# using ggplot, plot the predicted fit against the responses in predictProbs
ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")),
       y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))



model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p1


```

### fit and examine final model

```{r}

model1 <- mABdHSxTnNlgQ.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ UASLoudECMAPowAvgBin +
                                                     I(log10(UASEvents)) +
                               UASTonLdECMAPowAvgBin*UASSharpAurSHM05ExMaxLR,
                              data=subjDataNoAmb,
                              family=binomial(link='logit'),
                              id=ID.,
                              corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHTypexOpxLAExEnvlgQxLAE.GEE, mABdHSxTnNlgQ.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp)

R2probs <- cor(predictProbs$response, predictProbs$fit)^2
R2probs


# using ggplot, plot the predicted fit against the responses in predictProbs
ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")), y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))



model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictNxS <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                               "UASSharpAurSHM05ExMaxLR [1.2:2.8, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictNxTn <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


model1predictTnxS <- ggeffects::predict_response(model1, terms=c("UASTonLdECMAPowAvgBin [all]",
                                                               "UASSharpAurSHM05ExMaxLR [1.2:2.8, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))
p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p2 <- ggplot(data=model1predictNxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(1.2, 2.8, by=0.4)) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  

              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=UASSharpAurSHM05ExMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p3 <- ggplot(data=model1predictNxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p4 <- ggplot(data=model1predictTnxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(1.2, 2.8, by=0.4)) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  

              #scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASTonLdECMAPowAvgBin, y=dHighAnnoyProp, colour=UASSharpAurSHM05ExMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              labs(x=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p1 + p2 + p3 + p4


```

### Model diagnostics

```{r}


mABdHSxTnNlgQ.GEE.resD <- residuals(mABdHSxTnNlgQ.GEE,
                                     type="deviance", plot.it=TRUE,
                                     pch=1, col=mycolours[1],identify=10)
mABdHSxTnNlgQ.GEE.resM <- residuals(mABdHSxTnNlgQ.GEE,
                                     type="mahalanobis", plot.it=TRUE,
                                     col=mycolours[2], identify=10)
mABdHSxTnNlgQ.GEE.resP <- residuals(mABdHSxTnNlgQ.GEE,
                                     type="pearson", plot.it=TRUE,
                                     pch=1, col=mycolours[3], identify=10)

hist(mABdHSxTnNlgQ.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABdHSxTnNlgQ.GEE.resP, breaks=20, main="Pearson residuals")

par(mar = rep(2, 4))

mABdHSxTnNlgQ.GEE.DfBc <- dfbeta(mABdHSxTnNlgQ.GEE,
                                  level='clusters',
                                 coefs=c('UASLoudECMAPowAvgBin'))
mABdHSxTnNlgQ.GEE.DfBo <- dfbeta(mABdHSxTnNlgQ.GEE,
                                level='observations',
                               coefs=c('UASLoudECMAPowAvgBin'))

mABdHSxTnNlgQ.GEE.Cook <- cooks.distance(mABdHSxTnNlgQ.GEE,
                                          plot.it=TRUE)

performance::check_collinearity(mABdHSxTnNlgQ.GEE)

```

## with env class

### fit and examine final model

```{r}


model1 <- mABdHISxTnEnvxNlgQSq.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ UASLoudECMAPowAvgBin +
                                                               I(log10(UASEvents)) +
                                 UASLoudECMAPowAvgBin*AmbientEnv +
                               UASTonLdECMAPowAvgBin*UASSharpAurSHM05ExMaxLR +
                                 UASImpulsSHMPowAvgMaxLR +
                                 TrialNumberCntScl,
                              data=subjDataNoAmb,
                              family=binomial(link='logit'),
                              id=ID.,
                              corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHTypexOpxLAExEnvlgQxLAE.GEE, mABdHSxTnNlgQ.GEE,
                    mABdHISxTnEnvxNlgQSq.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2probs <- cor(predictProbs$response, predictProbs$fit)^2
R2probs

# using ggplot, plot the predicted fit against the responses in predictProbs
p0 <- ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[3], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.7)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.7)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")),
       y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))

p0

filename <- "PtsABdHiAnnoyEnvClsPred"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}

model1predictEnv <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                                "AmbientEnv [all]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                                "UASEvents [all]",
                                                                "AmbientEnv [Park]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictNxS <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                               "UASSharpAurSHM05ExMaxLR [1.2:2.8, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictNxTn <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictNxI <- ggeffects::predict_response(model1, terms=c("UASLoudECMAPowAvgBin [all]",
                                                                 "UASImpulsSHMPowAvgMaxLR [0.15:0.35, by=0.05]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTn <- ggeffects::predict_response(model1, terms=c("UASTonLdECMAPowAvgBin [all]",
                                                                 "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p2 <- ggplot(data=model1predictNxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(1.2, 2.8, by=0.4)) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)[italic("5")]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  

              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=UASSharpAurSHM05ExMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p3 <- ggplot(data=model1predictNxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p4 <- ggplot(data=model1predictNxI) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(I)^"*"~","~iu[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(I)^"*"~","~iu[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=UASImpulsSHMPowAvgMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(I)^"*"~","~iu[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p5 <- ggplot(data=model1predictTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASTonLdECMAPowAvgBin, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              scale_x_continuous(breaks=seq(0.5, 1.5, by=0.25)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p6 <- ggplot(data=model1predictEnv) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASLoudECMAPowAvgBin, y=dHighAnnoyProp, colour=AmbientEnv, shape=AmbientEnv),
                         alpha=0.35, size=2) +
  
              scale_shape_manual(values=c(1, 3)) +
              scale_color_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='magma', direction=-1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title="Amb. env.", reverse=TRUE),
                     fill=guide_legend(title="Amb. env.", reverse=TRUE),
                     shape=guide_legend(title="Amb. env.", reverse=TRUE)) +

              scale_x_continuous(breaks=seq(1, 6, by=1)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(N)^"*"~","~sone[SHM])), y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p1 + p2 + p3 + p4 + p5 + p6


```

### Model diagnostics

```{r}


mABdHISxTnEnvxNlgQSq.GEE.resD <- residuals(mABdHISxTnEnvxNlgQSq.GEE,
                                     type="deviance", plot.it=TRUE,
                                     pch=1, col=mycolours[1],identify=10)
mABdHISxTnEnvxNlgQSq.GEE.resM <- residuals(mABdHISxTnEnvxNlgQSq.GEE,
                                     type="mahalanobis", plot.it=TRUE,
                                     col=mycolours[2], identify=10)
mABdHISxTnEnvxNlgQSq.GEE.resP <- residuals(mABdHISxTnEnvxNlgQSq.GEE,
                                     type="pearson", plot.it=TRUE,
                                     pch=1, col=mycolours[3], identify=10)

hist(mABdHISxTnEnvxNlgQSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABdHISxTnEnvxNlgQSq.GEE.resP, breaks=20, main="Pearson residuals")

par(mar = rep(2, 4))

mABdHISxTnEnvxNlgQSq.GEE.DfBc <- dfbeta(mABdHISxTnEnvxNlgQSq.GEE,
                                  level='clusters',
                                 coefs=c('UASLoudECMAPowAvgBin'))
mABdHISxTnEnvxNlgQSq.GEE.DfBo <- dfbeta(mABdHISxTnEnvxNlgQSq.GEE,
                                level='observations',
                               coefs=c('UASLoudECMAPowAvgBin'))

mABdHISxTnEnvxNlgQSq.GEE.Cook <- cooks.distance(mABdHISxTnEnvxNlgQSq.GEE,
                                          plot.it=TRUE)

performance::check_collinearity(mABdHISxTnEnvxNlgQSq.GEE)

```

## UAS-env loudness diff

### fit and examine final model

```{r}

model1 <- mABdHSxTndLAELAeq2lgQSq.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ I(log10(UASEvents)) + LAELAeqdiffScl +
                                                                   UASTonLdECMAPowAvgBin*UASSharpAurSHM05ExMaxLR +
                                                                I(LAELAeqdiffScl^2) +
                                                                   TrialNumberCntScl,
                                                              data=subjDataNoAmb,
                                                              family=binomial(link='logit'),
                                                              id=ID.,
                                                              corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHTypexOpxLAExEnvlgQxLAE.GEE, mABdHSxTnNlgQ.GEE,
                    mABdHISxTnEnvxNlgQSq.GEE, mABdHSxTndLAELAeq2lgQSq.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2probs <- cor(predictProbs$response, predictProbs$fit)^2
R2probs

# using ggplot, plot the predicted fit against the responses in predictProbs
ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")),
       y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))


model1predictEvt <- ggeffects::predict_response(model1, terms=c("LAELAeqdiffScl [all]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxS <- ggeffects::predict_response(model1, terms=c("LAELAeqdiffScl [all]",
                                                               "UASSharpAurSHM05ExMaxLR [1.2:2.8, by=0.4]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictLxTn <- ggeffects::predict_response(model1, terms=c("LAELAeqdiffScl [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTn <- ggeffects::predict_response(model1, terms=c("UASTonLdECMAPowAvgBin [all]",
                                                                 "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=LAELAeqdiffScl, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              rescaleTicks(stimDataNoAmb$LAELAeqdiff,
                             stimDataNoAmb$LAELAeqdiffScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[Aeq]~","~dB)),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p2 <- ggplot(data=model1predictLxS) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~SHM])), reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
            
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(1.2, 2.8, by=0.4)) +

              guides(colour=guide_legend(title=expression(paste(UAS~italic(S)["5"]~","~acum[A~"|"~SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +  

              rescaleTicks(stimDataNoAmb$LAELAeqdiff,
                             stimDataNoAmb$LAELAeqdiffScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              geom_point(data=stimDataNoAmb, aes(x=LAELAeqdiffScl, y=dHighAnnoyProp, colour=UASSharpAurSHM05ExMaxLR, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              labs(x=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[Aeq]~","~dB)),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p3 <- ggplot(data=model1predictLxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=LAELAeqdiffScl, y=dHighAnnoyProp, colour=UASTonLdECMAPowAvgBin, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
              
              rescaleTicks(stimDataNoAmb$LAELAeqdiff,
                             stimDataNoAmb$LAELAeqdiffScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE]~-~amb.~env.~italic(L)[Aeq]~","~dB)),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p4 <- ggplot(data=model1predictTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb, aes(x=UASTonLdECMAPowAvgBin, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              scale_x_continuous(breaks=seq(0.5, 1.5, by=0.25)) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p1 + p2 + p3 + p4

```

### Model diagnostics

```{r}


mABdHSxTndLAELAeq2lgQSq.GEE.resD <- residuals(mABdHSxTndLAELAeq2lgQSq.GEE,
                                     type="deviance", plot.it=TRUE,
                                     pch=1, col=mycolours[1],identify=10)
mABdHSxTndLAELAeq2lgQSq.GEE.resM <- residuals(mABdHSxTndLAELAeq2lgQSq.GEE,
                                     type="mahalanobis", plot.it=TRUE,
                                     col=mycolours[2], identify=10)
mABdHSxTndLAELAeq2lgQSq.GEE.resP <- residuals(mABdHSxTndLAELAeq2lgQSq.GEE,
                                     type="pearson", plot.it=TRUE,
                                     pch=1, col=mycolours[3], identify=10)

hist(mABdHSxTndLAELAeq2lgQSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABdHSxTndLAELAeq2lgQSq.GEE.resP, breaks=20, main="Pearson residuals")

par(mar = rep(2, 4))

mABdHSxTndLAELAeq2lgQSq.GEE.DfBc <- dfbeta(mABdHSxTndLAELAeq2lgQSq.GEE,
                                  level='clusters',
                                 coefs=c('LAELAeqdiffScl'))
mABdHSxTndLAELAeq2lgQSq.GEE.DfBo <- dfbeta(mABdHSxTndLAELAeq2lgQSq.GEE,
                                level='observations',
                               coefs=c('LAELAeqdiffScl'))

mABdHSxTndLAELAeq2lgQSq.GEE.Cook <- cooks.distance(mABdHSxTndLAELAeq2lgQSq.GEE,
                                          plot.it=TRUE)

performance::check_collinearity(mABdHSxTndLAELAeq2lgQSq.GEE)

```

## with env LAeq and UAS LAE

### fit and examine final model

```{r}

model1 <- mABdHLAExEnvLAeqlgQ.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ I(log10(UASEvents)) +
                                                        UASLAEMaxLRScl*AmbLAeqMaxLRScl,
                                                        data=subjDataNoAmb,
                                                        family=binomial(link='logit'),
                                                        id=ID.,
                                                        corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHTypexOpxLAExEnvlgQxLAE.GEE, mABdHLAElgQ.GEE,
                    mABdHLAExEnvLAeqlgQ.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2probs <- cor(predictProbs$response, predictProbs$fit)^2
R2probs


# using ggplot, plot the predicted fit against the responses in predictProbs
ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[1], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.5)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")),
       y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))


model1predictEvt <- ggeffects::predict_response(model1, terms=c("UASLAEMaxLRScl [-12:13]",
                                                                "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))


p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_point(data=stimDataNoAmb[stimDataNoAmb$AmbientEnv=='Park',],
                         aes(x=UASLAEMaxLRScl, y=dHighAnnoyProp, colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.1) +
              
              geom_line(aes(x=x, y=predicted, colour=group), linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.2, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
            
              rescaleTicks(stimDataNoAmb$UASLAEMaxLR,
                             stimDataNoAmb$UASLAEMaxLRScl, sep=5) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
              
              labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))


p1

# save the model
filename = "2B_dHA_LAE_EnvLAeq"
saveRDS(model1, file=file.path(outDataPath, paste(filename, ".rds", sep="")))


```

### Model diagnostics

```{r}


mABdHLAExEnvLAeqlgQ.GEE.resD <- residuals(mABdHLAExEnvLAeqlgQ.GEE,
                                     type="deviance", plot.it=TRUE,
                                     pch=1, col=mycolours[1],identify=10)
mABdHLAExEnvLAeqlgQ.GEE.resM <- residuals(mABdHLAExEnvLAeqlgQ.GEE,
                                     type="mahalanobis", plot.it=TRUE,
                                     col=mycolours[2], identify=10)
mABdHLAExEnvLAeqlgQ.GEE.resP <- residuals(mABdHLAExEnvLAeqlgQ.GEE,
                                     type="pearson", plot.it=TRUE,
                                     pch=1, col=mycolours[3], identify=10)

hist(mABdHLAExEnvLAeqlgQ.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABdHLAExEnvLAeqlgQ.GEE.resP, breaks=20, main="Pearson residuals")

par(mar = rep(2, 4))

mABdHLAExEnvLAeqlgQ.GEE.DfBc <- dfbeta(mABdHLAExEnvLAeqlgQ.GEE,
                                  level='clusters',
                                 coefs=c('UASLAEMaxLRScl'))
mABdHLAExEnvLAeqlgQ.GEE.DfBo <- dfbeta(mABdHLAExEnvLAeqlgQ.GEE,
                                level='observations',
                               coefs=c('UASLAEMaxLRScl'))

mABdHLAExEnvLAeqlgQ.GEE.Cook <- cooks.distance(mABdHLAExEnvLAeqlgQ.GEE,
                                          plot.it=TRUE)

performance::check_collinearity(mABdHLAExEnvLAeqlgQ.GEE)

```

## UAS detectability

### fit and examine final model

```{r}

model1 <- mABdHSxTnDt1i2IrlgQSq.GEE <- glmtoolbox::glmgee(dHighAnnoy ~ I(log10(UASEvents)) +
                                                     Detect0p1IntMaxLRLogScl +
                                                       UASTonLdECMAPowAvgBin*UASSharpAurSHM05ExMaxLR +
                                                   I(Detect0p1IntMaxLRLogScl^2) +
                                                     IntermitRatioC3MaxLRScl +
                                                     TrialNumberCntScl,
                                              data=subjDataNoAmb,
                                              family=binomial(link='logit'),
                                              id=ID.,
                                              corstr='exchangeable')

geeParams(model1, ci=0.843, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=FALSE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)
geeParams(model1, ci=0.95, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(mABdHTypexOpxLAExEnvlgQxLAE.GEE, mABdHSxTnNlgQ.GEE,
                    mABdHISxTnEnvxNlgQSq.GEE, mABdHSxTndLAELAeq2lgQSq.GEE,
                    mABdHSxTnDt1i2IrlgQSq.GEE)

predictProbs <- predictNew(model=model1, newData=stimDataNoAmb,
                           response=stimDataNoAmb$dHighAnnoyProp,
                           fixVars=c(TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl)))

R2probs <- cor(predictProbs$response, predictProbs$fit)^2
R2probs

# using ggplot, plot the predicted fit against the responses in predictProbs
ggplot(data=predictProbs) +
  theme(panel.grid = element_blank(), aspect.ratio=1, text=element_text(family = "serif", size=12),
        axis.text=element_text(family = "serif", size=14)) +
  
  geom_point(mapping=aes(x=response, y=fit), size=2.5, shape=1, colour=mycolours[3], alpha=0.5) +
  
  geom_abline(aes(intercept=0, slope=1), colour='grey', alpha=0.5) +
  
  scale_x_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.7)) +
  scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 0.7)) +
  
  labs(x=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb]~"("~test~")")),
        y=expression(paste(Predicted~"%"~highly~annoyed~"|"~HA~"'"[amb])))

filename <- "PtsABdHiAnnoyMnDetectPred"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))

  ggsave(filename=paste(filename, ".pdf", sep=""), width=3.5, height=3.5, path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


model1predictEvt <- ggeffects::predict_response(model1, terms=c("Detect0p1IntMaxLRLogScl [all]",
                                                                "IntermitRatioC3MaxLRScl [0:0.9, by=0.3]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictDLxTn <- ggeffects::predict_response(model1, terms=c("Detect0p1IntMaxLRLogScl [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "IntermitRatioC3MaxLRScl [0.5]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictTnxIr <- ggeffects::predict_response(model1, terms=c("UASTonLdECMAPowAvgBin [all]",
                                                                 "IntermitRatioC3MaxLRScl [0:0.9, by=0.3]",
                                                                 "UASEvents [1]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictSxTn <- ggeffects::predict_response(model1, terms=c("UASSharpAurSHM05ExMaxLR [all]",
                                                                 "UASTonLdECMAPowAvgBin [0.5:1.5, by=0.25]",
                                                                 "IntermitRatioC3MaxLRScl [0.5]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

model1predictIr <- ggeffects::predict_response(model1, terms=c("IntermitRatioC3MaxLRScl [all]",
                                                                 "UASEvents [all]"),
                                             margin='marginalmeans', type='fixed', 
                                            vcov=vcov(model1, type="bias-corrected"))

p1 <- ggplot(data=model1predictEvt) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="Intermit. ratio", reverse=TRUE),
                     fill=guide_legend(title="Intermit. ratio", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +

              ggnewscale::new_scale_colour() +
            
              geom_point(data=stimDataNoAmb, aes(x=Detect0p1IntMaxLRLogScl, y=dHighAnnoyProp,
                                                 colour=IntermitRatioC3MaxLRScl, shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
  
              scale_color_viridis(option='viridis', direction=1, discrete=FALSE, begin = 0.1, end = 0.8) +
  
              guides(colour=guide_legend(title="Intermit. ratio", reverse=TRUE)) +
  
              rescaleTicks(stimDataNoAmb$Detect0p1IntMaxLRLog, stimDataNoAmb$Detect0p1IntMaxLRLogScl, sep=1) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~lg~"("~italic(d~"'")[Sigma~",0.1s"]~")")),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p2 <- ggplot(data=model1predictDLxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=Detect0p1IntMaxLRLogScl, y=dHighAnnoyProp, colour=UASTonLdECMAPowAvgBin),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              rescaleTicks(stimDataNoAmb$Detect0p1IntMaxLRLog, stimDataNoAmb$Detect0p1IntMaxLRLogScl, sep=1) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~lg~"("~italic(d~"'")[Sigma~",0.1s"]~")")),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p3 <- ggplot(data=model1predictTnxIr) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title="Intermit. ratio", reverse=TRUE),
                     fill=guide_legend(title="Intermit. ratio", reverse=TRUE)) +
  
              ggnewscale::new_scale_color() +
              
              geom_point(data=stimDataNoAmb, aes(x=UASTonLdECMAPowAvgBin,
                                                 y=dHighAnnoyProp,
                                                 colour=IntermitRatioC3MaxLRScl),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8) +

              guides(colour=guide_legend(title="Intermit. ratio"), reverse=TRUE) +  
              labs(x=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p4 <- ggplot(data=model1predictSxTn) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +

              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
              
              scale_color_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='mako', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE),
                     fill=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              ggnewscale::new_scale_color() +
  
              geom_point(data=stimDataNoAmb, aes(x=UASSharpAurSHM05ExMaxLR, y=dHighAnnoyProp, colour=UASTonLdECMAPowAvgBin),
                         alpha=0.35, size=2) +
  
              scale_color_viridis(option='mako', direction=1, discrete=FALSE, begin = 0.1, end = 0.8,
                                  breaks=seq(0.5, 1.5, by=0.25)) +
  
              guides(colour=guide_legend(title=expression(paste(UAS~italic(T)[italic(N)]^"*"~","~sone[SHM])), reverse=TRUE)) +
              
              
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1),
                                 labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~italic(S)["5"]~acum[A~"|"~SHM])),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p5 <- ggplot(data=model1predictIr) +
              theme(panel.grid = element_blank(), aspect.ratio=1.35, text = element_text(family = "serif", size=16),
                    axis.text=element_text(family = "serif", size=14)) +
              
              geom_ribbon(aes(x=x, ymin=conf.low, ymax=conf.high, fill=group), alpha=0.05) +
              
              geom_line(aes(x=x, y=predicted, colour=group), alpha=0.5, linewidth=1) +
            
              geom_point(data=stimDataNoAmb, aes(x=IntermitRatioC3MaxLRScl, y=dHighAnnoyProp,
                                                 colour=factor(UASEvents), shape=factor(UASEvents)),
                         alpha=0.55, size=2) +
                
              scale_color_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_fill_viridis(option='viridis', direction=1, discrete=TRUE, begin = 0.1, end = 0.8) +
              scale_shape_manual(values=c(4, 5, 7, 8)) +
              
              guides(colour=guide_legend(title="UAS events", reverse=TRUE),
                     fill=guide_legend(title="UAS events", reverse=TRUE),
                     shape=guide_legend(title="UAS events", reverse=TRUE)) +
  
              rescaleTicks(stimDataNoAmb$IntermitRatioC3MaxLR, stimDataNoAmb$IntermitRatioC3MaxLRScl, sep=1) +
              scale_y_continuous(breaks=seq(0, 1, by=0.1), limits=c(0, 1), labels=seq(0, 100, by=10)) +
              
              labs(x=expression(paste(UAS~IR~","~"%")),
                   y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p1 + p2 + p3 + p4 + p5


```

### Model diagnostics

```{r}


mABdHSxTnDt1i2IrlgQSq.GEE.resD <- residuals(mABdHSxTnDt1i2IrlgQSq.GEE,
                                     type="deviance", plot.it=TRUE,
                                     pch=1, col=mycolours[1],identify=10)
mABdHSxTnDt1i2IrlgQSq.GEE.resM <- residuals(mABdHSxTnDt1i2IrlgQSq.GEE,
                                     type="mahalanobis", plot.it=TRUE,
                                     col=mycolours[2], identify=10)
mABdHSxTnDt1i2IrlgQSq.GEE.resP <- residuals(mABdHSxTnDt1i2IrlgQSq.GEE,
                                     type="pearson", plot.it=TRUE,
                                     pch=1, col=mycolours[3], identify=10)

hist(mABdHSxTnDt1i2IrlgQSq.GEE.resD, breaks=20, main="Deviance residuals")
hist(mABdHSxTnDt1i2IrlgQSq.GEE.resP, breaks=20, main="Pearson residuals")

par(mar = rep(2, 4))

mABdHSxTnDt1i2IrlgQSq.GEE.DfBc <- dfbeta(mABdHSxTnDt1i2IrlgQSq.GEE,
                                  level='clusters',
                                 coefs=c('Detect0p1IntMaxLRLogScl', 'UASTonLdECMAPowAvgBin'))
mABdHSxTnDt1i2IrlgQSq.GEE.DfBo <- dfbeta(mABdHSxTnDt1i2IrlgQSq.GEE,
                                level='observations',
                               coefs=c('Detect0p1IntMaxLRLogScl', 'UASTonLdECMAPowAvgBin'))

mABdHSxTnDt1i2IrlgQSq.GEE.Cook <- cooks.distance(mABdHSxTnDt1i2IrlgQSq.GEE,
                                          plot.it=TRUE)

performance::check_collinearity(mABdHSxTnDt1i2IrlgQSq.GEE)

```

## Comparison between GEE-PA and GLMM-SS models with LAE predictor

### Timing comparison

```{r}

set.seed(808)

newData <- data.frame(UASLAEMaxLRScl=seq(-12, 13, by=1), UASEvents=1,
                      TrialNumberCntScl=mean(subjDataNoAmb$TrialNumberCntScl))
# benchmark timing
testdHA <- microbenchmark::microbenchmark(
  
    'GLMM_model' = {model0GLMM <- lme4::glmer(dHighAnnoy ~ UASLAEMaxLRScl + I(UASEvents^-1)
                                              + TrialNumberCntScl +
                                                (1 + UASLAEMaxLRScl + I(UASEvents^-1) | ID.),
                                                  data=subjDataNoAmb, family=binomial(link='logit'),
                                              control=glmcontrol)},
    
    'GEE_model' = {model0GEE <- glmtoolbox::glmgee(dHighAnnoy ~ UASLAEMaxLRScl + I(UASEvents^-1)
                                              + TrialNumberCntScl,
                                                data=subjDataNoAmb, family=binomial(link='logit'),
                                                id=ID., corstr='exchangeable')},
    
    'GLMM_metrics' = {
                        PCP <- glmmPCP(model0GLMM)
                        cbind(performance::model_performance(model0GLMM,
                                                             metrics=c("AIC",
                                                                       "AICc",
                                                                       "BIC",
                                                                       "R2",
                                                                       "LOGLOSS")),
                                    PCP)
                        },
    
    'GEE_metrics' = {geeModelPerformance(model0GEE, verbose=TRUE)},
    
    'GLMM_prediction' = {model0GLMMpredict <- ggeffects::predict_response(model0GLMM,
                                                      terms=c("UASLAEMaxLRScl [all]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                       type='fixed', margin='marginalmeans',
                                                       bias_correction=TRUE)},
    
    'GEE_prediction' = {model0GEEpredict <- ggeffects::predict_response(model0GEE,
                                                      terms=c("UASLAEMaxLRScl [all]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                       type='fixed', margin='marginalmeans',
                                                      vcov=vcov(model0GEE, type="bias-corrected"))},
    times=10, unit='s', control=list(order='inorder'))

testdHA

glmmVsGEEdHA <- data.frame(model=summary(testdHA)[1,]$median/summary(testdHA)[2,]$median,
                          metrics=summary(testdHA)[3,]$median/summary(testdHA)[4,]$median,
                          pred=summary(testdHA)[5,]$median/summary(testdHA)[6,]$median,
                          total=sum(summary(testdHA)[1,]$median, summary(testdHA)[3,]$median, summary(testdHA)[5,]$median)/
                                sum(summary(testdHA)[2,]$median, summary(testdHA)[4,]$median, summary(testdHA)[6,]$median))

print(paste("Model:", glmmVsGEEdHA$model))
print(paste("Metrics:", glmmVsGEEdHA$metrics))
print(paste("Prediction:", glmmVsGEEdHA$pred))
print(paste("Total:", glmmVsGEEdHA$total))

microbenchmark:::autoplot.microbenchmark(testdHA)
microbenchmark:::boxplot.microbenchmark(testdHA)


```

### Plot comparison

```{r}

set.seed(808)

UASLAEMaxLRDummy <- seq(-12, 33, by=1) + (max(stimDataNoAmb$UASLAEMaxLR) -
                                            max(stimDataNoAmb$UASLAEMaxLRScl))

newData <- data.frame(UASLAEMaxLR=UASLAEMaxLRDummy,
                      UASLAEMaxLRScl=seq(-12, 33, by=1), UASEvents=1,
                      TrialNumberCntScl=0)

modelGLMM <- lme4::glmer(dHighAnnoy ~ UASLAEMaxLRScl + I(UASEvents^-1) +
                             TrialNumberCntScl +
                           (1 + UASLAEMaxLRScl | ID.),
                            data=subjDataNoAmb, family=binomial(link='logit'),
                         control=glmcontrol)

parameters::model_parameters(modelGLMM, exponentiate=TRUE)

PCP <- glmmPCP(modelGLMM)
print(cbind(performance::model_performance(modelGLMM,
                                           metrics=c("AIC", "AICc", "BIC",
                                                               "R2", "LOGLOSS")),
            PCP))


modelGEE <- glmtoolbox::glmgee(dHighAnnoy ~ UASLAEMaxLRScl + I(UASEvents^-1) +
                                              + TrialNumberCntScl,
                                  data=subjDataNoAmb, family=binomial(link='logit'),
                                  id=ID., corstr='exchangeable')

geeParams(modelGEE, ci=0.843, exponentiate=TRUE, varest='bias-corrected', verbose=FALSE)

geeModelPerformance(modelGEE)


mABdHLAE1_QSq.LAE1_Qpredict <- modelbased::estimate_prediction(modelGLMM,
                                                                data = newData,
                                                                predict = "expectation",
                                                                ci = 0.95,
                                                                transform = TRUE,
                                                                keep_iterations = FALSE,
                                                                ci_method='wald')

mABdHLAE1_QSq.LAE1_Qmarginal <- ggeffects::predict_response(modelGLMM,
                                                             terms=c("UASLAEMaxLRScl [-12:33]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                             type='fixed', margin='empirical',
                                                             bias_correction=TRUE)

mABdHLAE1_QSq.GEEpredict <- ggeffects::predict_response(modelGEE,
                                                      terms=c("UASLAEMaxLRScl [-12:33]",
                                                              "UASEvents [1]",
                                                              "TrialNumberCntScl [0]"),
                                                       type='fixed', margin='marginalmeans',
                                                      vcov=vcov(modelGEE, type="bias-corrected"))

mABdHLAE1_QSq.LAE1_QpredictAll <- ggeffects::predict_response(modelGLMM,
                                                          terms=c("UASLAEMaxLRScl [-12:33]",
                                                                  "ID. [all]",
                                                                  "UASEvents [1]",
                                                                  "TrialNumberCntScl [0]"),
                                                         type='response', margin='empirical',
                                                         bias_correction=TRUE)

p <- ggplot() +
  theme(panel.grid = element_blank(), aspect.ratio=1.35,
        text = element_text(family = "serif"),
        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"),
        axis.text=element_text(family = "serif", size=11))


for (id in unique(mABdHLAE1_QSq.LAE1_QpredictAll$group)){
  p <- p + geom_line(data=mABdHLAE1_QSq.LAE1_QpredictAll[mABdHLAE1_QSq.LAE1_QpredictAll$group==id,],
                     mapping=aes(x=x, y=predicted, colour="GLMM (CS)"),
                     alpha=0.1, linewidth=0.25)
}

p <- p +
  
    geom_ribbon(data=mABdHLAE1_QSq.LAE1_Qpredict,
                mapping=aes(x=UASLAEMaxLRScl, ymin=CI_low, ymax=CI_high,
                            colour="GLMM (CS)"),
                alpha=0.5, fill=NA, linetype=3, linewidth=0.55) +
    
    geom_ribbon(data=mABdHLAE1_QSq.GEEpredict,
                mapping=aes(x=x, ymin=conf.low, ymax=conf.high,
                            colour="GEE (PA)"),
                alpha=0.5, fill=NA, linetype=4, linewidth=0.55) +
    
    geom_line(data=mABdHLAE1_QSq.LAE1_Qpredict, mapping=aes(x=UASLAEMaxLRScl,
                                                            y=Predicted,
                                                        colour="GLMM (CS)"), linewidth=1) +
    
    geom_line(data=mABdHLAE1_QSq.GEEpredict, aes(x=x, y=predicted,
                                                colour="GEE (PA)"), linewidth=1) +
  
    geom_line(data=mABdHLAE1_QSq.LAE1_Qmarginal, mapping=aes(x=x,
                                                            y=predicted,
                                                        colour="GLMM (PA)"),
              linetype=2, linewidth=1, alpha=0.75) +
    
    scale_x_continuous(breaks=seq(-12, 33, by=5), labels=seq(55, 100, by=5)) +
    scale_y_continuous(breaks=seq(0, 1, by=0.1), labels=seq(0, 100, by=10), limits=c(0, 1)) +
    
    scale_colour_manual(values=c("GLMM (CS)"=mycolours[3],
                                 "GEE (PA)"=mycolours[4],
                                "GLMM (PA)"=mycolours[9]),
                        breaks=c("GLMM (PA)",
                                 "GEE (PA)",
                                 "GLMM (CS)")) +
    # scale_fill_manual(values=c("GLMM (CS)"=mycolours[3], "GEE (PA)"=mycolours[4])) +
  
    guides(colour=guide_legend(title="Method", reverse=TRUE),
           fill=guide_legend(title="Method", reverse=TRUE)) +
    
    labs(x=expression(paste(UAS~italic(L)[AE],",",~dB)),
         y=expression(paste("%"~Highly~annoyed~"|"~HA~"'"[amb])))

p

filename <- "PtsABdHighAnnoyGLMMVsGEE"

if (saveplots){
  ggsave(filename=paste(filename, ".svg", sep=""), width=4.5, height=4,
         path=file.path(outFigPath, "svg"))
  unlink(paste(filename, ".svg", sep=""))
  
  ggsave(filename=paste(filename, ".pdf", sep=""), width=4.5, height=4,
         path=file.path(outFigPath, "pdf"))
  unlink(paste(filename, ".pdf", sep=""))
}


```
