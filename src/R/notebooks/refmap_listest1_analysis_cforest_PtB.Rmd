---
title: "REFMAP Listening test 1 Part B analysis: Random forest variable importance identification (median responses)"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This notebook analyses the Part B data in terms of variable importance using a random forest model based on conditional inference trees and a conditional permutation variable importance algorithm.

# Setup

## Load packages

```{r}
# load packages
library(tidyr)
library(ggplot2)
library(party)
library(conflicted)
library(tidyverse)
library(openxlsx)
library(caret)
library(viridis)
library(cowplot)
# set package parameters
theme_set(theme_bw())

```

```{r}

# plot colour scheme

mycolourlist = list(c(0, 102, 255), c(0, 204, 153), c(255, 0, 102), c(74, 111, 152), c(251, 164, 49), c(204, 153, 255), c(90, 192, 255), c(80, 245, 233), c(255, 90, 192), c(164, 201, 242), c(255, 254, 139), c(255, 243, 255))
mycolours = matrix()

for (ii in 1:length(mycolourlist)){
  mycolours[ii] = rgb(mycolourlist[[ii]][1]/255,
                      mycolourlist[[ii]][2]/255,
                      mycolourlist[[ii]][3]/255)
}

# toggle to save plots
saveplots = TRUE

if (saveplots){
  # set output plot directory
  choose.files(caption="Just cancel this", filters=matrix(data=c(" ", " "), ncol=2))  # workaround for bug in RTerm choose.dir
  outFigPath <- utils::choose.dir(caption="Select output folder to save plots '03 Experiment\\Experiment 1\\Analysis\\Plots'")
  
  if (!dir.exists(file.path(outFigPath, "svg"))){dir.create(file.path(outFigPath, "svg"))}
  if (!dir.exists(file.path(outFigPath, "pdf"))){dir.create(file.path(outFigPath, "pdf"))}
  
}

# toggle to save data
savedata = TRUE

if (savedata){
  # set output plot directory
  if (saveplots==FALSE){
    choose.files(caption="Just cancel this", filters=matrix(data=c(" ", " "), ncol=2))  # workaround for bug in RTerm choose.dir
  }
  outDataPath <- utils::choose.dir(caption="Select output folder to save data '03 Experiment\\Experiment 1\\Analysis\\R'")
}
 

```

# Import data and wrangle

## Part B

```{r}

stimDataBpath <- utils::choose.files(caption=r"(Select refmap_listest1_testdataB_ByStim.csv from 03 Experiment\Experiment 1\Analysis\PostProcess)", filters=matrix(data=c("refmap_listest1_testdataB_ByStim.csv", "refmap_listest1_testdataB_ByStim.csv"), ncol=2))

stimDataB <- utils::read.csv(stimDataBpath, header=TRUE)
colnames(stimDataB)[1] <- "Stimulus"

# make response proportions into percentages
stimDataB[['HighAnnoyPc']] <- stimDataB[['HighAnnoyProp']]*100
stimDataB[['dHighAnnoyPc']] <- stimDataB[['dHighAnnoyProp']]*100

```

```{r}

# definition of ordinal variable levels
# SNRCatsB <- c("No UAS", "2", "8")
# UASLAeqCatsB <- c("No UAS", "54", "60")

```

```{r}

stimDataBNum <- data.frame()

stimDataBNum <- cbind(stimDataB[, 'Stimulus'],
                      stimDataB[, which(colnames(stimDataB)=="UASEvents"):
                                  which(colnames(stimDataB)=="UASEventPerMin")],
                      stimDataB[, which(colnames(stimDataB)=="UASLAeq"):
                                  which(colnames(stimDataB)=="SNRlevel")],
                      stimDataB[, "IntermitRatioMaxLR", drop=F],
                      stimDataB[, which(colnames(stimDataB)=="UASLAeqMaxLR"):
                                which(colnames(stimDataB)=="UASImpulsSHM05ExMaxLR")],
                      stimDataB[, which(colnames(stimDataB)=="LAeqLAF90diff"):
                                  which(colnames(stimDataB)=="dImpulsSHM05ExMaxLR")],
                      stimDataB[, which(colnames(stimDataB)=="ValenceMedian"):
                                  which(colnames(stimDataB)=="dHighAnnoyProp")],
                      stimDataB[, which(colnames(stimDataB)=="HighAnnoyPc"):
                                  which(colnames(stimDataB)=="dHighAnnoyPc")])
stimDataBNum <- stimDataBNum[, !(colnames(stimDataBNum) %in% c('UASLAeq', 'UASEventDensity'))]

colnames(stimDataBNum)[1] <- "Stimulus"

# make the discrete ordinal variables factors
stimDataBNum[['UASEvents']] <- factor(stimDataBNum[['UASEvents']], levels=c(0, 1, 3, 5, 9), order=TRUE)
stimDataBNum[['ValenceMedian']] <- factor(stimDataBNum[['ValenceMedian']], levels=c(1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5), order=TRUE)
stimDataBNum[['ArousalMedian']] <- factor(stimDataBNum[['ArousalMedian']], levels=c(1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5), order=TRUE)
stimDataBNum[['AnnoyMedian']] <- factor(stimDataBNum[['AnnoyMedian']], levels=c(0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5,
                                                                                5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10), order=TRUE)
stimDataBNum[['dValenceMedian']] <- factor(stimDataBNum[['dValenceMedian']], levels=c(-4, -3.5, -3, -2.5, -2, -1.5, -1, -0.5, 0,
                                                                                      0.5, 1, 1.5, 2, 2.5, 3, 3.5,  4), order=TRUE)
stimDataBNum[['dArousalMedian']] <- factor(stimDataBNum[['dArousalMedian']], levels=c(-4, -3.5, -3, -2.5, -2, -1.5, -1, -0.5, 0,
                                                                                      0.5, 1, 1.5, 2, 2.5, 3, 3.5,  4), order=TRUE)
stimDataBNum[['dAnnoyMedian']] <- factor(stimDataBNum[['dAnnoyMedian']], levels=c(-10, -9.5, -9, -8.5, -8, -7.5, -7, -6.5, -6, -5.5, -5,
                                                                                  -4.5, -4, -3.5, -3, -2.5, -2, -1.5, -1, -0.5,
                                                                                 0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5,
                                                                                 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10), order=TRUE)

# omit ambient-only stimuli
stimDataBNum <- stimDataBNum |> dplyr::filter(UASLAeq != "No UAS")

stimDataBNum$SNRlevel <- as.numeric(stimDataBNum$SNRlevel)

```

# Random forest functions

Write a function to train a conditional-inference random forest (crf) model on input data according to input formula, iterate over input random seeds, average error and variable importance metrics, and output metrics with plotted

## Averaging over multiple random seeds

```{r}

multi_crfReg <- function(dataIn, iVars, dVar, seeds, ntree, mtry, permImpCondThres=0.95, minsplit=20, minbucket=7, nperm=1){
  # initialise variables
  crfOOBErrAll <- 0
  crfOOBRMSE <- 0
  crfOOBMAE <- 0
  crfOOBErrR2 <- 0
  crfMarPermImpVals <- 0
  crfConPermImpVals <- 0
  crfMarPermImpValsPerTree <- data.frame()
  crfConPermImpValsPerTree <- data.frame()
  
  for (iters in 1:length(seeds)){
    
    # formula for regression
    formVars <- reformulate(iVars, dVar)
    
    # set random seed
    set.seed(seeds[iters])
    # train crf model
    crfModel <- party::cforest(formVars, data=dataIn,
                               controls=party::cforest_unbiased(ntree=ntree,
                                                                mtry=mtry,
                                                                minsplit=minsplit,
                                                                minbucket=minbucket))
    
    # get OOB predictions
    crfModelOOB <- predict(crfModel, OOB=TRUE, type='response')
    
    # get OOB error
    crfModelOOBErr <- as.numeric(as.matrix(as.numeric(as.matrix(crfModelOOB))
                                            - as.numeric(as.matrix(crfModel@data@env$response[[names(crfModel@data@env$response)]]))))

    # OOB RMSE, error quartiles and Rsquared
    crfOOBRMSE <- crfOOBRMSE + sqrt(mean(crfModelOOBErr^2))
    crfOOBMAE <- crfOOBMAE + mean(abs(crfModelOOBErr))
    crfOOBErrR2 <- crfOOBErrR2 + cor(as.numeric(as.matrix(crfModelOOB)),
                                     as.numeric(as.matrix(crfModel@data@env$response[[names(crfModel@data@env$response)]])))^2

    # set random seed
    set.seed(seeds[iters])

    # set random seed
    set.seed(seeds[iters])
    # conditional variable permutation importance
    crfConPermImp <- permimp::permimp(crfModel, nperm=nperm, conditional=TRUE, threshold=permImpCondThres, progressBar=FALSE)
    
    crfConPermImpVals <- crfConPermImpVals + crfConPermImp$values
    crfConPermImpValsPerTree <- rbind(crfConPermImpValsPerTree, crfConPermImp$perTree)
  }
  
  # average metrics
  crfOOBErrAll <- crfOOBErrAll/length(seeds)
  crfOOBRMSE <- crfOOBRMSE/length(seeds)
  crfOOBMAE <- crfOOBMAE/length(seeds)
  crfOOBErrR2 <- crfOOBErrR2/length(seeds)
  crfConPermImpVals <- data.frame(CondPermImp=sort(crfConPermImpVals/length(seeds), decreasing=TRUE))
  #crfConPermImpValsMn <- sort(colMeans(crfConPermImpValsPerTree), decreasing=TRUE)  # mean of conditional variable importance values per tree (same as crfConPermImpVals)
  crfConPermImpValsQtl <- data.frame(apply(crfConPermImpValsPerTree, 2, quantile, probs=c(0.25, 0.50, 0.75)))
  
  resultsOut <- list('OOB_RMSE'=crfOOBRMSE, 'OOB_MAE'=crfOOBMAE, 'Rsquared'=crfOOBErrR2, 'conditional_permimp'=crfConPermImpVals,                      'conditional_permimp_perTree'=crfConPermImpValsPerTree, 'conditional_permimp_qtl'=crfConPermImpValsQtl)
  return(resultsOut)
}

```

## Comparing rankings from two seeds 

```{r}

crfReg <- function(dataIn, iVars, dVar, seeds, ntree, mtry, permImpCondThres=0.95, minsplit=20, minbucket=7, nperm=1){
  # initialise variables
  crfOOBErrAll <- 0
  crfOOBRMSE <- 0
  crfOOBMAE <- 0
  crfOOBErrR2 <- 0
  crfMarPermImpVals <- 0
  crfConPermImpVals <- 0
  crfMarPermImpValsPerTree <- data.frame()
  crfConPermImpValsPerTree <- data.frame()

  # formula for regression
  formVars <- reformulate(iVars, dVar)
  
  for (iters in 1:length(seeds)){
  
    # set random seed
    set.seed(seeds[iters])
    # train crf model
    crfModel <- party::cforest(formVars, data=dataIn,
                               controls=party::cforest_unbiased(ntree=ntree,
                                                                mtry=mtry,
                                                                minsplit=minsplit,
                                                                minbucket=minbucket))
    
    # conditional variable permutation importance
    crfConPermImp <- permimp::permimp(crfModel, nperm=nperm, conditional=TRUE, threshold=permImpCondThres, progressBar=FALSE)
    
    crfConPermImpVals <- crfConPermImp$values
    
    if (iters == 1){
      crfConPermImpVals1 <- data.frame(CondPermImp=sort(crfConPermImpVals, decreasing=TRUE))
      crfConPermImpValsPerTree1 <- crfConPermImp$perTree
      crfConPermImpValsQtl1 <- data.frame(apply(crfConPermImpValsPerTree1, 2, quantile, probs=c(0.25, 0.50, 0.75)))
      
      # get OOB predictions
      crfModelOOB <- predict(crfModel, OOB=TRUE, type='response')
      
      # get OOB error
      crfModelOOBErr <- as.numeric(as.matrix(as.numeric(as.matrix(crfModelOOB))
                                              - as.numeric(as.matrix(crfModel@data@env$response[[names(crfModel@data@env$response)]]))))
      
      # OOB RMSE, error quartiles and Rsquared
      crfOOBRMSE <- sqrt(mean(crfModelOOBErr^2))
      crfOOBMAE <- crfOOBMAE + mean(abs(crfModelOOBErr))
      crfOOBErrR2 <- cor(as.numeric(as.matrix(crfModelOOB)),
                                    as.numeric(as.matrix(crfModel@data@env$response[[names(crfModel@data@env$response)]])))^2

      }
    
    else{
      crfConPermImpValsN <- data.frame(CondPermImp=sort(crfConPermImpVals, decreasing=TRUE))
      
      nVarImpChecks <- min(max(sum(crfConPermImpVals1 >= crfConPermImpVals1$CondPermImp[1]*0.1),
                               sum(crfConPermImpValsN >= crfConPermImpValsN$CondPermImp[1]*0.1)), 4)  # number of variable importance values with a value at least 10% of the highest importance
      if (sum(rownames(crfConPermImpVals1)[1:nVarImpChecks] != rownames(crfConPermImpValsN)[1:nVarImpChecks]) > 0){
        warning("Permutation importance rank order within 10% of max differs between seeds: increase number of trees ('ntree') or number of permutations ('nperm'), or subsample of features ('mtry')")
      }
      else{
        resultsOut <- list('OOB_errors'=crfModelOOBErr, 'OOB_RMSE'=crfOOBRMSE, 'OOB_MAE'=crfOOBMAE, 'Rsquared'=crfOOBErrR2, 'conditional_permimp'=crfConPermImpVals1, 'conditional_permimp_perTree'=crfConPermImpValsPerTree1, 'conditional_permpimp_qtl'=crfConPermImpValsQtl1)
        return(resultsOut)
      }
      
    }
    
  }

}

```

## Hyperparameter tuning

```{r, fig.width=12, fig.height=4}
mtryTune <- function(dataIn, iVars, dVar, seeds, ntrees, minsplit=20, minbucket=7){

  formVars <- reformulate(iVars, dVar)
  
  # set mtry values and corresponding iVars/mtry ratios
  iVars_mtrys <- c(10.5, 5.25, 3.5, 2.75, 2.25, 1.75, 1.5, 1.25)
  mtrys <- as.integer(length(iVars)/iVars_mtrys)
  iVars_mtrys <- iVars_mtrys[mtrys >= 2]  # remove 0 or 1 values
  mtrys <- mtrys[mtrys >= 2]  # remove 0 or 1 values
  
  # remove any duplicated values
  iVars_mtrys <- iVars_mtrys[!(duplicated(mtrys) | duplicated(mtrys, fromLast = TRUE))]
  mtrys <- mtrys[!(duplicated(mtrys) | duplicated(mtrys, fromLast = TRUE))]

  # ensure mtrys is less than length(iVars)
  iVars_mtrys <- iVars_mtrys[mtrys < length(iVars)]
  mtrys <- mtrys[mtrys < length(iVars)]

  resRMSEMap = matrix(data=0, nrow=length(mtrys), ncol=length(ntrees))
  resRsquaredMap = matrix(data=0, nrow=length(mtrys), ncol=length(ntrees))
  resMAEMap = matrix(data=0, nrow=length(mtrys), ncol=length(ntrees))
  
  
  for (ii in seq(1, length(ntrees))){
    
    tuneMod.results <- data.frame(RMSE=numeric(length(mtrys)),
                                Rsquared=numeric(length(mtrys)),
                                MAE=numeric(length(mtrys)))
    
    for (seed in seeds){
      set.seed(seed)
      ntree = ntrees[ii]
      tuneMod <- caret::train(formVars,
                              data=dataIn,
                              method='cforest',
                              controls=party::cforest_unbiased(ntree=ntree,
                                                               minsplit=minsplit,
                                                               minbucket=minbucket),
                              tuneGrid=data.frame(.mtry=mtrys),
                              trControl = trainControl(method = "oob"))
      
      
      
      # accumulate results
      resRMSEMap[, ii] <- resRMSEMap[, ii] + tuneMod$results$RMSE
      resRsquaredMap[, ii] <- resRsquaredMap[, ii] + tuneMod$results$Rsquared
      resMAEMap[, ii] <- resMAEMap[, ii] + tuneMod$results$MAE
      
      tuneMod.results <- tuneMod.results + tuneMod$results[, which(names(tuneMod$results) != 'mtry')]
    }

    # average results
    tuneMod.results <- tuneMod.results/length(seeds)
    tuneMod.results <- cbind(tuneMod.results, data.frame(mtry=mtrys), data.frame(iVars_mtry=iVars_mtrys))

    print(tuneMod.results)

  }
  
  # average results
  resRMSEMap <- resRMSEMap/length(seeds)
  resRsquaredMap <- resRsquaredMap/length(seeds)
  resMAEMap <- resMAEMap/length(seeds)
  
  
  # convert to data frames with mtry as row names and ntree as column names, and convert to long format using tidyverse
  resdfRMSEMap <- as.data.frame(resRMSEMap)
  rownames(resdfRMSEMap) <- mtrys
  colnames(resdfRMSEMap) <- ntrees
  resdfRsquaredMap <- as.data.frame(resRsquaredMap)
  rownames(resdfRsquaredMap) <- mtrys
  colnames(resdfRsquaredMap) <- ntrees
  resdfMAEMap <- as.data.frame(resMAEMap)
  rownames(resdfMAEMap) <- mtrys
  colnames(resdfMAEMap) <- ntrees
  
  
  # convert dataframes to long format using tidyverse
  resdfRMSEMap <- resdfRMSEMap |>
                      rownames_to_column('mtry') |>
                          gather(key='ntree', value='RMSE', -mtry)
  
  resdfRsquaredMap <- resdfRsquaredMap |>
                          rownames_to_column('mtry') |>
                              gather(key='ntree', value='Rsquared', -mtry)
  
  resdfMAEMap <- resdfMAEMap |>
                    rownames_to_column('mtry') |>
                        gather(key='ntree', value='MAE', -mtry)
  
  # ensure ntree and mtry columns are ordered factors
  resdfRMSEMap$ntree <- factor(resdfRMSEMap$ntree, levels=as.character(ntrees))
  resdfRMSEMap$mtry <- factor(resdfRMSEMap$mtry, levels=as.character(mtrys))
  
  resdfRsquaredMap$ntree <- factor(resdfRsquaredMap$ntree, levels=as.character(ntrees))
  resdfRsquaredMap$mtry <- factor(resdfRsquaredMap$mtry, levels=as.character(mtrys))
  
  resdfMAEMap$ntree <- factor(resdfMAEMap$ntree, levels=as.character(ntrees))
  resdfMAEMap$mtry <- factor(resdfMAEMap$mtry, levels=as.character(mtrys))
  
  # plot heatmaps using ggplot, with extreme (min or max) value plotted as overlaid point using annotate and colourbar scale reversed
  pHeatmapRMSE <- ggplot(resdfRMSEMap) +
                    geom_tile(aes(x=ntree, y=mtry, fill=RMSE)) +
                        scale_fill_viridis(option="viridis", direction=-1) +
                          geom_point(data=resdfRMSEMap[which(resdfRMSEMap$RMSE
                                                             == min(resdfRMSEMap$RMSE),
                                                             arr.ind = TRUE),],
                                     aes(x=ntree, y=mtry), colour="red", size=2) +
                            guides(colour = guide_colourbar(reverse=TRUE)) +
                              labs(x="ntree", y="mtry", fill="RMSE") +
                                theme(text = element_text(family = "serif"))
  
  pHeatmapRsquared <- ggplot(resdfRsquaredMap) +
                        geom_tile(aes(x=ntree, y=mtry, fill=Rsquared)) +
                            scale_fill_viridis(option="viridis", direction=1) +
                              geom_point(data=resdfRsquaredMap[which(resdfRsquaredMap$Rsquared
                                                                     == max(resdfRsquaredMap$Rsquared),
                                                                     arr.ind = TRUE),],
                                         aes(x=ntree, y=mtry), colour="red", size=2) +
                                guides(colour = guide_colourbar(reverse=TRUE)) +
                                  labs(x="ntree", y="mtry", fill="Rsquared") +
                                    theme(text = element_text(family = "serif"))
  
  pHeatmapMAE <- ggplot(resdfMAEMap) +
                    geom_tile(aes(x=ntree, y=mtry, fill=MAE)) +
                        scale_fill_viridis(option="viridis", direction=-1) +
                          geom_point(data=resdfMAEMap[which(resdfMAEMap$MAE
                                                            == min(resdfMAEMap$MAE),
                                                            arr.ind = TRUE),],
                                     aes(x=ntree, y=mtry), colour="red", size=2) +
                            guides(colour = guide_colourbar(reverse=TRUE)) +
                              labs(x="ntree", y="mtry", fill="MAE") +
                                theme(text = element_text(family = "serif"))
  
  p <-  cowplot::plot_grid(pHeatmapRMSE,
                           pHeatmapRsquared,
                           pHeatmapMAE,
                           ncol=3, nrow=1)
  
  return(p)
  
}  # end of function

```


# Part B analysis


## Set global parameters

```{r}

permImpCondThres <- 0.95
minsplit <- 10
minbucket <- 5
ntrees <- c(251, 501, 1001, 1501, 2501, 4001, 5501)

eventVar <- "UASEventPerMin"

```

## Mean change in annoyance

Initialise results output variables

```{r}
resdAnnoyMnFitB <- data.frame(RMSE = numeric(),
                             MAE = numeric(),
                             Rsquared = numeric())
resdAnnoyMnPermImpB <- list()

```


### All variables (absolute and difference)

#### Set variables

```{r}

iVars <- names(stimDataBNum)[which(names(stimDataBNum) == 'UASEvents'):which(names(stimDataBNum) == 'UASImpulsSHM05ExMaxLR')]
iVars <- iVars[! iVars %in% c('AmbientLAeq')]
iVars <- c(iVars,
           names(stimDataBNum)[which(colnames(stimDataBNum)=="LAeqLAF90diff"):
                               which(colnames(stimDataBNum)=="dImpulsSHM05ExMaxLR")], "SNRlevel")
dVar <- "dAnnoyMean"

seeds <- c(14569, 98651, 54654498, 454948, 41321)

```

#### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
              ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAllVarsHyperTune.svg", width=12, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAllVarsHyperTune.svg")

  ggsave(filename="PtBdAnnoyMnAllVarsHyperTune.pdf", width=12, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAllVarsHyperTune.pdf")
}

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.75)

```

#### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutAbsDiffs <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbsDiffs$OOB_RMSE
resultsOutAbsDiffs$OOB_MAE
resultsOutAbsDiffs$Rsquared

```

Train multiple seeds model

```{r}

resultsOutAbsDiffs <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbsDiffs$OOB_RMSE
resultsOutAbsDiffs$OOB_MAE
resultsOutAbsDiffs$Rsquared
```

```{r}
# store results
resdAnnoyMnFitB['All vars', 'RMSE'] <- resultsOutAbsDiffs$OOB_RMSE
resdAnnoyMnFitB['All vars', 'MAE'] <- resultsOutAbsDiffs$OOB_MAE
resdAnnoyMnFitB['All vars', 'Rsquared'] <- resultsOutAbsDiffs$Rsquared
resdAnnoyMnPermImpB$AllVars <- resultsOutAbsDiffs$conditional_permimp

```

#### Plot results

```{r, fig.width=8,fig.height=20}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutAbsDiffs.conimp <- arrange(resultsOutAbsDiffs$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutAbsDiffs.conimp) + geom_col(aes(x=factor(rownames(resultsOutAbsDiffs.conimp), levels=rownames(resultsOutAbsDiffs.conimp)), y=CondPermImp), fill=mycolours[9], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAllVarsConPermimp.svg", width=8, height=20, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAllVarsConPermimp.svg")

  ggsave(filename="PtBdAnnoyMnAllVarsConPermimp.pdf", width=8, height=20, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAllVarsConPermimp.pdf")
}

```

```{r, fig.width=8,fig.height=6}

# Plot only positive values

resultsOutAbsDiffs.conimpPtv <- resultsOutAbsDiffs.conimp |>
                                          rownames_to_column('Metric') |>
                                                filter_if(is.numeric, all_vars(. > 0)) |>
                                                      column_to_rownames('Metric')

pBar <- ggplot(resultsOutAbsDiffs.conimpPtv) + geom_col(aes(x=factor(rownames(resultsOutAbsDiffs.conimpPtv), levels=rownames(resultsOutAbsDiffs.conimpPtv)), y=CondPermImp), fill=mycolours[9], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAllVarsConPermimpPtv.svg", width=8, height=6, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAllVarsConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnAllVarsConPermimpPtv.pdf", width=8, height=6, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAllVarsConPermimp.pdf")
}

```

```{r, fig.width=8,fig.height=4}

# Plot only values within 1% of the maximum value

resultsOutAbsDiffs.conimp1pc <- resultsOutAbsDiffs.conimp |>
                                          rownames_to_column('Metric') |>
                                                filter_if(is.numeric, all_vars(. > max(resultsOutAbsDiffs.conimp)/100)) |>
                                                      column_to_rownames('Metric')

pBar <- ggplot(resultsOutAbsDiffs.conimp1pc) + geom_col(aes(x=factor(rownames(resultsOutAbsDiffs.conimp1pc), levels=rownames(resultsOutAbsDiffs.conimp1pc)), y=CondPermImp), fill=mycolours[9], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAllVarsConPermimp1pc.svg", width=8, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAllVarsConPermimp1pc.svg")
  
  ggsave(filename="PtBdAnnoyMnAllVarsConPermimp1pc.pdf", width=8, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAllVarsConPermimp1pc.pdf")
}

```

### Absolute variables

#### Set variables

```{r}

iVars <- names(stimDataBNum)[which(names(stimDataBNum) == 'UASEvents'):which(names(stimDataBNum) == 'UASImpulsSHM05ExMaxLR')]
iVars <- iVars[! iVars %in% c('SNRlevel', 'AmbientLAeq')]
dVar <- "dAnnoyMean"

seeds <- c(578312, 544, 84894, 54654, 153157)

```

#### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
              ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAbsVarsHyperTune.svg", width=12, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAbsVarsHyperTune.svg")

  ggsave(filename="PtBdAnnoyMnAbsVarsHyperTune.pdf", width=12, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAbsVarsHyperTune.pdf")
}

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.75)

```

#### Run model

Train preliminary model

```{r}

nperm <- 10

resultsOutAbs <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbs$OOB_RMSE
resultsOutAbs$OOB_MAE
resultsOutAbs$Rsquared

```
Train multiple seeds model

```{r}

resultsOutAbs <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbs$OOB_RMSE
resultsOutAbs$OOB_MAE
resultsOutAbs$Rsquared

```


```{r}

# store results
resdAnnoyMnFitB['Abs vars', 'RMSE'] <- resultsOutAbs$OOB_RMSE
resdAnnoyMnFitB['Abs vars', 'MAE'] <- resultsOutAbs$OOB_MAE
resdAnnoyMnFitB['Abs vars', 'Rsquared'] <- resultsOutAbs$Rsquared
resdAnnoyMnPermImpB$AbsVars <- resultsOutAbs$conditional_permimp

```

#### Plot results

```{r, fig.width=8,fig.height=11.5}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutAbs.conimp <- arrange(resultsOutAbs$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutAbs.conimp) + geom_col(aes(x=factor(rownames(resultsOutAbs.conimp), levels=rownames(resultsOutAbs.conimp)), y=CondPermImp), fill=mycolours[1], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) +
  coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAbsVarsConPermimp.svg", width=8, height=11.5, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAbsVarsConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnAbsVarsConPermimp.pdf", width=8, height=11.5, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAbsVarsConPermimp.pdf")
}
```

```{r, fig.width=8,fig.height=5}

# Plot only positive values

resultsOutAbs.conimpPtv <- resultsOutAbs.conimp |>
                                          rownames_to_column('Metric') |>
                                                filter_if(is.numeric, all_vars(. > 0)) |>
                                                      column_to_rownames('Metric')

pBar <- ggplot(resultsOutAbs.conimpPtv) + geom_col(aes(x=factor(rownames(resultsOutAbs.conimpPtv), levels=rownames(resultsOutAbs.conimpPtv)), y=CondPermImp), fill=mycolours[1], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAbsVarsConPermimpPtv.svg", width=8, height=5, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAbsVarsConPermimpPtv.svg")
  
  ggsave(filename="PtBdAnnoyMnAbsVarsConPermimpPtv.pdf", width=8, height=5, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAbsVarsConPermimpPtv.pdf")
}

```

Selected metric

```{r}

absVar <- "UASLoudECMAPowAvgBin"

```


### SQM analysis

#### Individual SQMs

##### Sharpness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, "UASSharpAurISO3PowAvgMaxLR", "UASSharpAurISO305ExMaxLR", "UASSharpAurSHMPowAvgMaxLR", "UASSharpAurSHM05ExMaxLR", "UASSharpAurISO1PowAvgMaxLR", "UASSharpAurISO105ExMaxLR", "UASSharpvBISO1PowAvgMaxLR", "UASSharpvBISO105ExMaxLR", "UASSharpDINPowAvgMaxLR", "UASSharpDIN05ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(7041, 905, 4984651, 6513213, 120651)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 5501
mtry <- as.integer(length(iVars)/2.25)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSharp <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSharp <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```


```{r}
# store results
resdAnnoyMnFitB['Abs sharp', 'RMSE'] <- resultsOutSharp$OOB_RMSE
resdAnnoyMnFitB['Abs sharp', 'MAE'] <- resultsOutSharp$OOB_MAE
resdAnnoyMnFitB['Abs sharp', 'Rsquared'] <- resultsOutSharp$Rsquared
resdAnnoyMnPermImpB$AbsSharp <- resultsOutSharp$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=4.9}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSharp.conimp <- arrange(resultsOutSharp$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSharp.conimp) + geom_col(aes(x=factor(rownames(resultsOutSharp.conimp), levels=rownames(resultsOutSharp.conimp)), y=CondPermImp), fill=mycolours[2], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("Sharpness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnSharpConPermimp.svg", width=8, height=4.9, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnSharpConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnSharpConPermimp.pdf", width=8, height=4.9, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnSharpConPermimp.pdf")
}


```

Selected metric

```{r}

sharpVar <- "UASSharpDIN05ExMaxLR"

```

##### Tonal loudness and tonality

###### Set variables

```{r}

iVars <- c(absVar, eventVar, "UASTonalECMAAvgMaxLR", "UASTonalSHMInt05ExMaxLR", "UASTonalSHMIntAvgMaxLR", "UASTonalECMA05ExMaxLR", "UASTonLdECMAPowAvgBin", "UASTonLdECMA05ExBin", "UASTonalAurAvgMaxLR", "UASTonalAur05ExMaxLR", "UASTonalAur10ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(540, 104798, 456464, 87331, 94564)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.25)

```

###### Run model

Train preliminary model

```{r}
# Tonality with tonal loudness

nperm <- 5

resultsOutTonal1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared
```

Train multiple seeds model

```{r}
# Tonality with tonal loudness

resultsOutTonal1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared

```

```{r}
# store results
resdAnnoyMnFitB['Abs tonal inc loud', 'RMSE'] <- resultsOutTonal1$OOB_RMSE
resdAnnoyMnFitB['Abs tonal inc loud', 'MAE'] <- resultsOutTonal1$OOB_MAE
resdAnnoyMnFitB['Abs tonal inc loud', 'Rsquared'] <- resultsOutTonal1$Rsquared
resdAnnoyMnPermImpB$AbsTonal1 <- resultsOutTonal1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=3.8}

par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal1.conimp <- arrange(resultsOutTonal1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal1.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal1.conimp), levels=rownames(resultsOutTonal1.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("Tonality inc. tonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.5))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnTonalLdConPermimp.svg", width=8, height=3.8, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnTonalLdConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnTonalLdConPermimp.pdf", width=8, height=3.8, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnTonalLdConPermimp.pdf")
}

```

Selected metric

```{r}

tonLdVar <- "UASTonLdECMAPowAvgBin"

```

##### Tonality without tonal loudness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, "UASTonalECMAAvgMaxLR", "UASTonalSHMInt05ExMaxLR", "UASTonalSHMIntAvgMaxLR", "UASTonalECMA05ExMaxLR", "UASTonalAurAvgMaxLR", "UASTonalAur05ExMaxLR", "UASTonalAur10ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(156089, 5860, 10528, 89541, 4685146)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 1501
mtry <- as.integer(length(iVars)/1.25)

```

###### Run model

Train preliminary model

```{r}
# Tonality

nperm <- 5

resultsOutTonal2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```

Train multiple seeds model

```{r}
# Tonality

resultsOutTonal2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```


```{r}

# store results
resdAnnoyMnFitB['Abs tonal no loud', 'RMSE'] <- resultsOutTonal2$OOB_RMSE
resdAnnoyMnFitB['Abs tonal no loud', 'MAE'] <- resultsOutTonal2$OOB_MAE
resdAnnoyMnFitB['Abs tonal no loud', 'Rsquared'] <- resultsOutTonal2$Rsquared
resdAnnoyMnPermImpB$AbsTonal2 <- resultsOutTonal2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=3.2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal2.conimp <- arrange(resultsOutTonal2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal2.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal2.conimp), levels=rownames(resultsOutTonal2.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("Tonality w/o tonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.5))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnTonalConPermimp.svg", width=8, height=3.2, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnTonalConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnTonalConPermimp.pdf", width=8, height=3.2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnTonalConPermimp.pdf")
}


```

Selected metric

```{r}

tonalVar <- "UASTonalAurAvgMaxLR"

```

##### Fluctuation strength

###### Set variables

```{r}

# Fluctuation strength
iVars <- c(absVar, eventVar, "UASFluctSHM10ExBin", "UASFluctSHM05ExBin", "UASFluctFZ10ExMaxLR", "UASFluctFZ05ExMaxLR", "UASFluctOV10ExMaxLR", "UASFluctOV05ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(25107, 546098, 195, 5937, 102658)

```


###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutFluct <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```

Train multiple seeds model

```{r}

resultsOutFluct <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```


```{r}

# store results
resdAnnoyMnFitB['Abs fluct', 'RMSE'] <- resultsOutFluct$OOB_RMSE
resdAnnoyMnFitB['Abs fluct', 'MAE'] <- resultsOutFluct$OOB_MAE
resdAnnoyMnFitB['Abs fluct', 'Rsquared'] <- resultsOutFluct$Rsquared
resdAnnoyMnPermImpB$AbsFluct <- resultsOutFluct$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.9}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutFluct.conimp <- arrange(resultsOutFluct$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutFluct.conimp) + geom_col(aes(x=factor(rownames(resultsOutFluct.conimp), levels=rownames(resultsOutFluct.conimp)), y=CondPermImp), fill=mycolours[4], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("Fluctuation strength") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnFluctConPermimp.svg", width=8, height=2.9, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnFluctConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnFluctConPermimp.pdf", width=8, height=2.9, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnFluctConPermimp.pdf")
}

```

Selected metric

```{r}

fluctVar <- "UASFluctOV10ExMaxLR"

```

##### Roughness

###### Set variables

```{r}

# Roughness
iVars <- c(absVar, eventVar, "UASRoughECMA10ExBin", "UASRoughECMA05ExBin", "UASRoughFZ10ExMaxLR", "UASRoughFZ05ExMaxLR", "UASRoughDW10ExMaxLR", "UASRoughDW05ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(4701, 52187, 16589, 65217, 16893)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 5501
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutRough <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

Train multiple seeds model

```{r}

resultsOutRough <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

```{r}
# store results
resdAnnoyMnFitB['Abs rough', 'RMSE'] <- resultsOutRough$OOB_RMSE
resdAnnoyMnFitB['Abs rough', 'MAE'] <- resultsOutRough$OOB_MAE
resdAnnoyMnFitB['Abs rough', 'Rsquared'] <- resultsOutRough$Rsquared
resdAnnoyMnPermImpB$AbsRough <- resultsOutRough$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.9}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutRough.conimp <- arrange(resultsOutRough$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutRough.conimp) + geom_col(aes(x=factor(rownames(resultsOutRough.conimp), levels=rownames(resultsOutRough.conimp)), y=CondPermImp), fill=mycolours[5], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("Roughness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnRoughConPermimp.svg", width=8, height=2.9, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnRoughConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnRoughConPermimp.pdf", width=8, height=2.9, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnRoughConPermimp.pdf")
}


```

Selected metric

```{r}

roughVar <- "UASRoughFZ05ExMaxLR"

```

##### Impulsiveness

###### Set variables

```{r}
# Impulsiveness
iVars <- c(absVar, eventVar, "UASImpulsSHMAvgMaxLR", "UASImpulsSHM05ExMaxLR", "UASImpulsSHMPowAvgMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(8495, 59867, 5416, 9843, 86)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.25)

```


###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutImpuls <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

Train multiple seeds model

```{r}

resultsOutImpuls <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

```{r}

# store results
resdAnnoyMnFitB['Abs impuls', 'RMSE'] <- resultsOutImpuls$OOB_RMSE
resdAnnoyMnFitB['Abs impuls', 'MAE'] <- resultsOutImpuls$OOB_MAE
resdAnnoyMnFitB['Abs impuls', 'Rsquared'] <- resultsOutImpuls$Rsquared
resdAnnoyMnPermImpB$AbsImpuls <- resultsOutImpuls$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutImpuls.conimp <- arrange(resultsOutImpuls$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutImpuls.conimp) + geom_col(aes(x=factor(rownames(resultsOutImpuls.conimp), levels=rownames(resultsOutImpuls.conimp)), y=CondPermImp), fill=mycolours[6], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("Impulsiveness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnImpulsConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnImpulsConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnImpulsConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnImpulsConPermimp.pdf")
}

```

Selected metric

```{r}

impulsVar <- "UASImpulsSHMAvgMaxLR"

```

#### SQM and loudness comparison

Now the highest importance SQMs are ranked against each other, controlling for UAS loudness and ambient LAeq.

##### Include tonal loudness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, sharpVar, tonLdVar, fluctVar, roughVar, impulsVar)
dVar <- "dAnnoyMean"

seeds <- c(70498, 4, 14986, 453, 864)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.25)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

```{r}

# store results
resdAnnoyMnFitB['Abs SQMs inc tonal loud', 'RMSE'] <- resultsOutSQMs1$OOB_RMSE
resdAnnoyMnFitB['Abs SQMs inc tonal loud', 'MAE'] <- resultsOutSQMs1$OOB_MAE
resdAnnoyMnFitB['Abs SQMs inc tonal loud', 'Rsquared'] <- resultsOutSQMs1$Rsquared
resdAnnoyMnPermImpB$AbsSQMs1 <- resultsOutSQMs1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs1.conimp <- arrange(resultsOutSQMs1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs1.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs1.conimp), levels=rownames(resultsOutSQMs1.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.5))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAbsSQMsTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAbsSQMsTonLdConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnAbsSQMsTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAbsSQMsTonLdConPermimp.pdf")
}

```

##### Exclude tonal loudness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, sharpVar, tonalVar, fluctVar, roughVar, impulsVar)
dVar <- "dAnnoyMean"

seeds <- c(546, 57203, 270835, 60592, 8094)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 5501
mtry <- as.integer(length(iVars)/2.25)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

```{r}

# store results
resdAnnoyMnFitB['Abs SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_RMSE
resdAnnoyMnFitB['Abs SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_MAE
resdAnnoyMnFitB['Abs SQMs no tonal loud', 'Rsquared'] <- resultsOutSQMs2$Rsquared
resdAnnoyMnPermImpB$AbsSQMs2 <- resultsOutSQMs2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs2.conimp <- arrange(resultsOutSQMs2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs2.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs2.conimp), levels=rownames(resultsOutSQMs2.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.5))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnAbsSQMsNoTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnAbsSQMsNoTonLdConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnAbsSQMsNoTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnAbsSQMsNoTonLdConPermimp.pdf")
}

```

### Difference variables

Next, the difference metrics are analysed

#### Set variables

```{r}

iVars <- c(names(stimDataBNum)[which(colnames(stimDataBNum)=="LAeqLAF90diff"):
                               which(colnames(stimDataBNum)=="dImpulsSHM05ExMaxLR")],
           "UASEventPerMin", "SNRlevel")
dVar <- "dAnnoyMean"

seeds <- c(568392, 498, 4089, 78132, 741809)

```

#### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.25)

```

#### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutDiffs <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutDiffs$OOB_RMSE
resultsOutDiffs$OOB_MAE
resultsOutDiffs$Rsquared

```

Train multiple seeds model

```{r}

resultsOutDiffs <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutDiffs$OOB_RMSE
resultsOutDiffs$OOB_MAE
resultsOutDiffs$Rsquared

```

```{r}

# store results
resdAnnoyMnFitB['Diff vars', 'RMSE'] <- resultsOutDiffs$OOB_RMSE
resdAnnoyMnFitB['Diff vars', 'MAE'] <- resultsOutDiffs$OOB_MAE
resdAnnoyMnFitB['Diff vars', 'Rsquared'] <- resultsOutDiffs$Rsquared
resdAnnoyMnPermImpB$DiffVars <- resultsOutDiffs$conditional_permimp

```

#### Plot results

```{r, fig.width=8,fig.height=10}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutDiffs.conimp <- arrange(resultsOutDiffs$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutDiffs.conimp) + geom_col(aes(x=factor(rownames(resultsOutDiffs.conimp), levels=rownames(resultsOutDiffs.conimp)), y=CondPermImp), fill=mycolours[8], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnDiffVarsConPermimp.svg", width=8, height=10, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnDiffVarsConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnDiffVarsConPermimp.pdf", width=8, height=10, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnDiffVarsConPermimp.pdf")
}

```

```{r, fig.width=8,fig.height=3.5}

# Plot only positive values
resultsOutDiffs.conimpPtv <- resultsOutDiffs.conimp |>
                                        rownames_to_column('Metric') |>
                                            filter_if(is.numeric, all_vars(. > 0)) |>
                                                  column_to_rownames('Metric')

pBar <- ggplot(resultsOutDiffs.conimpPtv) + geom_col(aes(x=factor(rownames(resultsOutDiffs.conimpPtv), levels=rownames(resultsOutDiffs.conimpPtv)), y=CondPermImp), fill=mycolours[8], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnDiffVarsConPermimpPtv.svg", width=8, height=3.5, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnDiffVarsConPermimpPtv.svg")
  
  ggsave(filename="PtBdAnnoyMnDiffVarsConPermimpPtv.pdf", width=8, height=3.5, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnDiffVarsConPermimpPtv.pdf")
}

```

Selected metric

```{r}

diffVar <- "LAeqLAF90diff"

```

### dSQM analysis

The ambient-only stimuli are NOT replaced here, as the difference analysis includes dB metrics.

#### Individual SQMs

##### dSharpness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, "dSharpAurISO3PowAvgMaxLR", "dSharpAurISO305ExMaxLR", "dSharpAurSHMPowAvgMaxLR", "dSharpAurSHM05ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(84194, 905, 64815, 928054, 625091)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSharp <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSharp <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```


```{r}
# store results
resdAnnoyMnFitB['Diff sharp', 'RMSE'] <- resultsOutSharp$OOB_RMSE
resdAnnoyMnFitB['Diff sharp', 'MAE'] <- resultsOutSharp$OOB_MAE
resdAnnoyMnFitB['Diff sharp', 'Rsquared'] <- resultsOutSharp$Rsquared
resdAnnoyMnPermImpB$DiffSharp <- resultsOutSharp$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.6}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSharp.conimp <- arrange(resultsOutSharp$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSharp.conimp) + geom_col(aes(x=factor(rownames(resultsOutSharp.conimp), levels=rownames(resultsOutSharp.conimp)), y=CondPermImp), fill=mycolours[2], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("dSharpness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMndSharpConPermimp.svg", width=8, height=2.6, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMndSharpConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMndSharpConPermimp.pdf", width=8, height=2.6, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMndSharpConPermimp.pdf")
}


```

Selected metric

```{r}

dSharpVar <- "dSharpAurISO3PowAvgMaxLR"

```

##### dTonal loudness and dtonality

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, "dTonalECMAAvgMaxLR", "dTonalSHMInt05ExMaxLR", "dTonalSHMIntAvgMaxLR", "dTonalECMA05ExMaxLR", "dTonLdECMAPowAvgBin", "dTonLdECMA05ExBin")
dVar <- "dAnnoyMean"

seeds <- c(561684, 104798, 1536, 48, 48561)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.5)

```

###### Run model

Train preliminary model

```{r}
# Tonality with tonal loudness

nperm <- 5

resultsOutTonal1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared
```
Train multiple seeds model

```{r}
# Tonality with tonal loudness

resultsOutTonal1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared

```

```{r}
# store results
resdAnnoyMnFitB['Diff tonal inc loud', 'RMSE'] <- resultsOutTonal1$OOB_RMSE
resdAnnoyMnFitB['Diff tonal inc loud', 'MAE'] <- resultsOutTonal1$OOB_MAE
resdAnnoyMnFitB['Diff tonal inc loud', 'Rsquared'] <- resultsOutTonal1$Rsquared
resdAnnoyMnPermImpB$DiffTonal1 <- resultsOutTonal1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.6}

par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal1.conimp <- arrange(resultsOutTonal1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal1.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal1.conimp), levels=rownames(resultsOutTonal1.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("dTonality inc. dtonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.4))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMndTonalLdConPermimp.svg", width=8, height=2.6, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMndTonalLdConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMndTonalLdConPermimp.pdf", width=8, height=2.6, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMndTonalLdConPermimp.pdf")
}

```

Selected metric

```{r}

dTonLdVar <- "dTonLdECMAPowAvgBin"

```

##### dTonality without dtonal loudness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, "dTonalECMAAvgMaxLR", "dTonalSHMInt05ExMaxLR", "dTonalSHMIntAvgMaxLR", "dTonalECMA05ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(410865, 2954, 70812, 203, 7984)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 1501
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}
# Tonality

nperm <- 5

resultsOutTonal2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```

Train multiple seeds model

```{r}
# Tonality

resultsOutTonal2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```


```{r}

# store results
resdAnnoyMnFitB['Diff tonal no loud', 'RMSE'] <- resultsOutTonal2$OOB_RMSE
resdAnnoyMnFitB['Diff tonal no loud', 'MAE'] <- resultsOutTonal2$OOB_MAE
resdAnnoyMnFitB['Diff tonal no loud', 'Rsquared'] <- resultsOutTonal2$Rsquared
resdAnnoyMnPermImpB$DiffTonal2 <- resultsOutTonal2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal2.conimp <- arrange(resultsOutTonal2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal2.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal2.conimp), levels=rownames(resultsOutTonal2.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("dTonality w/o tonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.4))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMndTonalConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMndTonalConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMndTonalConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMndTonalConPermimp.pdf")
}


```

Selectec metric

```{r}

dTonalVar <- "dTonalSHMIntAvgMaxLR"

```

##### dFluctuation strength

###### Set variables

```{r}

# Fluctuation strength
iVars <- c(diffVar, eventVar, "dFluctSHM10ExBin", "dFluctSHM05ExBin", "dFluctOV10ExMaxLR", "dFluctOV05ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(418657, 84, 1630, 18659, 3687)

```


###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 2501
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutFluct <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```
Train multiple seeds model

```{r}

resultsOutFluct <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```


```{r}

# store results
resdAnnoyMnFitB['Diff fluct', 'RMSE'] <- resultsOutFluct$OOB_RMSE
resdAnnoyMnFitB['Diff fluct', 'MAE'] <- resultsOutFluct$OOB_MAE
resdAnnoyMnFitB['Diff fluct', 'Rsquared'] <- resultsOutFluct$Rsquared
resdAnnoyMnPermImpB$DiffFluct <- resultsOutFluct$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutFluct.conimp <- arrange(resultsOutFluct$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutFluct.conimp) + geom_col(aes(x=factor(rownames(resultsOutFluct.conimp), levels=rownames(resultsOutFluct.conimp)), y=CondPermImp), fill=mycolours[4], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("dFluctuation strength") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMndFluctConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnFluctConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMndFluctConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnFluctConPermimp.pdf")
}

```

Selected metric

```{r}

dFluctVar <- "dFluctOV10ExMaxLR"

```


##### dRoughness

###### Set variables

```{r}

# Roughness
iVars <- c(diffVar, "UASEventPerMin", "dRoughECMA10ExBin", "dRoughECMA05ExBin", "dRoughFZ10ExMaxLR", "dRoughFZ05ExMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(69851, 85109, 410986, 1563, 896)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 1001
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutRough <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

Train multiple seeds model

```{r}

resultsOutRough <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

```{r}
# store results
resdAnnoyMnFitB['Diff rough', 'RMSE'] <- resultsOutRough$OOB_RMSE
resdAnnoyMnFitB['Diff rough', 'MAE'] <- resultsOutRough$OOB_MAE
resdAnnoyMnFitB['Diff rough', 'Rsquared'] <- resultsOutRough$Rsquared
resdAnnoyMnPermImpB$DiffRough <- resultsOutRough$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutRough.conimp <- arrange(resultsOutRough$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutRough.conimp) + geom_col(aes(x=factor(rownames(resultsOutRough.conimp), levels=rownames(resultsOutRough.conimp)), y=CondPermImp), fill=mycolours[5], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("dRoughness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMndRoughConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMndRoughConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMndRoughConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMndRoughConPermimp.pdf")
}


```

Selected metric

```{r}

dRoughVar <- "dRoughFZ05ExMaxLR"

```

##### dImpulsiveness

###### Set variables

```{r}
# Impulsiveness
iVars <- c(diffVar, "UASEventPerMin", "dImpulsSHMAvgMaxLR", "dImpulsSHM05ExMaxLR", "dImpulsSHMPowAvgMaxLR")
dVar <- "dAnnoyMean"

seeds <- c(418659, 7805, 38475, 65834, 1653)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 5501
mtry <- as.integer(length(iVars)/1.25)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutImpuls <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

Train multiple seeds model

```{r}

resultsOutImpuls <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

```{r}

# store results
resdAnnoyMnFitB['Diff impuls', 'RMSE'] <- resultsOutImpuls$OOB_RMSE
resdAnnoyMnFitB['Diff impuls', 'MAE'] <- resultsOutImpuls$OOB_MAE
resdAnnoyMnFitB['Diff impuls', 'Rsquared'] <- resultsOutImpuls$Rsquared
resdAnnoyMnPermImpB$DiffImpuls <- resultsOutImpuls$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutImpuls.conimp <- arrange(resultsOutImpuls$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutImpuls.conimp) + geom_col(aes(x=factor(rownames(resultsOutImpuls.conimp), levels=rownames(resultsOutImpuls.conimp)), y=CondPermImp), fill=mycolours[6], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + ggtitle("dImpulsiveness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMndImpulsConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMndImpulsConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMndImpulsConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMndImpulsConPermimp.pdf")
}

```

Selected metric

```{r}

dImpulsVar <- "dImpulsSHM05ExMaxLR"

```

#### dSQM and loudness comparison

Now the highest importance dSQMs are ranked against each other, controlling for loudness difference.

##### Include dtonal loudness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, dSharpVar, dTonLdVar, dFluctVar, dRoughVar, dImpulsVar)
dVar <- "dAnnoyMean"

seeds <- c(98465, 54163, 6541, 36485, 849675)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.25)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

```{r}

# store results
resdAnnoyMnFitB['Diff SQMs inc tonal loud', 'RMSE'] <- resultsOutSQMs1$OOB_RMSE
resdAnnoyMnFitB['Diff SQMs inc tonal loud', 'MAE'] <- resultsOutSQMs1$OOB_MAE
resdAnnoyMnFitB['Diff SQMs inc tonal loud', 'Rsquared'] <- resultsOutSQMs1$Rsquared
resdAnnoyMnPermImpB$DiffSQMs1 <- resultsOutSQMs1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs1.conimp <- arrange(resultsOutSQMs1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs1.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs1.conimp), levels=rownames(resultsOutSQMs1.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.5))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnDiffSQMsTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnDiffSQMsTonLdConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnDiffSQMsTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnDiffSQMsTonLdConPermimp.pdf")
}

```

##### Exclude tonal loudness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, dSharpVar, dTonalVar, dFluctVar, dRoughVar, dImpulsVar)
dVar <- "dAnnoyMean"

seeds <- c(49865, 7852, 845961, 410583, 36748)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.25)

```


###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

```{r}

# store results
resdAnnoyMnFitB['Diff SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_RMSE
resdAnnoyMnFitB['Diff SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_MAE
resdAnnoyMnFitB['Diff SQMs no tonal loud', 'Rsquared'] <- resultsOutSQMs2$Rsquared
resdAnnoyMnPermImpB$DiffSQMs2 <- resultsOutSQMs2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs2.conimp <- arrange(resultsOutSQMs2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs2.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs2.conimp), levels=rownames(resultsOutSQMs2.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (mean change in annoyance)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 0.5))
pBar

if (saveplots){
  ggsave(filename="PtBdAnnoyMnDiffSQMsNoTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdAnnoyMnDiffSQMsNoTonLdConPermimp.svg")
  
  ggsave(filename="PtBdAnnoyMnDiffSQMsNoTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdAnnoyMnDiffSQMsNoTonLdConPermimp.pdf")
}

```

### Save the results outputs to file

```{r}

if (savedata){
  utils::write.csv(resdAnnoyMnFitB, paste(outDataPath, "\\ptBCRFdAnnoyMnOOBFit.csv", sep=""))
  ii <- 0
  temp = list()
  for (res in resdAnnoyMnPermImpB){
    ii <- ii + 1
    temp[[ii]] <- as.data.frame(resdAnnoyMnPermImpB[ii])
    names(temp[[ii]]) <- names(resdAnnoyMnPermImpB[ii])
  }
  openxlsx::write.xlsx(temp, paste(outDataPath, "\\ptBCRFdAnnoyMnConPermimp.xlsx",
                                   sep=""),
                       rowNames=TRUE)
}

```

## (Change to) High annoyance

Initialise results output variables

```{r}
resdHiAnnoyFitB <- data.frame(RMSE = numeric(),
                             MAE = numeric(),
                             Rsquared = numeric())
resdHiAnnoyPermImpB <- list()

```

### All variables (absolute and difference)

#### Set variables

```{r}

iVars <- names(stimDataBNum)[which(names(stimDataBNum) == 'UASEvents'):which(names(stimDataBNum) == 'UASImpulsSHM05ExMaxLR')]
iVars <- iVars[! iVars %in% 'AmbientLAeq']
iVars <- c(iVars,
           names(stimDataBNum)[which(colnames(stimDataBNum)=="LAeqLAF90diff"):
                               which(colnames(stimDataBNum)=="dImpulsSHM05ExMaxLR")], "SNRlevel")
dVar <- "dHighAnnoyPc"

seeds <- c(2, 312, 1897, 465978, 821659)

```

#### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
              ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/2.25)

```

#### Run model

Train preliminary model

```{r}

nperm <- 300

resultsOutAbsDiffs <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbsDiffs$OOB_RMSE
resultsOutAbsDiffs$OOB_MAE
resultsOutAbsDiffs$Rsquared

```

Train multiple seeds model

```{r}

resultsOutAbsDiffs <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbsDiffs$OOB_RMSE
resultsOutAbsDiffs$OOB_MAE
resultsOutAbsDiffs$Rsquared
```

```{r}
# store results
resdHiAnnoyFitB['All vars', 'RMSE'] <- resultsOutAbsDiffs$OOB_RMSE
resdHiAnnoyFitB['All vars', 'MAE'] <- resultsOutAbsDiffs$OOB_MAE
resdHiAnnoyFitB['All vars', 'Rsquared'] <- resultsOutAbsDiffs$Rsquared
resdHiAnnoyPermImpB$AllVars <- resultsOutAbsDiffs$conditional_permimp

```

#### Plot results

```{r, fig.width=8,fig.height=20}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutAbsDiffs.conimp <- arrange(resultsOutAbsDiffs$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutAbsDiffs.conimp) + geom_col(aes(x=factor(rownames(resultsOutAbsDiffs.conimp), levels=rownames(resultsOutAbsDiffs.conimp)), y=CondPermImp), fill=mycolours[9], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAllVarsConPermimp.svg", width=8, height=20, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAllVarsConPermimp.svg")

  ggsave(filename="PtBdHiAnnoyAllVarsConPermimp.pdf", width=8, height=20, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAllVarsConPermimp.pdf")
}

```

```{r, fig.width=8,fig.height=6}

# Plot only positive values

resultsOutAbsDiffs.conimpPtv <- resultsOutAbsDiffs.conimp |>
                                          rownames_to_column('Metric') |>
                                                filter_if(is.numeric, all_vars(. > 0)) |>
                                                      column_to_rownames('Metric')

pBar <- ggplot(resultsOutAbsDiffs.conimpPtv) + geom_col(aes(x=factor(rownames(resultsOutAbsDiffs.conimpPtv), levels=rownames(resultsOutAbsDiffs.conimpPtv)), y=CondPermImp), fill=mycolours[9], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAllVarsConPermimpPtv.svg", width=8, height=6, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAllVarsConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyAllVarsConPermimpPtv.pdf", width=8, height=6, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAllVarsConPermimp.pdf")
}

```

```{r, fig.width=8,fig.height=4}

# Plot only values within 1% of the maximum

resultsOutAbsDiffs.conimpPtv <- resultsOutAbsDiffs.conimp |>
                                          rownames_to_column('Metric') |>
                                                filter_if(is.numeric, all_vars(. > max(resultsOutAbsDiffs.conimp)/100)) |>
                                                      column_to_rownames('Metric')

pBar <- ggplot(resultsOutAbsDiffs.conimpPtv) + geom_col(aes(x=factor(rownames(resultsOutAbsDiffs.conimpPtv), levels=rownames(resultsOutAbsDiffs.conimpPtv)), y=CondPermImp), fill=mycolours[9], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAllVarsConPermimp1pc.svg", width=8, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAllVarsConPermimp1pc.svg")
  
  ggsave(filename="PtBdHiAnnoyAllVarsConPermimp1pc.pdf", width=8, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAllVarsConPermimp1pc.pdf")
}

```

### Absolute variables

#### Set variables

```{r}

iVars <- names(stimDataBNum)[which(names(stimDataBNum) == 'UASEvents'):which(names(stimDataBNum) == 'UASImpulsSHM05ExMaxLR')]
iVars <- iVars[! iVars %in% c('SNRlevel')]
dVar <- "dHighAnnoyPc"

seeds <- c(578312, 544, 84894, 54654, 153157)

```

#### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAbsVarsHyperTune.svg", width=12, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAbsVarsHyperTune.svg")

  ggsave(filename="PtBdHiAnnoyAbsVarsHyperTune.pdf", width=12, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAbsVarsHyperTune.pdf")
}

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/3.5)

```

#### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutAbs <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbs$OOB_RMSE
resultsOutAbs$OOB_MAE
resultsOutAbs$Rsquared

```
Train multiple seeds model

```{r}

resultsOutAbs <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutAbs$OOB_RMSE
resultsOutAbs$OOB_MAE
resultsOutAbs$Rsquared

```


```{r}

# store results
resdHiAnnoyFitB['Abs vars', 'RMSE'] <- resultsOutAbs$OOB_RMSE
resdHiAnnoyFitB['Abs vars', 'MAE'] <- resultsOutAbs$OOB_MAE
resdHiAnnoyFitB['Abs vars', 'Rsquared'] <- resultsOutAbs$Rsquared
resdHiAnnoyPermImpB$AbsVars <- resultsOutAbs$conditional_permimp

```

#### Plot results

```{r, fig.width=8,fig.height=11.5}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutAbs.conimp <- arrange(resultsOutAbs$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutAbs.conimp) + geom_col(aes(x=factor(rownames(resultsOutAbs.conimp), levels=rownames(resultsOutAbs.conimp)), y=CondPermImp), fill=mycolours[1], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) +
  coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAbsVarsConPermimp.svg", width=8, height=11.5, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAbsVarsConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyAbsVarsConPermimp.pdf", width=8, height=11.5, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAbsVarsConPermimp.pdf")
}
```

```{r, fig.width=8,fig.height=6}

# Plot only positive values
resultsOutAbs.conimpPtv <- resultsOutAbs.conimp |>
                                          rownames_to_column('Metric') |>
                                                filter_if(is.numeric, all_vars(. > 0)) |>
                                                      column_to_rownames('Metric')

pBar <- ggplot(resultsOutAbs.conimpPtv,) + geom_col(aes(x=factor(rownames(resultsOutAbs.conimpPtv), levels=rownames(resultsOutAbs.conimpPtv)), y=CondPermImp), fill=mycolours[1], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAbsVarsConPermimpPtv.svg", width=8, height=6, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAbsVarsConPermimpPtv.svg")
  
  ggsave(filename="PtBdHiAnnoyAbsVarsConPermimpPtv.pdf", width=8, height=6, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAbsVarsConPermimpPtv.pdf")
}

```

Selected metric

```{r}

absVar <- "UASLoudECMAPowAvgBin"

```

### SQM analysis

#### Individual SQMs

##### Sharpness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, "UASSharpAurISO3PowAvgMaxLR", "UASSharpAurISO305ExMaxLR", "UASSharpAurSHMPowAvgMaxLR", "UASSharpAurSHM05ExMaxLR", "UASSharpAurISO1PowAvgMaxLR", "UASSharpAurISO105ExMaxLR", "UASSharpvBISO1PowAvgMaxLR", "UASSharpvBISO105ExMaxLR", "UASSharpDINPowAvgMaxLR", "UASSharpDIN05ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(7041, 905, 4984651, 6513213, 120651)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/2.25)

```

###### Run model

Train preliminary model

```{r}

nperm <- 20

resultsOutSharp <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```
Train multiple seeds model

```{r}

resultsOutSharp <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```


```{r}
# store results
resdHiAnnoyFitB['Abs sharp', 'RMSE'] <- resultsOutSharp$OOB_RMSE
resdHiAnnoyFitB['Abs sharp', 'MAE'] <- resultsOutSharp$OOB_MAE
resdHiAnnoyFitB['Abs sharp', 'Rsquared'] <- resultsOutSharp$Rsquared
resdHiAnnoyPermImpB$AbsSharp <- resultsOutSharp$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=4.9}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSharp.conimp <- arrange(resultsOutSharp$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSharp.conimp) + geom_col(aes(x=factor(rownames(resultsOutSharp.conimp), levels=rownames(resultsOutSharp.conimp)), y=CondPermImp), fill=mycolours[2], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("Sharpness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoySharpConPermimp.svg", width=8, height=4.9, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoySharpConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoySharpConPermimp.pdf", width=8, height=4.9, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoySharpConPermimp.pdf")
}


```

Selected metric

```{r}

sharpVar <- "UASSharpAurISO1PowAvgMaxLR"

```


##### Tonal loudness and tonality

###### Set variables

```{r}

iVars <- c(absVar, eventVar, "UASTonalECMAAvgMaxLR", "UASTonalSHMInt05ExMaxLR", "UASTonalSHMIntAvgMaxLR", "UASTonalECMA05ExMaxLR", "UASTonLdECMAPowAvgBin", "UASTonLdECMA05ExBin", "UASTonalAurAvgMaxLR", "UASTonalAur05ExMaxLR", "UASTonalAur10ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(540, 104798, 456464, 87331, 94564)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 4001
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}
# Tonality with tonal loudness

nperm <- 5

resultsOutTonal1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared
```

Train multiple seeds model

```{r}
# Tonality with tonal loudness

resultsOutTonal1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared

```

```{r}
# store results
resdHiAnnoyFitB['Abs tonal inc loud', 'RMSE'] <- resultsOutTonal1$OOB_RMSE
resdHiAnnoyFitB['Abs tonal inc loud', 'MAE'] <- resultsOutTonal1$OOB_MAE
resdHiAnnoyFitB['Abs tonal inc loud', 'Rsquared'] <- resultsOutTonal1$Rsquared
resdHiAnnoyPermImpB$AbsTonal1 <- resultsOutTonal1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=3.8}

par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal1.conimp <- arrange(resultsOutTonal1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal1.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal1.conimp), levels=rownames(resultsOutTonal1.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("Tonality inc. tonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 80))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyTonalLdConPermimp.svg", width=8, height=3.8, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyTonalLdConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyTonalLdConPermimp.pdf", width=8, height=3.8, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyTonalLdConPermimp.pdf")
}

```

Selected metric

```{r}

tonLdVar <- "UASTonLdECMAPowAvgBin"

```


##### Tonality without tonal loudness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, "UASTonalECMAAvgMaxLR", "UASTonalSHMInt05ExMaxLR", "UASTonalSHMIntAvgMaxLR", "UASTonalECMA05ExMaxLR", "UASTonalAurAvgMaxLR", "UASTonalAur05ExMaxLR", "UASTonalAur10ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(156089, 5860, 10528, 89541, 4685146)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.75)

```


###### Run model

Train preliminary model

```{r}
# Tonality

nperm <- 5

resultsOutTonal2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2],
                           ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm,
                           minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```

Train multiple seeds model

```{r}
# Tonality

resultsOutTonal2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```


```{r}

# store results
resdHiAnnoyFitB['Abs tonal no loud', 'RMSE'] <- resultsOutTonal2$OOB_RMSE
resdHiAnnoyFitB['Abs tonal no loud', 'MAE'] <- resultsOutTonal2$OOB_MAE
resdHiAnnoyFitB['Abs tonal no loud', 'Rsquared'] <- resultsOutTonal2$Rsquared
resdHiAnnoyPermImpB$AbsTonal2 <- resultsOutTonal2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=3.2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal2.conimp <- arrange(resultsOutTonal2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal2.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal2.conimp), levels=rownames(resultsOutTonal2.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("Tonality w/o tonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(-1, 80))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyTonalConPermimp.svg", width=8, height=3.2, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyTonalConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyTonalConPermimp.pdf", width=8, height=3.2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyTonalConPermimp.pdf")
}


```

Selected metric

```{r}

tonalVar <- "UASTonalAurAvgMaxLR"

```

##### Fluctuation strength

###### Set variables

```{r}

# Fluctuation strength
iVars <- c(absVar, eventVar, "UASFluctSHM10ExBin", "UASFluctSHM05ExBin", "UASFluctFZ10ExMaxLR", "UASFluctFZ05ExMaxLR", "UASFluctOV10ExMaxLR", "UASFluctOV05ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(25107, 546098, 195, 5937, 102658)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 4001
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutFluct <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2],
                          ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres,
                          nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```
Train multiple seeds model

```{r}

resultsOutFluct <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```


```{r}

# store results
resdHiAnnoyFitB['Abs fluct', 'RMSE'] <- resultsOutFluct$OOB_RMSE
resdHiAnnoyFitB['Abs fluct', 'MAE'] <- resultsOutFluct$OOB_MAE
resdHiAnnoyFitB['Abs fluct', 'Rsquared'] <- resultsOutFluct$Rsquared
resdHiAnnoyPermImpB$AbsFluct <- resultsOutFluct$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.9}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutFluct.conimp <- arrange(resultsOutFluct$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutFluct.conimp) + geom_col(aes(x=factor(rownames(resultsOutFluct.conimp), levels=rownames(resultsOutFluct.conimp)), y=CondPermImp), fill=mycolours[4], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("Fluctuation strength") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyFluctConPermimp.svg", width=8, height=2.9, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyFluctConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyFluctConPermimp.pdf", width=8, height=2.9, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyFluctConPermimp.pdf")
}

```

Selected metric

```{r}

fluctVar <- "UASFluctOV10ExMaxLR"

```

##### Roughness

###### Set variables

```{r}

# Roughness
iVars <- c(absVar, eventVar, "UASRoughECMA10ExBin", "UASRoughECMA05ExBin", "UASRoughFZ10ExMaxLR", "UASRoughFZ05ExMaxLR", "UASRoughDW10ExMaxLR", "UASRoughDW05ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(4701, 52187, 16589, 65217, 16893)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.75)

```


###### Run model

Train preliminary model

```{r}

nperm <- 20

resultsOutRough <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

Train multiple seeds model

```{r}

resultsOutRough <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

```{r}
# store results
resdHiAnnoyFitB['Abs rough', 'RMSE'] <- resultsOutRough$OOB_RMSE
resdHiAnnoyFitB['Abs rough', 'MAE'] <- resultsOutRough$OOB_MAE
resdHiAnnoyFitB['Abs rough', 'Rsquared'] <- resultsOutRough$Rsquared
resdHiAnnoyPermImpB$AbsRough <- resultsOutRough$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.9}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutRough.conimp <- arrange(resultsOutRough$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutRough.conimp) + geom_col(aes(x=factor(rownames(resultsOutRough.conimp), levels=rownames(resultsOutRough.conimp)), y=CondPermImp), fill=mycolours[5], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("Roughness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyRoughConPermimp.svg", width=8, height=2.9, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyRoughConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyRoughConPermimp.pdf", width=8, height=2.9, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyRoughConPermimp.pdf")
}


```

Selected metric

```{r}

roughVar <- "UASRoughFZ05ExMaxLR"

```


##### Impulsiveness

###### Set variables

```{r}
# Impulsiveness
iVars <- c(absVar, eventVar, "UASImpulsSHMAvgMaxLR", "UASImpulsSHM05ExMaxLR", "UASImpulsSHMPowAvgMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(8495, 59867, 5416, 9843, 86)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.5)

```


###### Run model

Train preliminary model

```{r}

nperm <- 50

resultsOutImpuls <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

Train multiple seeds model

```{r}

resultsOutImpuls <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

```{r}

# store results
resdHiAnnoyFitB['Abs impuls', 'RMSE'] <- resultsOutImpuls$OOB_RMSE
resdHiAnnoyFitB['Abs impuls', 'MAE'] <- resultsOutImpuls$OOB_MAE
resdHiAnnoyFitB['Abs impuls', 'Rsquared'] <- resultsOutImpuls$Rsquared
resdHiAnnoyPermImpB$AbsImpuls <- resultsOutImpuls$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutImpuls.conimp <- arrange(resultsOutImpuls$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutImpuls.conimp) + geom_col(aes(x=factor(rownames(resultsOutImpuls.conimp), levels=rownames(resultsOutImpuls.conimp)), y=CondPermImp), fill=mycolours[6], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("Impulsiveness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyImpulsConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyImpulsConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyImpulsConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyImpulsConPermimp.pdf")
}

```

Selected metric

```{r}

impulsVar <- "UASImpulsSHMAvgMaxLR"

```

#### SQM and loudness comparison

Now the highest importance SQMs are ranked against each other, controlling for UAS loudness and ambient LAeq.

##### Include tonal loudness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, sharpVar, tonLdVar, fluctVar, roughVar, impulsVar)
dVar <- "dHighAnnoyPc"

seeds <- c(70498, 4, 14986, 453, 864)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 1001
mtry <- as.integer(length(iVars)/2.25)

```


###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

```{r}

# store results
resdHiAnnoyFitB['Abs SQMs inc tonal loud', 'RMSE'] <- resultsOutSQMs1$OOB_RMSE
resdHiAnnoyFitB['Abs SQMs inc tonal loud', 'MAE'] <- resultsOutSQMs1$OOB_MAE
resdHiAnnoyFitB['Abs SQMs inc tonal loud', 'Rsquared'] <- resultsOutSQMs1$Rsquared
resdHiAnnoyPermImpB$AbsSQMs1 <- resultsOutSQMs1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs1.conimp <- arrange(resultsOutSQMs1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs1.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs1.conimp), levels=rownames(resultsOutSQMs1.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 70))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAbsSQMsTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAbsSQMsTonLdConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyAbsSQMsTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAbsSQMsTonLdConPermimp.pdf")
}

```

##### Exclude tonal loudness

###### Set variables

```{r}

iVars <- c(absVar, eventVar, sharpVar, tonalVar, fluctVar, roughVar, impulsVar)
dVar <- "dHighAnnoyPc"

seeds <- c(546, 57203, 270835, 60592, 8094)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 2501
mtry <- as.integer(length(iVars)/2.25)

```


###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

```{r}

# store results
resdHiAnnoyFitB['Abs SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_RMSE
resdHiAnnoyFitB['Abs SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_MAE
resdHiAnnoyFitB['Abs SQMs no tonal loud', 'Rsquared'] <- resultsOutSQMs2$Rsquared
resdHiAnnoyPermImpB$AbsSQMs2 <- resultsOutSQMs2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs2.conimp <- arrange(resultsOutSQMs2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs2.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs2.conimp), levels=rownames(resultsOutSQMs2.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 70))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyAbsSQMsNoTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyAbsSQMsNoTonLdConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyAbsSQMsNoTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyAbsSQMsNoTonLdConPermimp.pdf")
}

```

### Difference variables

Next, the difference metrics are analysed, 

#### Set variables

```{r}

iVars <- c(names(stimDataBNum)[which(colnames(stimDataBNum)=="LAeqLAF90diff"):
                               which(colnames(stimDataBNum)=="dImpulsSHM05ExMaxLR")],
           "SNRlevel", "UASEventPerMin")
dVar <- "dHighAnnoyPc"

seeds <- c(568392, 498, 4089, 78132, 741809)

```

#### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.5)

```

#### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutDiffs <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutDiffs$OOB_RMSE
resultsOutDiffs$OOB_MAE
resultsOutDiffs$Rsquared

```

Train multiple seeds model

```{r}

resultsOutDiffs <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutDiffs$OOB_RMSE
resultsOutDiffs$OOB_MAE
resultsOutDiffs$Rsquared

```

```{r}

# store results
resdHiAnnoyFitB['Diff vars', 'RMSE'] <- resultsOutDiffs$OOB_RMSE
resdHiAnnoyFitB['Diff vars', 'MAE'] <- resultsOutDiffs$OOB_MAE
resdHiAnnoyFitB['Diff vars', 'Rsquared'] <- resultsOutDiffs$Rsquared
resdHiAnnoyPermImpB$DiffVars <- resultsOutDiffs$conditional_permimp

```

#### Plot results

```{r, fig.width=8,fig.height=10}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutDiffs.conimp <- arrange(resultsOutDiffs$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutDiffs.conimp) + geom_col(aes(x=factor(rownames(resultsOutDiffs.conimp), levels=rownames(resultsOutDiffs.conimp)), y=CondPermImp), fill=mycolours[8], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyDiffVarsConPermimp.svg", width=8, height=10, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyDiffVarsConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyDiffVarsConPermimp.pdf", width=8, height=10, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyDiffVarsConPermimp.pdf")
}

```
```{r, fig.width=8,fig.height=4}

# Plot only positive values
resultsOutDiffs.conimpPtv <- resultsOutDiffs.conimp |>
                                        rownames_to_column('Metric') |>
                                            filter_if(is.numeric, all_vars(. > 0)) |>
                                                  column_to_rownames('Metric')

pBar <- ggplot(resultsOutDiffs.conimpPtv) + geom_col(aes(x=factor(rownames(resultsOutDiffs.conimpPtv), levels=rownames(resultsOutDiffs.conimpPtv)), y=CondPermImp), fill=mycolours[8], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyDiffVarsConPermimpPtv.svg", width=8, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyDiffVarsConPermimpPtv.svg")
  
  ggsave(filename="PtBdHiAnnoyDiffVarsConPermimpPtv.pdf", width=8, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyDiffVarsConPermimpPtv.pdf")
}

```

Selected metric

```{r}

diffVar <- "Detect0p5dBIntMaxLR"

```

### dSQM analysis

The ambient-only stimuli are NOT replaced here, as the difference analysis includes dB metrics.

#### Individual SQMs

##### dSharpness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, "dSharpAurISO3PowAvgMaxLR", "dSharpAurISO305ExMaxLR", "dSharpAurSHMPowAvgMaxLR", "dSharpAurSHM05ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(84194, 905, 64815, 928054, 625091, 582031)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.75)

```


###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSharp <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```
Train multiple seeds model

```{r}

resultsOutSharp <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSharp$OOB_RMSE
resultsOutSharp$OOB_MAE
resultsOutSharp$Rsquared

```


```{r}
# store results
resdHiAnnoyFitB['Diff sharp', 'RMSE'] <- resultsOutSharp$OOB_RMSE
resdHiAnnoyFitB['Diff sharp', 'MAE'] <- resultsOutSharp$OOB_MAE
resdHiAnnoyFitB['Diff sharp', 'Rsquared'] <- resultsOutSharp$Rsquared
resdHiAnnoyPermImpB$DiffSharp <- resultsOutSharp$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.6}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSharp.conimp <- arrange(resultsOutSharp$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSharp.conimp) + geom_col(aes(x=factor(rownames(resultsOutSharp.conimp), levels=rownames(resultsOutSharp.conimp)), y=CondPermImp), fill=mycolours[2], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("dSharpness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoydSharpConPermimp.svg", width=8, height=2.6, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoydSharpConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoydSharpConPermimp.pdf", width=8, height=2.6, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoydSharpConPermimp.pdf")
}


```

Selected metric

```{r}

dSharpVar <- "dSharpAurISO3PowAvgMaxLR"

```


##### dTonal loudness and dtonality

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, "dTonalECMAAvgMaxLR", "dTonalSHMInt05ExMaxLR", "dTonalSHMIntAvgMaxLR", "dTonalECMA05ExMaxLR", "dTonLdECMAPowAvgBin", "dTonLdECMA05ExBin")
dVar <- "dHighAnnoyPc"

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

seeds <- c(561684, 104798, 1536, 48, 48561)

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}
# Tonality with tonal loudness

nperm <- 5

resultsOutTonal1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared
```

Train multiple seeds model

```{r}
# Tonality with tonal loudness

resultsOutTonal1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal1$OOB_RMSE
resultsOutTonal1$OOB_MAE
resultsOutTonal1$Rsquared

```

```{r}
# store results
resdHiAnnoyFitB['Diff tonal inc loud', 'RMSE'] <- resultsOutTonal1$OOB_RMSE
resdHiAnnoyFitB['Diff tonal inc loud', 'MAE'] <- resultsOutTonal1$OOB_MAE
resdHiAnnoyFitB['Diff tonal inc loud', 'Rsquared'] <- resultsOutTonal1$Rsquared
resdHiAnnoyPermImpB$DiffTonal1 <- resultsOutTonal1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.6}

par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal1.conimp <- arrange(resultsOutTonal1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal1.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal1.conimp), levels=rownames(resultsOutTonal1.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("dTonality inc. dtonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 60))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoydTonalLdConPermimp.svg", width=8, height=2.6, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoydTonalLdConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoydTonalLdConPermimp.pdf", width=8, height=2.6, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoydTonalLdConPermimp.pdf")
}

```

Selected metric

```{r}

dTonLdVar <- "dTonLdECMAPowAvgBin"

```

##### dTonality without dtonal loudness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, "dTonalECMAAvgMaxLR", "dTonalSHMInt05ExMaxLR", "dTonalSHMIntAvgMaxLR", "dTonalECMA05ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(410865, 2954, 70812, 203, 7984)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p


```

Selected hyperparameters

```{r}

ntree <- 1501
mtry <- as.integer(length(iVars)/1.75)

```


###### Run model

Train preliminary model

```{r}
# Tonality

nperm <- 5

resultsOutTonal2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```

Train multiple seeds model

```{r}
# Tonality

resultsOutTonal2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutTonal2$OOB_RMSE
resultsOutTonal2$OOB_MAE
resultsOutTonal2$Rsquared

```


```{r}

# store results
resdHiAnnoyFitB['Diff tonal no loud', 'RMSE'] <- resultsOutTonal2$OOB_RMSE
resdHiAnnoyFitB['Diff tonal no loud', 'MAE'] <- resultsOutTonal2$OOB_MAE
resdHiAnnoyFitB['Diff tonal no loud', 'Rsquared'] <- resultsOutTonal2$Rsquared
resdHiAnnoyPermImpB$DiffTonal2 <- resultsOutTonal2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutTonal2.conimp <- arrange(resultsOutTonal2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutTonal2.conimp) + geom_col(aes(x=factor(rownames(resultsOutTonal2.conimp), levels=rownames(resultsOutTonal2.conimp)), y=CondPermImp), fill=mycolours[3], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("dTonality w/o tonal loudness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 70))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoydTonalConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoydTonalConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoydTonalConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoydTonalConPermimp.pdf")
}


```

Selected metric

```{r}

dTonalVar <- "dTonalSHMIntAvgMaxLR"

```

##### dFluctuation strength

###### Set variables

```{r}

# Fluctuation strength
iVars <- c(diffVar, eventVar, "dFluctSHM10ExBin", "dFluctSHM05ExBin", "dFluctOV10ExMaxLR", "dFluctOV05ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(418657, 84, 1630, 18659, 3687)

```


###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 1001
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 50

resultsOutFluct <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```

Train multiple seeds model

```{r}

resultsOutFluct <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutFluct$OOB_RMSE
resultsOutFluct$OOB_MAE
resultsOutFluct$Rsquared

```


```{r}

# store results
resdHiAnnoyFitB['Diff fluct', 'RMSE'] <- resultsOutFluct$OOB_RMSE
resdHiAnnoyFitB['Diff fluct', 'MAE'] <- resultsOutFluct$OOB_MAE
resdHiAnnoyFitB['Diff fluct', 'Rsquared'] <- resultsOutFluct$Rsquared
resdHiAnnoyPermImpB$DiffFluct <- resultsOutFluct$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutFluct.conimp <- arrange(resultsOutFluct$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutFluct.conimp) + geom_col(aes(x=factor(rownames(resultsOutFluct.conimp), levels=rownames(resultsOutFluct.conimp)), y=CondPermImp), fill=mycolours[4], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("dFluctuation strength") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoydFluctConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyFluctConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoydFluctConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyFluctConPermimp.pdf")
}

```

Selected metric

```{r}

dFluctVar <- "dFluctOV10ExMaxLR"

```

##### dRoughness

###### Set variables

```{r}

# Roughness
iVars <- c(diffVar, eventVar, "dRoughECMA10ExBin", "dRoughECMA05ExBin", "dRoughFZ10ExMaxLR", "dRoughFZ05ExMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(69851, 85109, 410986, 1563, 896)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.75)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutRough <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

Train multiple seeds model

```{r}

resultsOutRough <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutRough$OOB_RMSE
resultsOutRough$OOB_MAE
resultsOutRough$Rsquared

```

```{r}
# store results
resdHiAnnoyFitB['Diff rough', 'RMSE'] <- resultsOutRough$OOB_RMSE
resdHiAnnoyFitB['Diff rough', 'MAE'] <- resultsOutRough$OOB_MAE
resdHiAnnoyFitB['Diff rough', 'Rsquared'] <- resultsOutRough$Rsquared
resdHiAnnoyPermImpB$DiffRough <- resultsOutRough$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutRough.conimp <- arrange(resultsOutRough$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutRough.conimp) + geom_col(aes(x=factor(rownames(resultsOutRough.conimp), levels=rownames(resultsOutRough.conimp)), y=CondPermImp), fill=mycolours[5], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("dRoughness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoydRoughConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoydRoughConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoydRoughConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoydRoughConPermimp.pdf")
}


```

Selected metric

```{r}

dRoughVar <- "dRoughFZ05ExMaxLR"

```

##### dImpulsiveness

###### Set variables

```{r}
# Impulsiveness
iVars <- c(diffVar, eventVar, "dImpulsSHMAvgMaxLR", "dImpulsSHM05ExMaxLR", "dImpulsSHMPowAvgMaxLR")
dVar <- "dHighAnnoyPc"

seeds <- c(418659, 7805, 38475, 65834, 1653)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 5501
mtry <- as.integer(length(iVars)/1.25)

```


###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutImpuls <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

Train multiple seeds model

```{r}

resultsOutImpuls <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutImpuls$OOB_RMSE
resultsOutImpuls$OOB_MAE
resultsOutImpuls$Rsquared

```

```{r}

# store results
resdHiAnnoyFitB['Diff impuls', 'RMSE'] <- resultsOutImpuls$OOB_RMSE
resdHiAnnoyFitB['Diff impuls', 'MAE'] <- resultsOutImpuls$OOB_MAE
resdHiAnnoyFitB['Diff impuls', 'Rsquared'] <- resultsOutImpuls$Rsquared
resdHiAnnoyPermImpB$DiffImpuls <- resultsOutImpuls$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutImpuls.conimp <- arrange(resultsOutImpuls$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutImpuls.conimp) + geom_col(aes(x=factor(rownames(resultsOutImpuls.conimp), levels=rownames(resultsOutImpuls.conimp)), y=CondPermImp), fill=mycolours[6], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + ggtitle("dImpulsiveness") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip()
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoydImpulsConPermimp.svg", width=8, height=2, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoydImpulsConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoydImpulsConPermimp.pdf", width=8, height=2, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoydImpulsConPermimp.pdf")
}

```

Selected metric

```{r}

dImpulsVar <- "dImpulsSHM05ExMaxLR"

```

#### dSQM and loudness comparison

Now the highest importance dSQMs are ranked against each other, controlling for loudness difference.

##### Include dtonal loudness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, dSharpVar, dTonLdVar, dFluctVar, dRoughVar, dImpulsVar)
dVar <- "dHighAnnoyPc"

seeds <- c(98465, 54163, 6541, 36485, 849675)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 251
mtry <- as.integer(length(iVars)/1.25)

```


###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs1 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs1 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs1$OOB_RMSE
resultsOutSQMs1$OOB_MAE
resultsOutSQMs1$Rsquared

```

```{r}

# store results
resdHiAnnoyFitB['Diff SQMs inc tonal loud', 'RMSE'] <- resultsOutSQMs1$OOB_RMSE
resdHiAnnoyFitB['Diff SQMs inc tonal loud', 'MAE'] <- resultsOutSQMs1$OOB_MAE
resdHiAnnoyFitB['Diff SQMs inc tonal loud', 'Rsquared'] <- resultsOutSQMs1$Rsquared
resdHiAnnoyPermImpB$DiffSQMs1 <- resultsOutSQMs1$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs1.conimp <- arrange(resultsOutSQMs1$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs1.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs1.conimp), levels=rownames(resultsOutSQMs1.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 100))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyDiffSQMsTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyDiffSQMsTonLdConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyDiffSQMsTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyDiffSQMsTonLdConPermimp.pdf")
}

```

##### Exclude tonal loudness

###### Set variables

```{r}

iVars <- c(diffVar, eventVar, dSharpVar, dTonalVar, dFluctVar, dRoughVar, dImpulsVar)
dVar <- "dHighAnnoyPc"

seeds <- c(49865, 7852, 845961, 410583, 36748)

```

###### Hyperparameter tuning

```{r, fig.width=12, fig.height=4}

p <- mtryTune(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seed=seeds[1:2],
             ntrees=ntrees, minsplit=minsplit, minbucket=minbucket)
p

```

Selected hyperparameters

```{r}

ntree <- 501
mtry <- as.integer(length(iVars)/1.25)

```

###### Run model

Train preliminary model

```{r}

nperm <- 5

resultsOutSQMs2 <- crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds[1:2], ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

Train multiple seeds model

```{r}

resultsOutSQMs2 <- multi_crfReg(dataIn=stimDataBNum, iVars=iVars, dVar=dVar, seeds=seeds, ntree=ntree, mtry=mtry, permImpCondThres=permImpCondThres, nperm=nperm, minsplit=minsplit, minbucket=minbucket)

# print model prediction results
resultsOutSQMs2$OOB_RMSE
resultsOutSQMs2$OOB_MAE
resultsOutSQMs2$Rsquared

```

```{r}

# store results
resdHiAnnoyFitB['Diff SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_RMSE
resdHiAnnoyFitB['Diff SQMs no tonal loud', 'RMSE'] <- resultsOutSQMs2$OOB_MAE
resdHiAnnoyFitB['Diff SQMs no tonal loud', 'Rsquared'] <- resultsOutSQMs2$Rsquared
resdHiAnnoyPermImpB$DiffSQMs2 <- resultsOutSQMs2$conditional_permimp

```

###### Plot results

```{r, fig.width=8,fig.height=2.4}
par(mai=c(0,3,0,0))

# plot conditional importance
resultsOutSQMs2.conimp <- arrange(resultsOutSQMs2$conditional_permimp, desc(row_number()))

pBar <- ggplot(resultsOutSQMs2.conimp) + geom_col(aes(x=factor(rownames(resultsOutSQMs2.conimp), levels=rownames(resultsOutSQMs2.conimp)), y=CondPermImp), fill=mycolours[7], width=0.5) + labs(x="Variable", y="Conditional variable permutation importance (% highly annoyed)") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2)) + coord_flip(ylim=c(0, 100))
pBar

if (saveplots){
  ggsave(filename="PtBdHiAnnoyDiffSQMsNoTonLdConPermimp.svg", width=8, height=2.4, path=file.path(outFigPath, "svg"))
  unlink("PtBdHiAnnoyDiffSQMsNoTonLdConPermimp.svg")
  
  ggsave(filename="PtBdHiAnnoyDiffSQMsNoTonLdConPermimp.pdf", width=8, height=2.4, path=file.path(outFigPath, "pdf"))
  unlink("PtBdHiAnnoyDiffSQMsNoTonLdConPermimp.pdf")
}

```

### Save the results outputs to file

```{r}

if (savedata){
  utils::write.csv(resdHiAnnoyFitB, paste(outDataPath, "\\ptBCRFdHiAnnoyOOBFit.csv", sep=""))
  ii <- 0
  temp = list()
  for (res in resdHiAnnoyPermImpB){
    ii <- ii + 1
    temp[[ii]] <- as.data.frame(resdHiAnnoyPermImpB[ii])
    names(temp[[ii]]) <- names(resdHiAnnoyPermImpB[ii])
  }
  openxlsx::write.xlsx(temp, paste(outDataPath, "\\ptBCRFdHiAnnoyConPermimp.xlsx",
                                   sep=""),
                       rowNames=TRUE)
}

```

## Part B summary

Summary of results for Part B

### With tonal loudness

#### Absolute variables

```{r, fig.width=8, fig.height=4}
# combine the annoyance perm importance results

# convert each result to a tibble with rownames added to a column, renaming the data column to 'dAnnoy' etc.
resdAnnoyMnAbsPermImpTblB <- as.data.frame(resdAnnoyMnPermImpB$AbsSQMs1/max(resdAnnoyMnPermImpB$AbsSQMs1)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdAnnoyMnAbsPermImpTblB)[2] <- "dAnnoy"

resdHiAnnoyAbsPermImpTblB <- as.data.frame(resdHiAnnoyPermImpB$AbsSQMs1/max(resdHiAnnoyPermImpB$AbsSQMs1)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdHiAnnoyAbsPermImpTblB)[2] <- "dHiAnnoy"

# merge the dataframes
resAbsPermImpTblB <- list(resdAnnoyMnAbsPermImpTblB, resdHiAnnoyAbsPermImpTblB) |>
  purrr::reduce(merge, by = c('Variable'), all = T)

# rename the columns
colnames(resAbsPermImpTblB)[2:3] <- c("Mean change in annoyance", "%HA [p(HA | 0)]")
resAbsPermImpTblB[is.na(resAbsPermImpTblB)] <- 0

resAbsB <- tidyr::pivot_longer(resAbsPermImpTblB, cols=-Variable, names_to="Outcome", values_to="Imp")

# reorder res tibble, descending by the variable Imp grouped sum and create column with new group order as a factor
resAbsB <- resAbsB |> mutate(Variable_sum = sum(Imp), .by=Variable) |> arrange(desc(Variable_sum)) |> group_by(Variable_sum, Variable) |>
   mutate(Order = cur_group_id()) |> mutate(Order = as.factor(Order)) |> arrange(desc(Order))

# Reorder outcome levels
resAbsB$Outcome <- factor(resAbsB$Outcome, levels=c("Mean change in annoyance", "%HA [p(HA | 0)]"))

# plot res as horizontal bar chart, with Imp as y axis, Variable as x axis, Outcome as fill, and Variable_sum as order, relabel x axis with Variable names
pBar <- ggplot(resAbsB) + geom_col(aes(fill=Outcome, y=Imp, x=Order), colour='grey35', linewidth=0,  width=0.75, show.legend=TRUE) + labs(x="Variable", y="Normalised variable permutation importance") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2), legend.position = "right") + coord_flip(ylim=c(-0.1, 2)) + scale_fill_manual(values=mycolours) + scale_x_discrete(labels=unique(rev(resAbsB$Variable)))
pBar

if (saveplots){
  ggsave(filename="PtBcrfAbsSQMsSummary.svg", width=8, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBcrfAbsSQMsSummary.svg")
  
  ggsave(filename="PtBcrfAbsSQMsSummary.pdf", width=8, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBcrfAbsSQMsSummary.pdf")
}

```

#### Difference variables

```{r, fig.width=8, fig.height=4}
# combine the annoyance perm importance results

# convert each result to a tibble with rownames added to a column, renaming the data column to 'dAnnoy' etc.
resdAnnoyMnDiffPermImpTblB <- as.data.frame(resdAnnoyMnPermImpB$DiffSQMs1/max(resdAnnoyMnPermImpB$DiffSQMs1)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdAnnoyMnDiffPermImpTblB)[2] <- "dAnnoy"

resdHiAnnoyDiffPermImpTblB <- as.data.frame(resdHiAnnoyPermImpB$DiffSQMs1/max(resdHiAnnoyPermImpB$DiffSQMs1)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdHiAnnoyDiffPermImpTblB)[2] <- "dHiAnnoy"

# merge the dataframes
resDiffPermImpTblB <- list(resdAnnoyMnDiffPermImpTblB, resdHiAnnoyDiffPermImpTblB) |>
  purrr::reduce(merge, by = c('Variable'), all = T)

# rename the columns
colnames(resDiffPermImpTblB)[2:3] <- c("Mean change in annoyance", "%HA [p(HA | 0)]")
resDiffPermImpTblB[is.na(resDiffPermImpTblB)] <- 0

resDiffB <- tidyr::pivot_longer(resDiffPermImpTblB, cols=-Variable, names_to="Outcome", values_to="Imp")

# reorder res tibble, descending by the variable Imp grouped sum and create column with new group order as a factor
resDiffB <- resDiffB |> mutate(Variable_sum = sum(Imp), .by=Variable) |> arrange(desc(Variable_sum)) |> group_by(Variable_sum, Variable) |>
   mutate(Order = cur_group_id()) |> mutate(Order = as.factor(Order)) |> arrange(desc(Order))

# Reorder outcome levels
resDiffB$Outcome <- factor(resDiffB$Outcome, levels=c("Mean change in annoyance", "%HA [p(HA | 0)]"))

# plot res as horizontal bar chart, with Imp as y axis, Variable as x axis, Outcome as fill, and Variable_sum as order, relabel x axis with Variable names
pBar <- ggplot(resDiffB) + geom_col(aes(fill=Outcome, y=Imp, x=Order), colour='grey35', linewidth=0,  width=0.75, show.legend=TRUE) + labs(x="Variable", y="Normalised variable permutation importance") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2), legend.position = "right") + coord_flip(ylim=c(-0.1, 2)) + scale_fill_manual(values=mycolours) + scale_x_discrete(labels=unique(rev(resDiffB$Variable)))
pBar

if (saveplots){
  ggsave(filename="PtBcrfDiffSQMsSummary.svg", width=8, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBcrfDiffSQMsSummary.svg")
  
  ggsave(filename="PtBcrfDiffSQMsSummary.pdf", width=8, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBcrfDiffSQMsSummary.pdf")
}

```

### No tonal loudness

#### Absolute variables

```{r, fig.width=8, fig.height=3.7}
# combine the annoyance perm importance results

# convert each result to a tibble with rownames added to a column, renaming the data column to 'dAnnoy' etc.
resdAnnoyMnAbsPermImpNoTonLdTblB <- as.data.frame(resdAnnoyMnPermImpB$AbsSQMs2/max(resdAnnoyMnPermImpB$AbsSQMs2)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdAnnoyMnAbsPermImpNoTonLdTblB)[2] <- "dAnnoy"

resdHiAnnoyAbsPermImpNoTonLdTblB <- as.data.frame(resdHiAnnoyPermImpB$AbsSQMs2/max(resdHiAnnoyPermImpB$AbsSQMs2)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdHiAnnoyAbsPermImpNoTonLdTblB)[2] <- "dHiAnnoy"

# merge the dataframes
resAbsNoTonLdPermImpNoTonLdTblB <- list(resdAnnoyMnAbsPermImpNoTonLdTblB, resdHiAnnoyAbsPermImpNoTonLdTblB) |>
  purrr::reduce(merge, by = c('Variable'), all = T)

# rename the columns
colnames(resAbsNoTonLdPermImpNoTonLdTblB)[2:3] <- c("Mean change in annoyance", "%HA [p(HA | 0)]")
resAbsNoTonLdPermImpNoTonLdTblB[is.na(resAbsNoTonLdPermImpNoTonLdTblB)] <- 0

resAbsNoTonLdB <- tidyr::pivot_longer(resAbsNoTonLdPermImpNoTonLdTblB, cols=-Variable, names_to="Outcome", values_to="Imp")

# reorder res tibble, descending by the variable Imp grouped sum and create column with new group order as a factor
resAbsNoTonLdB <- resAbsNoTonLdB |> mutate(Variable_sum = sum(Imp), .by=Variable) |> arrange(desc(Variable_sum)) |> group_by(Variable_sum, Variable) |>
   mutate(Order = cur_group_id()) |> mutate(Order = as.factor(Order)) |> arrange(desc(Order))

# Reorder outcome levels
resAbsNoTonLdB$Outcome <- factor(resAbsNoTonLdB$Outcome, levels=c("Mean change in annoyance", "%HA [p(HA | 0)]"))

# plot res as horizontal bar chart, with Imp as y axis, Variable as x axis, Outcome as fill, and Variable_sum as order, relabel x axis with Variable names
pBar <- ggplot(resAbsNoTonLdB) + geom_col(aes(fill=Outcome, y=Imp, x=Order), colour='grey35', linewidth=0,  width=0.75, show.legend=TRUE) + labs(x="Variable", y="Normalised variable permutation importance") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2), legend.position = "right") + coord_flip(ylim=c(-0.1, 2)) + scale_fill_manual(values=mycolours) + scale_x_discrete(labels=unique(rev(resAbsNoTonLdB$Variable)))
pBar

if (saveplots){
  ggsave(filename="PtBcrfAbsSQMsNoTonLdSummary.svg", width=8, height=3.7, path=file.path(outFigPath, "svg"))
  unlink("PtBcrfAbsSQMsNoTonLdSummary.svg")
  
  ggsave(filename="PtBcrfAbsSQMsNoTonLdSummary.pdf", width=8, height=3.7, path=file.path(outFigPath, "pdf"))
  unlink("PtBcrfAbsSQMsNoTonLdSummary.pdf")
}

```
#### Difference variables

```{r, fig.width=8, fig.height=4}
# combine the annoyance perm importance results

# convert each result to a tibble with rownames added to a column, renaming the data column to 'dAnnoy' etc.
resdAnnoyMnDiffPermImpNoTonLdTblB <- as.data.frame(resdAnnoyMnPermImpB$DiffSQMs2/max(resdAnnoyMnPermImpB$DiffSQMs2)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdAnnoyMnDiffPermImpNoTonLdTblB)[2] <- "dAnnoy"

resdHiAnnoyDiffPermImpNoTonLdTblB <- as.data.frame(resdHiAnnoyPermImpB$DiffSQMs2/max(resdHiAnnoyPermImpB$DiffSQMs2)) |>
  tibble::rownames_to_column(var='Variable')
colnames(resdHiAnnoyDiffPermImpNoTonLdTblB)[2] <- "dHiAnnoy"

# merge the dataframes
resDiffNoTonLdPermImpNoTonLdTblB <- list(resdAnnoyMnDiffPermImpNoTonLdTblB, resdHiAnnoyDiffPermImpNoTonLdTblB) |>
  purrr::reduce(merge, by = c('Variable'), all = T)

# rename the columns
colnames(resDiffNoTonLdPermImpNoTonLdTblB)[2:3] <- c("Mean change in annoyance", "%HA [p(HA | 0)]")
resDiffNoTonLdPermImpNoTonLdTblB[is.na(resDiffNoTonLdPermImpNoTonLdTblB)] <- 0

resDiffNoTonLdB <- tidyr::pivot_longer(resDiffNoTonLdPermImpNoTonLdTblB, cols=-Variable, names_to="Outcome", values_to="Imp")

# reorder res tibble, descending by the variable Imp grouped sum and create column with new group order as a factor
resDiffNoTonLdB <- resDiffNoTonLdB |> mutate(Variable_sum = sum(Imp), .by=Variable) |> arrange(desc(Variable_sum)) |> group_by(Variable_sum, Variable) |>
   mutate(Order = cur_group_id()) |> mutate(Order = as.factor(Order)) |> arrange(desc(Order))

# Reorder outcome levels
resDiffNoTonLdB$Outcome <- factor(resDiffNoTonLdB$Outcome, levels=c("Mean change in annoyance", "%HA [p(HA | 0)]"))

# plot res as horizontal bar chart, with Imp as y axis, Variable as x axis, Outcome as fill, and Variable_sum as order, relabel x axis with Variable names
pBar <- ggplot(resDiffNoTonLdB) + geom_col(aes(fill=Outcome, y=Imp, x=Order), colour='grey35', linewidth=0,  width=0.75, show.legend=TRUE) + labs(x="Variable", y="Normalised variable permutation importance") + theme(text = element_text(family = "serif"), panel.grid=element_line(color = rgb(235, 235, 235, 100, maxColorValue = 255), linewidth = 0.25, linetype = 2), legend.position = "right") + coord_flip(ylim=c(-0.1, 2)) + scale_fill_manual(values=mycolours) + scale_x_discrete(labels=unique(rev(resDiffNoTonLdB$Variable)))
pBar

if (saveplots){
  ggsave(filename="PtBcrfDiffSQMsNoTonLdSummary.svg", width=8, height=4, path=file.path(outFigPath, "svg"))
  unlink("PtBcrfDiffSQMsNoTonLdSummary.svg")
  
  ggsave(filename="PtBcrfDiffSQMsNoTonLdSummary.pdf", width=8, height=4, path=file.path(outFigPath, "pdf"))
  unlink("PtBcrfDiffSQMsNoTonLdSummary.pdf")
}

```

### Save the results outputs to file

```{r}
# Make a list of the summary results
resSummaryB <- list(resAbsB, resDiffB, resAbsNoTonLdB, resDiffNoTonLdB)


if (savedata){
  ii <- 0
  temp = list()
  for (res in resSummaryB){
    ii <- ii + 1
    temp[[ii]] <- data.frame(resSummaryB[ii])
  }
  openxlsx::write.xlsx(temp, paste(outDataPath, "\\ptBCRFSummary.xlsx",
                                   sep=""),
                       rowNames=TRUE)
}

```
